(()=>{var jn=Object.create,Ze=Object.defineProperty,On=Object.getPrototypeOf,zn=Object.prototype.hasOwnProperty,Nn=Object.getOwnPropertyNames,Vn=Object.getOwnPropertyDescriptor;var Qn=e=>Ze(e,"__esModule",{value:!0});var Yn=(e,t)=>()=>(t||(t={exports:{}},e(t.exports,t)),t.exports);var Jn=(e,t,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Nn(t))!zn.call(e,n)&&n!=="default"&&Ze(e,n,{get:()=>t[n],enumerable:!(r=Vn(t,n))||r.enumerable});return e},Kn=e=>Jn(Qn(Ze(e!=null?jn(On(e)):{},"default",e&&e.__esModule&&"default"in e?{get:()=>e.default,enumerable:!0}:{value:e,enumerable:!0})),e);var Lr=Yn((li,Ee)=>{var Mr=function(){var e=String.fromCharCode,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",n={};function o(s,u){if(!n[s]){n[s]={};for(var m=0;m<s.length;m++)n[s][s.charAt(m)]=m}return n[s][u]}var i={compressToBase64:function(s){if(s==null)return"";var u=i._compress(s,6,function(m){return t.charAt(m)});switch(u.length%4){default:case 0:return u;case 1:return u+"===";case 2:return u+"==";case 3:return u+"="}},decompressFromBase64:function(s){return s==null?"":s==""?null:i._decompress(s.length,32,function(u){return o(t,s.charAt(u))})},compressToUTF16:function(s){return s==null?"":i._compress(s,15,function(u){return e(u+32)})+" "},decompressFromUTF16:function(s){return s==null?"":s==""?null:i._decompress(s.length,16384,function(u){return s.charCodeAt(u)-32})},compressToUint8Array:function(s){for(var u=i.compress(s),m=new Uint8Array(u.length*2),l=0,d=u.length;l<d;l++){var w=u.charCodeAt(l);m[l*2]=w>>>8,m[l*2+1]=w%256}return m},decompressFromUint8Array:function(s){if(s==null)return i.decompress(s);for(var u=new Array(s.length/2),m=0,l=u.length;m<l;m++)u[m]=s[m*2]*256+s[m*2+1];var d=[];return u.forEach(function(w){d.push(e(w))}),i.decompress(d.join(""))},compressToEncodedURIComponent:function(s){return s==null?"":i._compress(s,6,function(u){return r.charAt(u)})},decompressFromEncodedURIComponent:function(s){return s==null?"":s==""?null:(s=s.replace(/ /g,"+"),i._decompress(s.length,32,function(u){return o(r,s.charAt(u))}))},compress:function(s){return i._compress(s,16,function(u){return e(u)})},_compress:function(s,u,m){if(s==null)return"";var l,d,w={},f={},b="",_="",y="",S=2,F=3,T=2,G=[],p=0,h=0,x;for(x=0;x<s.length;x+=1)if(b=s.charAt(x),Object.prototype.hasOwnProperty.call(w,b)||(w[b]=F++,f[b]=!0),_=y+b,Object.prototype.hasOwnProperty.call(w,_))y=_;else{if(Object.prototype.hasOwnProperty.call(f,y)){if(y.charCodeAt(0)<256){for(l=0;l<T;l++)p=p<<1,h==u-1?(h=0,G.push(m(p)),p=0):h++;for(d=y.charCodeAt(0),l=0;l<8;l++)p=p<<1|d&1,h==u-1?(h=0,G.push(m(p)),p=0):h++,d=d>>1}else{for(d=1,l=0;l<T;l++)p=p<<1|d,h==u-1?(h=0,G.push(m(p)),p=0):h++,d=0;for(d=y.charCodeAt(0),l=0;l<16;l++)p=p<<1|d&1,h==u-1?(h=0,G.push(m(p)),p=0):h++,d=d>>1}S--,S==0&&(S=Math.pow(2,T),T++),delete f[y]}else for(d=w[y],l=0;l<T;l++)p=p<<1|d&1,h==u-1?(h=0,G.push(m(p)),p=0):h++,d=d>>1;S--,S==0&&(S=Math.pow(2,T),T++),w[_]=F++,y=String(b)}if(y!==""){if(Object.prototype.hasOwnProperty.call(f,y)){if(y.charCodeAt(0)<256){for(l=0;l<T;l++)p=p<<1,h==u-1?(h=0,G.push(m(p)),p=0):h++;for(d=y.charCodeAt(0),l=0;l<8;l++)p=p<<1|d&1,h==u-1?(h=0,G.push(m(p)),p=0):h++,d=d>>1}else{for(d=1,l=0;l<T;l++)p=p<<1|d,h==u-1?(h=0,G.push(m(p)),p=0):h++,d=0;for(d=y.charCodeAt(0),l=0;l<16;l++)p=p<<1|d&1,h==u-1?(h=0,G.push(m(p)),p=0):h++,d=d>>1}S--,S==0&&(S=Math.pow(2,T),T++),delete f[y]}else for(d=w[y],l=0;l<T;l++)p=p<<1|d&1,h==u-1?(h=0,G.push(m(p)),p=0):h++,d=d>>1;S--,S==0&&(S=Math.pow(2,T),T++)}for(d=2,l=0;l<T;l++)p=p<<1|d&1,h==u-1?(h=0,G.push(m(p)),p=0):h++,d=d>>1;for(;;)if(p=p<<1,h==u-1){G.push(m(p));break}else h++;return G.join("")},decompress:function(s){return s==null?"":s==""?null:i._decompress(s.length,32768,function(u){return s.charCodeAt(u)})},_decompress:function(s,u,m){var l=[],d,w=4,f=4,b=3,_="",y=[],S,F,T,G,p,h,x,v={val:m(0),position:u,index:1};for(S=0;S<3;S+=1)l[S]=S;for(T=0,p=Math.pow(2,2),h=1;h!=p;)G=v.val&v.position,v.position>>=1,v.position==0&&(v.position=u,v.val=m(v.index++)),T|=(G>0?1:0)*h,h<<=1;switch(d=T){case 0:for(T=0,p=Math.pow(2,8),h=1;h!=p;)G=v.val&v.position,v.position>>=1,v.position==0&&(v.position=u,v.val=m(v.index++)),T|=(G>0?1:0)*h,h<<=1;x=e(T);break;case 1:for(T=0,p=Math.pow(2,16),h=1;h!=p;)G=v.val&v.position,v.position>>=1,v.position==0&&(v.position=u,v.val=m(v.index++)),T|=(G>0?1:0)*h,h<<=1;x=e(T);break;case 2:return""}for(l[3]=x,F=x,y.push(x);;){if(v.index>s)return"";for(T=0,p=Math.pow(2,b),h=1;h!=p;)G=v.val&v.position,v.position>>=1,v.position==0&&(v.position=u,v.val=m(v.index++)),T|=(G>0?1:0)*h,h<<=1;switch(x=T){case 0:for(T=0,p=Math.pow(2,8),h=1;h!=p;)G=v.val&v.position,v.position>>=1,v.position==0&&(v.position=u,v.val=m(v.index++)),T|=(G>0?1:0)*h,h<<=1;l[f++]=e(T),x=f-1,w--;break;case 1:for(T=0,p=Math.pow(2,16),h=1;h!=p;)G=v.val&v.position,v.position>>=1,v.position==0&&(v.position=u,v.val=m(v.index++)),T|=(G>0?1:0)*h,h<<=1;l[f++]=e(T),x=f-1,w--;break;case 2:return y.join("")}if(w==0&&(w=Math.pow(2,b),b++),l[x])_=l[x];else if(x===f)_=F+F.charAt(0);else return null;y.push(_),l[f++]=F+_.charAt(0),w--,F=_,w==0&&(w=Math.pow(2,b),b++)}}};return i}();typeof define=="function"&&define.amd?define(function(){return Mr}):typeof Ee!="undefined"&&Ee!=null&&(Ee.exports=Mr)});var Xe=class{constructor(t,r){this.builder=r,this.element=t,this.innerElement=t.getElementsByTagName("div")[0],this.Refresh()}Refresh(){this.innerElement.textContent="",this.builder(this)}Header(t){this.innerElement.appendChild(document.createElement("h1")).textContent=t}Lore(t){let r=this.innerElement.appendChild(document.createElement("p"));r.classList.add("Lore"),r.innerHTML=t}Separator(){this.innerElement.appendChild(document.createElement("hr"))}Information(t,r){let n=this.innerElement.appendChild(document.createElement("p"));n.classList.add("Information"),r!==void 0&&n.classList.add(r),n.innerHTML=t}InformationLeftRight(t,r,n){let o=this.innerElement.appendChild(document.createElement("div"));o.classList.add("InformationLeftRight"),n!==void 0&&o.classList.add(n);let i=o.appendChild(document.createElement("p"));i.className="Information Left",i.innerHTML=t;let s=o.appendChild(document.createElement("p"));s.className="Information Right",s.innerHTML=r}ShowOn(t,r){let n=30,o=40,i=r=="left"?0:r=="right"?1:.5,s=r=="top"?0:r=="bottom"?1:.5;this.element.classList.add("Visible");let u=t.getBoundingClientRect(),m=this.element.getBoundingClientRect(),l=u.x-m.width+(m.width+u.width)*i,d=u.y-m.height+(m.height+u.height)*s;this.element.style.left=Math.min(window.innerWidth-m.width,Math.max(0,l))+"px",this.element.style.top=Math.min(window.innerHeight-m.height-o,Math.max(n,d))+"px"}};var Dt=window.location.hostname=="localhost",jt=Dt&&!0,et=125,Ot=6e5,zt=Dt?10:1,Nt=1.15,Vt=.005,Qt=5,Yt=1.15,Jt=1.01,Kt=4.25,Zt=1.18,Xt=6,tt=.8,rt=6,er=1.1,tr=1.5,rr=1.3,nr=.02,re=7,ne=3,or=50,nt=1.3,ir=3,ar=.1,sr=.4,lr=.12,ot=.2,cr=.05,ur=.2,dr=400,mr=1.3,pr=5*60,fr=5*60,_e=2,it=1.08,hr=.75,yr=1,gr=.012,at=.2,_r=22,st=.2,br=180,lt=.2,vr=["Fair","Yellow","Green","Summer","Swift","Bridge","Wall","Oak","Lily","Liver","Stone","Elm","White"],wr=["ton","ham","brook","field","shire","meadow","port","hill","vale","bourne","river"],kr=["Thil\xFAn","F\xE9","Del\xE1n","F\xFAil","Ila","V\xE9al"],Sr=["dal","silan","duil","adris","odil","d\xF3r","dunan","sil","t\xFAan"],Cr=["R\xFB","Kom","Duna","Mor","Kh\xE2","Gama","Dr\xE2","Graz","B\xFB"],Tr=["zhur","hak","zhadum","darak","z\xE2n","nag","kor","ad\xE2hur"];var W=class{constructor(){this._listeners=[]}listen(t){this._listeners.push(t)}invoke(...t){for(let r of this._listeners)r(...t)}},R=["prestige","prestigescraps","research","mana","bones","flesh","lumber","stone","ore","metal","crystal","crystaldust","ectoplasm","tomes","soulgem"];function xr(){return j(R,0)}var D=["idle","wastelands","forest","mines","sanctum","courtyard"],Re={necromancy:{workerName:"necromancy_worker",workerUpkeep:e=>({bones:oe(e)*.1})}};var J=Kn(Lr());var Zn={brilliance:{slot:{x:0,y:0},cost:{prestige:50},income:()=>({mana:2,research:2}),storage:()=>({mana:100}),icon:"book-aura"},manaregen:{slot:{x:-1,y:1},cost:{prestige:20},multipliers:()=>({income_mana:1.25}),requires:["brilliance"],icon:"dead-eye"},betterbooks:{slot:{x:-1,y:2},cost:{prestige:40},multipliers:()=>({stacks_research:1.25,scriptorium_research:1.25}),requires:["manaregen"],icon:"bookmarklet"},drudge_mastery:{slot:{x:-3,y:1},cost:{prestige:20},multipliers:()=>({summon_skeleton_worker_cost:.5}),requires:["brilliance"],icon:"candle-skull"},morestorage:{slot:{x:-3,y:2},cost:{prestige:40},multipliers:()=>({storage_bones:1.25,storage_lumber:1.25,storage_stone:1.25,storage_ore:1.25}),requires:["drudge_mastery"],icon:"wooden-crate"},spell_queue:{slot:{x:1,y:1},cost:{prestige:15},enableFeatures:["spell_queue"],requires:["brilliance"],modifiers:()=>({spellqueue_max:8}),icon:"splashy-stream"},records:{slot:{x:3,y:1},cost:{prestige:5},requires:["brilliance"],enableFeatures:["records","feat_income"],icon:"classical-knowledge"}},$=Zn;var Xn={lumbermill:{icon:"lumbermill",location:"forest",requiresAny:{necro_lumbermill:1},cost:e=>({lumber:M(120,e)}),storage:e=>({lumber:75*e}),multipliers:e=>({basic_lumber:1+.02*e})},quarry:{icon:"quarrying",location:"mines",requiresAny:{necro_quarries:1},cost:e=>({lumber:M(60,e),stone:M(60,e)}),storage:(e,t)=>({stone:75*e,ore:L(t,0,"quarry_ores")*e,crystal:L(t,0,"quarry_crystal_storage")*e}),multipliers:e=>({basic_stone:1+.02*e})},librarystacks:{icon:"bookshelf",location:"sanctum",requiresAny:{necro_librarystacks:1},cost:e=>({lumber:M(80,e*1.5),stone:e>=10?M(150,(e-10)*1.5):0}),income:(e,t)=>({research:L(t,.2,"stacks_research")*e}),storage:(e,t)=>({tomes:L(t,0,"stacks_tomestorage")*e})},obelisk:{icon:"obelisk",location:"wastelands",requiresAny:{necro_obelisks:1},cost:e=>({stone:M(220,e),mana:M(60,e)}),income:(e,t)=>({mana:L(t,.2,"obelisk_income")*e}),storage:(e,t)=>({mana:L(t,0,"obelisk_storage")*e})},storageyard:{icon:"wooden-crate",location:"courtyard",requiresAny:{necro_centralization:1},cost:e=>({lumber:M(125,e),stone:M(75,e)}),storage:(e,t)=>({lumber:L(t,175,"storageyard_lumber")*e,stone:L(t,175,"storageyard_stone")*e,metal:L(t,0,"storageyard_metals")*e,ore:L(t,0,"storageyard_ore")*e})},metalmine:{icon:"mine",location:"mines",requiresAny:{necro_mining:1},cost:e=>({lumber:M(225,e),stone:M(150,e)}),modifiers:e=>({basic_ore:e*.1})},smelter:{icon:"smelting",location:"courtyard",requiresAny:{necro_smelting:1},cost:e=>({stone:M(575,e),metal:e>=5?M(125,(e-5)*1.25):0}),upkeep:(e,t)=>({lumber:4*e*(1+(t.modifiers.smelter_workers??0)/100*t.persistent.activeWorkers.courtyard),ore:1*e*(1+(t.modifiers.smelter_workers??0)/100*t.persistent.activeWorkers.courtyard)}),income:(e,t)=>({metal:.25*e*(1+(t.modifiers.smelter_workers??0)/100*t.persistent.activeWorkers.courtyard)})},ossuary:{icon:"crypt",location:"sanctum",requiresAny:{necro_ossuaries:1},cost:e=>({stone:M(300,e),bones:M(150,e)}),storage:(e,t)=>({bones:L(t,125,"ossuary_bones_storage")*e,ectoplasm:L(t,0,"ossuary_ectoplasm_storage")*e})},shrine:{icon:"shrine",location:"forest",requiresAny:{necro_shrines:1},cost:e=>({lumber:M(250,e),stone:M(250,e),bones:M(125,e)}),upkeep:e=>({mana:.3*e}),income:(e,t)=>({ectoplasm:L(t,.2,"shrine_income")*(1+(t.modifiers.shrine_workers??0)/100*t.persistent.activeWorkers.forest)*e})},palisade:{icon:"palisade",location:"wastelands",requiresAny:{necro_palisades:1},cost:e=>({lumber:M(600,e),stone:M(250,e)}),modifiers:e=>({fortifications:e*125})},workshop:{icon:"workshop",location:"courtyard",requiresAny:{necro_workshops:1},cost:e=>({lumber:M(900,e),stone:M(900,e),metal:M(300,e)}),modifiers:(e,t)=>({fortifications_repair:L(t,0,"workshop_repair")*e}),multipliers:e=>({deploy_material_cost:Math.floor((.5+.5*Math.pow(.98,e))*1e3)/1e3}),storage:(e,t)=>({lumber:L(t,0,"workshop_storage_lumber")*e,stone:L(t,0,"workshop_storage_stone")*e,crystal:L(t,0,"workshop_storage_crystal")*e}),recruit:(e,t)=>{let r=L(t,0,"workshop_recruit_catapult")*e;return r>0?{necro_catapult:[.01666,r]}:{}}},scriptorium:{icon:"scriptorium",location:"sanctum",requiresAny:{necro_scriptorium:1},cost:e=>({stone:M(400,e),crystal:M(275,e),ectoplasm:M(150,e)}),upkeep:e=>({ectoplasm:.3*e}),income:(e,t)=>({research:L(t,.3,"scriptorium_research")*e*(1+(t.modifiers.scriptorium_workers??0)/100*t.persistent.activeWorkers.sanctum)})},oregrinder:{icon:"oregrinder",location:"mines",requiresAny:{necro_crystalassay:1},cost:e=>({stone:M(1500,e),metal:M(850,e)}),upkeep:e=>({ore:3*e,stone:12*e}),income:(e,t)=>({crystaldust:.4*e}),storage:(e,t)=>({crystaldust:150*e})}},O=Xn;var eo={summon_skeleton_worker:{icon:"raise-skeleton",requiresAny:{necro_workers:1},cost:(e,t)=>{let r=oe(t);return{mana:M(20*(t.multipliers.summon_skeleton_worker_cost??1),r),bones:M(15,r)}},execute:(e,t)=>{ct(t,1)}},summon_skeleton_warrior:{icon:"spears",requiresAny:{necro_military:1},cost:(e,t)=>{let r=ie(t,"necro_soldier");return{mana:M(30,r),metal:M(20,r),bones:M(40,r)}},execute:(e,t)=>{be(t,"necro_soldier",1)}},summon_skeleton_archer:{icon:"archery",requiresAny:{necro_archery:1},cost:(e,t)=>{let r=ie(t,"necro_archer");return{mana:M(30,r),lumber:M(60,r),bones:M(30,r)}},execute:(e,t)=>{be(t,"necro_archer",1)}},summon_revenant:{icon:"haunting",requiresAny:{necro_revenants:1},cost:(e,t)=>{let r=ie(t,"necro_revenant");return{mana:M(150,r),ectoplasm:M(200,r),bones:M(150,r)}},execute:(e,t)=>{be(t,"necro_revenant",1)}},expanded_mind:{icon:"expanded-mind",metamagic:!0,requiresAny:{necro_expanded_mind:1},duration:(e,t)=>(t.multipliers.expanded_mind_duration??1)*300,cost:e=>({mana:Be(100,e-1),crystaldust:e<=1?0:Ae(90,e-1)}),storage:e=>({mana:125+(e-1)*25}),income:(e,t)=>({mana:L(t,0,"expanded_mind_mana_income")*(1+(e-1)*.1)})},vigormortis:{icon:"ribcage",metamagic:!0,requiresAny:{necro_vigormortis:1},duration:(e,t)=>(t.multipliers.vigormortis_duration??1)*180,cost:e=>({mana:Be(175,e-1),crystaldust:e<=1?0:Ae(190,e-1)}),modifiers:e=>({basic_stone:1+(e-1)*.5,basic_lumber:1+(e-1)*.5,basic_ore:1+(e-1)*.25})},brainstorm:{icon:"brainstorm",metamagic:!0,requiresAny:{necro_brainstorm:1},duration:()=>120,cost:e=>({mana:Be(800,e-1),crystaldust:Ae(300,e-1)}),income:e=>({research:12+(e-1)*4})},scry:{icon:"crystal-ball",requiresAny:{necro_scrying:1},checkCastable:(e,t)=>Gr(t)?"tt_spell_cantcast_inbattle":!0,cost:e=>({mana:800,crystaldust:100}),execute:(e,t)=>{for(let r=0;r<t.persistent.warTargets.length;++r)ut(t,r)}},phylactery:{icon:"phylactery",requiresAny:{necro_phylactery:1},cost:()=>({mana:800,crystal:175}),execute:(e,t)=>{Y(t,"prestige"),t.persistent.wallet.prestige+=50,Fe(t,"ui_prestigereset_phylactery",0)}},soulassumption:{icon:"embrassed-energy",requiresAny:{necro_soulassumption:1},cost:()=>({mana:4e3,crystal:1e3,crystaldust:1500,ectoplasm:1800}),execute:(e,t)=>{Fe(t,"ui_prestigereset_soulassumption",yr)}},craft_dust:{icon:"crystal-dust",requiresAny:{necro_crystaldust:1},cost:()=>({mana:25,stone:275,crystal:50}),execute:(e,t)=>{Ie(t,{crystaldust:15+20*Math.random()})}}},U=eo;var to={necro_soldier:{unitClass:"melee",deployCost:(e,t)=>({mana:3*e,bones:L(t,4,"deploy_material_cost")*e}),icon:"spears",skill:()=>8,attack:()=>6,defense:e=>L(e,2,"necro_soldier_armor"),stackSize:40},necro_revenant:{unitClass:"melee",deployCost:(e,t)=>({mana:15*e,bones:L(t,20,"deploy_material_cost")*e,ectoplasm:L(t,30,"deploy_material_cost")*e}),icon:"revenant",skill:()=>10,attack:()=>12,defense:()=>2,abilities:()=>({ethereal:1}),stackSize:40},necro_archer:{unitClass:"ranged",deployCost:(e,t)=>({mana:3*e,bones:L(t,5,"deploy_material_cost")*e}),icon:"archer",skill:()=>4,attack:e=>L(e,4,"necro_archer_attack"),defense:()=>0,stackSize:40},necro_catapult:{unitClass:"siege",recruitCost:()=>({stone:1200,lumber:600,metal:125}),deployCost:(e,t)=>({mana:1*e,bones:L(t,5,"deploy_material_cost")*e,stone:L(t,60,"deploy_material_cost")*e,lumber:L(t,30,"deploy_material_cost")*e}),icon:"catapult",skill:()=>1,attack:e=>4,defense:()=>0,abilities:()=>({siege:1}),stackSize:15},cpu_peasant:{unitClass:"melee",icon:"peasant",skill:()=>3,attack:()=>3,defense:()=>0,stackSize:100,enemyPointCost:3},cpu_infantry_human:{unitClass:"melee",icon:"human-soldier",skill:()=>8,attack:()=>8,defense:()=>2,stackSize:40,enemyPointCost:8},cpu_infantry_elven:{unitClass:"melee",icon:"elf-soldier",skill:()=>10,attack:()=>6,defense:()=>1,stackSize:40,enemyPointCost:8},cpu_infantry_dwarven:{unitClass:"melee",icon:"dwarf-soldier",skill:()=>6,attack:()=>10,defense:()=>5,stackSize:40,enemyPointCost:10},cpu_catapult:{unitClass:"siege",icon:"catapult",skill:()=>1,attack:e=>4,defense:()=>0,abilities:()=>({siege:1}),stackSize:15,enemyPointCost:20}},P=to;var ro=2,mt="progresslich-savedata";function I(e){if(typeof e=="number")return e;throw"Malformed save data"}function We(e){if(typeof e=="string")return e;throw"Malformed save data"}function no(e,t){let r=[];for(let n of t)typeof n=="object"&&n&&B(n,"spell")&&B(n,"level")&&B(n,"count")&&r.push({spell:We(n.spell),level:I(n.level),count:I(n.count)});return r}function oo(e,t){if(typeof t=="object"&&t&&B(t,"level")&&B(t,"duration")&&B(t,"durationLeft"))return{level:I(t.level),duration:I(t.duration),durationLeft:I(t.durationLeft)};throw"Malformed save data"}function ve(e,t){if(typeof t=="object"&&t){let r={};for(let n of Object.keys(P))if(B(t,n)){let o=I(t[n]);o>0&&(r[n]=o)}return r}throw"Malformed save data"}function Rr(e,t){if(Array.isArray(t)){let r=new Array(t.length);for(let n=0;n<t.length;++n){let o=t[n];if(!o)r[n]=null;else if(typeof o=="object"&&o&&B(o,"unit")&&B(o,"count")&&B(o,"casualties"))P[o.unit]!==void 0?r[n]={unit:We(o.unit),count:I(o.count),casualties:I(o.casualties)}:r[n]=null;else throw"Malformed save data"}return r}throw"Malformed save data"}function Er(e,t){if(typeof t=="object"&&t&&B(t,"startingArmy")&&B(t,"reserves")&&B(t,"fortifications")&&B(t,"fortificationsMax")&&B(t,"frontRank")&&B(t,"backRank"))return{startingArmy:ve(e,t.startingArmy),reserves:ve(e,t.startingArmy),fortifications:I(t.fortifications),fortificationsMax:I(t.fortificationsMax),frontRank:Rr(e,t.frontRank),backRank:Rr(e,t.backRank)};throw"Malformed save data"}function io(e,t){if(typeof t=="object"&&t&&B(t,"timer")&&B(t,"player")&&B(t,"enemy")){let r={timer:I(t.timer),player:Er(e,t.player),enemy:Er(e,t.enemy)};return B(t,"warTargetIndex")&&typeof t.warTargetIndex=="number"&&(r.warTargetIndex=t.warTargetIndex),r}throw"Malformed save data"}function ao(e,t){if(typeof t=="object"&&t&&B(t,"seed")&&B(t,"wave")&&B(t,"army")&&B(t,"countdown"))return{seed:I(t.seed),wave:I(t.wave),countdown:I(t.countdown),army:ve(e,t.army)};throw"Malformed save data"}function Ir(e){if(e===null)return null;try{if(typeof e.version!="number"||typeof e.data!="object")throw"Malformed save data";let t=e.version,r=Pe();r.seed=I(e.data.seed),r.culture=We(e.data.culture);for(let n of R)e.data.wallet[n]!==void 0&&(r.wallet[n]=I(e.data.wallet[n]));for(let[n,o]of Object.entries(A))e.data.techLevels[n]!==void 0&&(r.techLevels[n]=Math.max(0,I(e.data.techLevels[n])),o.maxLevel!==void 0&&(r.techLevels[n]=Math.min(r.techLevels[n],o.maxLevel))),e.data.techProgress[n]!==void 0&&(o.maxLevel!==void 0&&r.techLevels[n]>=o.maxLevel?r.techProgress[n]=0:r.techProgress[n]=Math.max(0,I(e.data.techProgress[n])));if(e.data.techTarget!==void 0){let n=We(e.data.techTarget);A[n]!==void 0&&(r.techTarget=n)}for(let n of D)r.activeWorkers[n]=I(e.data.activeWorkers?.[n]??0),r.assignedWorkers[n]=I(e.data.assignedWorkers?.[n]??0);for(let n of Object.keys(O))r.buildingLevels[n]=I(e.data.buildingLevels?.[n]??0),r.disabledBuildings[n]=I(e.data.disabledBuildings?.[n]??0);if(e.data.activeSpellEffects)for(let[n,o]of Object.entries(e.data.activeSpellEffects))r.activeSpellEffects[n]=oo(t,o);for(let n of Object.keys(e.data.feats))r.feats[n]=!0;for(let n of Object.keys($))(e.data.prestige?.[n]??!1)&&(r.prestige[n]=!0);for(let n of Object.keys(U))r.metamagicLevel[n]=I(e.data.metamagicLevel?.[n]??0);Array.isArray(e.data.spellQueue)&&(r.spellQueue=no(t,e.data.spellQueue));for(let[n,o]of Object.entries(e.data.events))(typeof o=="string"||typeof o=="boolean"||typeof o=="number")&&(r.events[n]=o);if(r.military=ve(t,e.data.military),typeof e.data.militaryDeployment=="object"&&e.data.militaryDeployment)for(let n of Object.keys(P)){let o=e.data.militaryDeployment[n];o&&(r.militaryDeployment[n]=I(o))}if(e.data.militaryRecruitProgress&&(r.militaryRecruitProgress=ve(t,e.data.militaryRecruitProgress)),e.data.militaryRecruitDisabled&&typeof e.data.militaryRecruitDisabled=="object")for(let n of Object.keys(P))e.data.militaryRecruitDisabled[n]===!0&&(r.militaryRecruitDisabled[n]=!0);if(typeof e.data.battle=="object"&&(r.battle=io(t,e.data.battle)),typeof e.data.invaders=="object"&&(r.invaders=ao(t,e.data.invaders)),r.invaderAnger=Math.max(0,I(e.data.invaderAnger??0)),r.invaderWave=Math.max(0,I(e.data.invaderWave??0)),Array.isArray(e.data.warTargets)){for(let n=0;n<ne;++n)if(n<e.data.warTargets.length){let o=e.data.warTargets[n];if(typeof o=="object"&&o&&B(o,"seed")&&B(o,"level"))r.warTargets[n]={seed:I(o.seed),level:I(o.level)};else throw"Malformed save data"}}return r.warTargetVictories=I(e.data.warTargetVictories??0),r.fortDamage=I(e.data.fortDamage??0),r}catch(t){return console.error(`Error deserializing save: ${t}`),null}}function Ar(e){return{version:ro,data:e}}function so(e){if(e.length>0&&e[0]==="$"){let t=J.decompressFromUTF16(e.substr(1));return t?JSON.parse(t):null}else try{return JSON.parse(atob(e))}catch(t){return console.error(`Failed to decompress stored data beginning with "${e.substr(0,8)}": ${t}`),null}}function lo(e){if(e.length>0&&e[0]==="$"){let t=J.decompressFromBase64(e.substr(1));return t?JSON.parse(t):null}else try{return JSON.parse(atob(e))}catch(t){return console.error(`Failed to decompress export data beginning with "${e.substr(0,8)}": ${t}`),null}}function co(e){return"$"+J.compressToUTF16(JSON.stringify(e))}function uo(e){return"$"+J.compressToBase64(JSON.stringify(e))}function Br(){let e=localStorage.getItem(mt);if(e!==null){let t=Ir(so(e));if(t!==null)return t}return Pe()}function Fr(e){return Ir(lo(e))}function Pr(e){return uo(Ar(e))}function qe(e){dt(!0),localStorage.setItem(mt,co(Ar(e))),dt(!1)}function Wr(){localStorage.removeItem(mt)}var mo=["prestige","militaryvictory","killedinbattle","tech100","tech500","victories50","victories250"],He=mo;var we=!1,ht=!1;function M(e,t){return Math.floor(e*Math.pow(Nt,t))}function Ae(e,t){return Math.floor(e*Math.pow(rr,t))}function Be(e,t){return Math.floor(e*Math.pow(tr,t))}function ke(e){return e!="research"}function le(e){return e!="prestige"&&e!="prestigescraps"}function yt(e){return e!="prestige"&&e!="prestigescraps"}function $r(e,t){return t=="research"||e.walletStorage[t]>0||t=="prestige"&&V(e)||t=="prestigescraps"&&e.persistent.feats.militaryvictory===!0}function po(e,t){for(let r of R)e[r]=(e[r]??0)+(t[r]??0)}function Ur(e,t){for(let r of R)e[r]&&(e[r]=(e[r]??0)*t)}function Dr(e){for(let t of R)if((e[t]??0)!==0)return!1;return!0}function Se(e,t){let r=A[e],n=Qt*Math.pow(Kt,r.tier-1)*Math.pow(Zt,r.slot.y);return r.maxLevel===1?n*=Xt:n=n*Math.pow(Yt,t),r.slot.y<rt&&(n*=1-tt+tt*r.slot.y/rt),n=ft(n),n}function gt(e,t,r){let n=A[t];if(n.currencyCost!==void 0){let o=Se(t,r),i=n.currencyCost(r,e);for(let s of R){let u=i[s];u!==void 0&&(i[s]=ft(u*o*Math.pow(Jt,r-1)))}return i}}function V(e){return e.persistent.feats.prestige}function L(e,t,...r){for(let n of r)t+=e.modifiers[n]??0;for(let n of r)t*=e.multipliers[n]??1;return t}function _t(e){return L(e,0,"fortifications_repair")}function jr(e){let t=Fr(e);t!==null?(qe(t),we=!0,location.reload()):console.error("Failed to load game from string")}function Pe(){let e={seed:Math.floor(Math.random()*2147483647),culture:"necromancy",wallet:xr(),techLevels:j(Object.keys(A),0),techProgress:{},activeWorkers:j(D,0),assignedWorkers:j(D,0),buildingLevels:j(Object.keys(O),0),disabledBuildings:{},activeSpellEffects:{},spellQueue:[],feats:{},prestige:{},metamagicLevel:{},events:{},military:{},militaryRecruitDisabled:{},militaryRecruitProgress:{},militaryDeployment:{},invaderAnger:0,invaderWave:0,warTargets:[],warTargetVictories:0,fortDamage:0};return fo(e),e}function Fe(e,t,r){we=!0,ht=!0,e.persistent.wallet.prestige+=Math.ceil(e.persistent.wallet.prestigescraps*r),e.events.prestigeResetTriggered.invoke(t)}function Or(e){ht&&bt(e)}function bt(e){let t=Pe();t.feats={...e.persistent.feats},t.prestige={...e.persistent.prestige},t.wallet.prestige=e.persistent.wallet.prestige,t.events=e.persistent.events,qe(t),we=!0,location.reload()}function zr(){Wr(),we=!0,location.reload()}function fo(e){let t=new N(e.seed);for(let r=e.warTargets.length;r<ne;++r)e.warTargets.push({level:0,seed:t.int(2147483647)})}function yo(e){return{persistent:e,gameSpeed:zt,walletStorage:j(R,0),income:{},modifiers:{},multipliers:{},recruitment:{},enabledFeatures:{},hiddenTech:{},techTargetChoked:!1,warTargets:ho(e),retreatRequested:!1,events:{ticked:new W,battleBegan:new W,battleEnded:new W,buildingCountChanged:new W,standingArmyChanged:new W,techLevelsChanged:new W,techTargetChanged:new W,spellCast:new W,spellExpired:new W,spellQueueChanged:new W,invasionBegan:new W,prestigeResetTriggered:new W,prestigeUpgradesChanged:new W,workersChanged:new W,storyEventTriggered:new W,featAchieved:new W,warTargetsChanged:new W}}}function K(e,t,r){let n=P[t];if(n!==void 0&&n.enemyPointCost!==void 0){let o=Math.floor(Math.floor(r)/n.enemyPointCost);if(o>0)return e[t]=(e[t]??0)+o,o*n.enemyPointCost}return 0}function go(e,t,r){let n=new N(r),o={},i=Math.floor(dr*n.float(.9,1.1)*Math.pow(mr,e));if(e>=3){let s=i*(.1+(e-3)/6*.2);i-=K(o,"cpu_catapult",s)}return i-=K(o,"cpu_infantry_elven",i*n.float(.2,.4)),i-=K(o,"cpu_infantry_dwarven",i*n.float(.2,.4)),K(o,"cpu_infantry_human",i),o}function _o(e,t,r){let n=new N(r),o={},i=Math.floor(or*n.float(.9,1.1)*Math.pow(nt,t));if(t>=2){let s=i*.6*Math.min(1,(t-2)/7);switch(e){default:case"human":i-=K(o,"cpu_infantry_human",s);break;case"elven":i-=K(o,"cpu_infantry_elven",s);break;case"dwarven":i-=K(o,"cpu_infantry_dwarven",s);break}}return K(o,"cpu_peasant",i),o}function bo(e,t){let r={},n=new N(t.seed);switch(r.bones=.8,t.culture){default:case"human":r.lumber=.5,r.stone=.5,e.enabledFeatures.spoils_ore&&(r.ore=.15),e.enabledFeatures.spoils_tomes&&(r.tomes=.04);break;case"elven":r.lumber=.7,r.stone=.3,e.enabledFeatures.spoils_tomes&&(r.tomes=.055);break;case"dwarven":r.lumber=.1,r.stone=.7,e.enabledFeatures.spoils_ore&&(r.ore=.5),e.enabledFeatures.spoils_tomes&&(r.tomes=.04);break}t.features.lumbermill&&(r.lumber*=_e),t.features.quarry&&(r.stone*=_e),t.features.mine&&(r.ore=(r.ore??0)*_e),t.features.library&&(r.tomes=(r.tomes??0)*_e);for(let o of R){let i=r[o];i!==void 0&&(r[o]=Math.floor(n.float(.9,1.1)*t.population*i*(e.multipliers[`spoils_${o}`]??1)))}return r.prestigescraps=t.population*gr*n.float(1-at,1+at),r}function vt(e,t){return e[e.length-1]==t[0]?e.substr(0,e.length-1)+t:e+t}function Nr(e,t){let r=new N(t),n=Math.floor((.75+r.float(.5))*100*Math.pow(nt,e)),o,i;switch(r.int(3)){default:case 0:o="human",i=vt(r.pick(vr),r.pick(wr));break;case 1:o="elven",i=vt(r.pick(kr),r.pick(Sr));break;case 2:o="dwarven",i=vt(r.pick(Cr),r.pick(Tr));break}let s=_o(o,e,t),u={},m=["lumbermill","mine","quarry","library"];return e>=3&&r.chance((e-3)*.08)&&(u.walls=!0,m.length>0&&e>=3&&r.chance(Math.min(.75,.25+(e-3)*.05))&&(u[r.pick_remove(m)]=!0)),m.length>0&&e>=3&&r.chance(Math.min(.75,.25+(e-3)*.05))&&(u[r.pick_remove(m)]=!0),{seed:t,culture:o,name:i,population:n,defenders:s,features:u}}function Vr(e,t){switch(t){case"mine":return e.enabledFeatures.spoils_ore===!0;case"library":return e.enabledFeatures.spoils_tomes===!0;default:return!0}}function ut(e,t){let r=e.persistent.warTargets[t];r.seed=Math.floor(new N(r.seed).int(2147483647)),e.warTargets[t]=Nr(r.level,r.seed),e.events.warTargetsChanged.invoke()}function ho(e){let t=[];for(let r of e.warTargets)t.push(Nr(r.level,r.seed));return t}function vo(e){let t=e.persistent.invaderWave,r=e.persistent.invaders?.seed??Math.floor(Math.random()*2147483647);e.persistent.invaders={army:go(t,e.persistent.warTargetVictories,r),wave:t,seed:Math.floor(new N(r).float(2147483647)),countdown:t==0?fr:pr},e.events.invasionBegan.invoke()}function wt(e){return Math.max(0,e.persistent.invaderAnger-ot)/(1-ot)}function Qr(e,t){e.persistent.invaders||(Math.random()<wt(e)?(e.persistent.invaderAnger=0,vo(e)):e.persistent.invaderAnger=Math.min(1,e.persistent.invaderAnger+t*(.5+Math.random()*.5)))}function Yr(e,t){for(let r=0;r<t.length;++r){let n=t[r];if(n){let o=Math.min(e[n.unit]??0,P[n.unit].stackSize-n.count);n.count+=o,e[n.unit]=(e[n.unit]??0)-o}}}function Jr(e){for(let t=0;t<e.length;++t){let r=e[t];r&&r.count==0&&(e[t]=null)}}function Kr(e){let t=Math.floor(e.length/2),r=t;for(let n=t;n>=0;--n)e[n]!==null&&(n!==r&&(e[r]=e[n],e[n]=null),r--);r=t;for(let n=t;n<e.length;++n)e[n]!==null&&(n!==r&&(e[r]=e[n],e[n]=null),r++)}function wo(e,t){let r=Math.floor(e.length/2);for(let n=r;n>=0&&n<e.length;n+=t)if(e[n]===null)return n}function ko(e,t,r,n,o){let i=wo(t,n);if(i!==void 0&&i>=o&&i<t.length-o){let s=P[r],u=Math.min(e.reserves[r],s.stackSize);if(u>0)return t[i]={unit:r,count:u,casualties:0},e.reserves[r]-=u,u}return 0}function Ce(e,t,r,n){let o=1;for(let i of Object.keys(e.reserves))if(P[i].unitClass==r)for(;e.reserves[i]>0;){let u=ko(e,t,i,o,n);if(o=o==1?-1:1,u==0&&u==0)break}}function ce(e){Yr(e.reserves,e.frontRank),Yr(e.reserves,e.backRank),Jr(e.frontRank),Jr(e.backRank),Kr(e.frontRank),Kr(e.backRank),Ce(e,e.frontRank,"melee",1),Ce(e,e.frontRank,"cavalry",0),Ce(e,e.frontRank,"melee",0),Ce(e,e.backRank,"ranged",0),Ce(e,e.backRank,"siege",0);for(let t=0;t<e.frontRank.length;++t)e.frontRank[t]===null&&e.backRank[t]!==null&&(e.frontRank[t]=e.backRank[t],e.backRank[t]=null)}function $e(e,t){let r={reserves:{...e},startingArmy:{...e},fortifications:0,fortificationsMax:0,frontRank:new Array(t),backRank:new Array(t)};return r.frontRank.fill(null),r.backRank.fill(null),r}function kt(e,t){if(e.persistent.invaders)return"invaded";if(e.persistent.battle)return"inbattle";let r=!1;for(let[n,o]of Object.entries(e.persistent.militaryDeployment))if(o!==void 0&&Math.min(o,e.persistent.military[n]??0)>0){r=!0;break}return r?De(e,Ue(e))?!0:"cantafford":"noarmy"}function Ue(e){let t={};for(let[r,n]of Object.entries(e.persistent.militaryDeployment))if(n!==void 0&&n>0){let o=P[r].deployCost;if(o!==void 0){let i=Math.min(n,e.persistent.military[r]??0);po(t,o(i,e))}}return t}function Zr(e,t){let r=e.persistent.warTargets[t],n=e.warTargets[t];if(kt(e,n)!==!0)return;ae(e,Ue(e));let o={};for(let[s,u]of Object.entries(e.persistent.militaryDeployment))if(u!==void 0){let m=Math.min(u,e.persistent.military[s]??0);m>0&&(e.persistent.military[s]-=m,o[s]=m)}let i={timer:0,warTargetIndex:t,player:$e(o,re),enemy:$e(n.defenders,re)};n.features.walls&&(i.enemy.fortificationsMax=100+r.level*75,i.enemy.fortifications=i.enemy.fortificationsMax),ce(i.player),ce(i.enemy),e.persistent.battle=i,e.retreatRequested=!1,e.events.battleBegan.invoke()}function So(e){if(e.persistent.invaders!==void 0){let t={timer:0,player:$e(e.persistent.military,re),enemy:$e(e.persistent.invaders.army,re)};e.persistent.military={},t.player.fortificationsMax=e.modifiers.fortifications,t.player.fortifications=e.modifiers.fortifications-e.persistent.fortDamage,ce(t.player),ce(t.enemy),e.persistent.battle=t,e.retreatRequested=!1,e.events.battleBegan.invoke()}}function je(e){return e.persistent.battle!==void 0&&e.persistent.battle.warTargetIndex===void 0}function Gr(e){return e.persistent.battle!==void 0}function Xr(e,t){let r={};for(let[n,o]of Object.entries(t.reserves))r[n]=(r[n]??0)+o;for(let n of t.frontRank)n!==null&&(r[n.unit]=(r[n.unit]??0)+n.count);for(let n of t.backRank)n!==null&&(r[n.unit]=(r[n.unit]??0)+n.count);return r}function tn(e){e.persistent.battle!==void 0&&e.persistent.battle.warTargetIndex!==void 0&&(e.retreatRequested=!0,en(e,e.persistent.battle))}function Co(e){if(e.persistent.battle!==void 0){let t=Xr(e,e.persistent.battle.player);for(let[r,n]of Object.entries(t))e.persistent.military[r]=(e.persistent.military[r]??0)+n;e.persistent.battle=void 0}}function rn(e,t,r){let n=P[t],o=n.unitClass=="ranged"||n.unitClass=="cavalry"?2:1;for(let i=0;i<=o;++i){if(e-i>=0&&r[e-i]!==null)return e-i;if(e+i<r.length&&r[e+i]!==null)return e+i}}function nn(e,t,r,n){if(t&&r){let o=P[t.unit],i=P[r.unit],s=o.abilities?o.abilities(e):{},u=i.abilities?i.abilities(e):{},m=n.fortificationsMax==0?0:Math.pow(n.fortifications/n.fortificationsMax,sr);if(Math.random()<=m){let b=o.attack(e);if(b>0){let _=(.5+Math.random())*b*t.count*lr;s.siege&&(_*=ir),n.fortifications=Math.max(0,n.fortifications-_)}return}let l=o.skill(e),d=i.skill(e);u.ethereal!==void 0&&(l*=.25);let w=1+Math.random()*l,f=1+Math.random()*d;if(w>=f){let b=o.attack(e);if(b>0){let _=i.defense(e);s.ethereal!==void 0&&(_*=.75);let y=(.5+Math.random())*b/(b+_)*t.count*ar,S=Math.floor(y)+(Math.random()<y%1?1:0);r.casualties+=S}}}}function on(e,t,r,n){t.attackDirection=void 0;let o=rn(r,t.unit,n.frontRank);if(o!==void 0){let i=n.frontRank[o];i&&(nn(e,t,i,n),t.attackDirection=o-r)}else{let i=rn(r,t.unit,n.backRank);if(i!==void 0){let s=n.backRank[i];s&&(nn(e,t,s,n),t.attackDirection=i-r)}}}function an(e,t,r){let n=t.frontRank.length;for(let o=0;o<n;++o){let i=t.frontRank[o],s=t.backRank[o];i!==null&&on(e,i,o,r),s!==null&&on(e,s,o,r)}}function sn(e,t){for(let r=0;r<t.frontRank.length;++r){let n=t.frontRank[r];n&&(n.count=Math.max(0,n.count-n.casualties));let o=t.backRank[r];o&&(o.count=Math.max(0,o.count-o.casualties))}}function Oe(e,t){for(let r=0;r<t.length;++r){let n=t[r];n&&(n.casualties=0)}}function ln(e,t){let r=0;for(let n=0;n<t.frontRank.length;++n){let o=t.frontRank[n],i=t.backRank[n];o&&(r+=o.count),i&&(r+=i.count)}return r}function en(e,t){let r=t.warTargetIndex===void 0,n=ln(e,t.enemy)==0,o=!n&&(e.retreatRequested||ln(e,t.player)==0),i=r?void 0:e.warTargets[t.warTargetIndex??0];if(n||o){let s=Xr(e,t.player),u={...t.player.startingArmy};for(let[m,l]of Object.entries(s)){let d=u[m];d!==void 0&&(d<=l?delete u[m]:u[m]=d-l)}if(Co(e),o)e.events.battleEnded.invoke(!1,i,u,{}),r?(Y(e,"killedinbattle"),Fe(e,"ui_prestigereset_invasion",hr)):Qr(e,cr);else if(n){let m={};if(t.warTargetIndex!==void 0&&i!==void 0)m=bo(e,i),Ie(e,m),t.warTargetIndex!==void 0&&(e.persistent.warTargets[t.warTargetIndex].level++,ut(e,t.warTargetIndex));else if(r&&e.persistent.invaders!==void 0){let l=new N(e.persistent.invaders.seed);m.bones=(e.persistent.invaders.wave+1)*br*l.float(1-lt,1+lt),m.prestigescraps=(e.persistent.invaders.wave+1)*_r*l.float(1-st,1+st),Ie(e,m)}e.persistent.feats.militaryvictory!==!0&&(Y(e,"militaryvictory"),Te(e,"firstmilitaryvictory")),e.persistent.warTargetVictories++,e.persistent.warTargetVictories>=50&&Y(e,"victories50"),e.persistent.warTargetVictories>=250&&Y(e,"victories250"),r?(e.persistent.invaders=void 0,e.persistent.invaderWave++):Qr(e,ur),e.events.battleEnded.invoke(!0,i,u,m)}return!0}return!1}function To(e,t,r){for(t.timer+=r;t.timer>=1||e.retreatRequested;){t.timer-=1;let n=t.warTargetIndex==null;if(Oe(e,t.player.backRank),Oe(e,t.player.frontRank),Oe(e,t.enemy.frontRank),Oe(e,t.enemy.backRank),an(e,t.player,t.enemy),an(e,t.enemy,t.player),sn(e,t.player),sn(e,t.enemy),ce(t.player),ce(t.enemy),n&&(e.persistent.fortDamage=Math.max(e.persistent.fortDamage,t.player.fortificationsMax-t.player.fortifications)),en(e,t))break}}function St(e){e.enabledFeatures={};for(let[t,r]of Object.entries(e.persistent.techLevels)){let n=A?.[t]?.enableFeatures;if(r>0&&n!==void 0)for(let o of n)e.enabledFeatures[o]=!0}for(let[t,r]of Object.entries(e.persistent.prestige)){let n=$?.[t]?.enableFeatures;if(r===!0&&n!==void 0)for(let o of n)e.enabledFeatures[o]=!0}}function xo(){let e={};for(let t of Object.keys(A))e[t]=[];for(let[t,r]of Object.entries(A))if(r.requires!==void 0)for(let n of Object.keys(r.requires))e[n].push(t);return e}function cn(e){e.hiddenTech={};let t=xo(),r=n=>{let o=[n];for(let i=0;i<o.length;++i)e.hiddenTech[o[i]]!==!0&&(e.hiddenTech[o[i]]=!0,o.push(...t[o[i]]))};for(let n of Object.keys(t)){let o=A[n];if(e.hiddenTech[n]!==!0){if(o.hidden!==void 0&&o.hidden(e)){r(n);continue}if(!jt&&o.requires!==void 0){let i=!1;for(let[s]of Object.entries(o.requires))if(e.persistent.techLevels[s]>0){i=!0;break}if(!i){r(n);continue}}}}}function Ct(e,t){if(t!==void 0){if(e.hiddenTech[t]===!0)return!1;let r=A[t].maxLevel;if(r!==void 0&&e.persistent.techLevels[t]>=r)return!1;let n=A[t].requires;if(n!==void 0){for(let[s,u]of Object.entries(n))if(e.persistent.techLevels[s]<u)return!1}let o=A[t].requiresVictories;if(o!==void 0&&e.persistent.warTargetVictories<o(e.persistent.techLevels[t]+1,e))return!1;let i=A[t].specialRequires;if(i!==void 0&&!i(e.persistent.techLevels[t]+1,e))return!1}return!0}function ae(e,t,r){r=r??1;for(let n of R){let o=t[n];if(o!==void 0&&e.persistent.wallet[n]<o*r)return!1}for(let n of R){let o=t[n];o!==void 0&&(e.persistent.wallet[n]-=o*r)}return!0}function Ie(e,t,r){r=r??1;for(let n of R){let o=t[n];o!==void 0&&(e.persistent.wallet[n]+=o*r),le(n)&&(ke(n)?e.persistent.wallet[n]=Math.min(e.persistent.wallet[n],e.walletStorage[n]):e.persistent.wallet[n]=0)}}function De(e,t){for(let r of R){let n=t[r];if(n!==void 0&&e.persistent.wallet[r]<n)return!1}return!0}function Tt(e,t){if(Ct(e,t)){let r=e.persistent.techTarget;e.persistent.techTarget=t,e.techTargetChoked=!1,e.events.techTargetChanged.invoke()}}function un(e,t){e.persistent.prestige[t]!==!0&&ae(e,$[t].cost)&&(e.persistent.prestige[t]=!0,St(e),e.events.prestigeUpgradesChanged.invoke())}function dn(e,t){let r=$[t];if(e.persistent.prestige[t]===!0||!De(e,$[t].cost))return!1;if(r.requires!==void 0){for(let n of r.requires)if(e.persistent.prestige[n]!==!0)return!1}return!0}function xt(e,t){let r=U[t];for(let[n,o]of Object.entries(r.requiresAny))if(e.persistent.techLevels[n]>=o)return!0;return!1}function xe(e,t){let r=U[t],n=1+(e.persistent.metamagicLevel[t]??0);if(r.checkCastable!==void 0&&r.checkCastable(n,e)!==!0)return!1;let o=ze(e,t,n);for(let i of R){let s=o[i];if(s!==void 0&&e.persistent.wallet[i]<s)return!1}return xt(e,t)}function Mo(e){let t=0;for(let r of e.persistent.spellQueue)t+=r.count;return t}function ze(e,t,r){let n=U[t],o=n.cost(r,e);if(n.duration!==void 0&&e.persistent.activeSpellEffects[t]!==void 0&&e.persistent.activeSpellEffects[t].level==r){let i=n.duration(r,e),s=e.persistent.activeSpellEffects[t]?.durationLeft??0,u=Math.pow(er,Math.ceil(s/i));for(let[m,l]of Object.entries(o))o[m]=l*u}for(let[i,s]of Object.entries(o))o[i]=Math.ceil(s);return o}function Mt(e,t,r){t>=0&&t<e.persistent.spellQueue.length&&(!r&&e.persistent.spellQueue[t].count>1?e.persistent.spellQueue[t].count--:e.persistent.spellQueue.splice(t,1)),e.events.spellQueueChanged.invoke()}function mn(e,t){if(e.enabledFeatures.spell_queue!==!0)return;let r=e.modifiers.spellqueue_max??0;if(Mo(e)>=r)return;let n=1+(e.persistent.metamagicLevel[t]??0),o=e.persistent.spellQueue.length>0?e.persistent.spellQueue[e.persistent.spellQueue.length-1]:void 0;o&&o.spell==t&&o.level==n?o.count++:e.persistent.spellQueue.push({spell:t,level:n,count:1}),e.events.spellQueueChanged.invoke()}function Lt(e,t){if(!xe(e,t))return;let r=U[t],n=1+(e.persistent.metamagicLevel[t]??0),o=e.persistent.activeSpellEffects;if(ae(e,ze(e,t,n))){if(r.execute!==void 0&&r.execute(n,e),r.duration!==void 0){let i=r.duration(n,e);o[t]!==void 0&&o[t].level==n?(o[t].durationLeft+=i,o[t].duration=o[t].durationLeft):o[t]={duration:i,durationLeft:i,level:n}}e.events.spellCast.invoke(t)}}function Me(e,t){let r=O[t];for(let[n,o]of Object.entries(r.requiresAny))if(e.persistent.techLevels[n]>=o)return!0;return!1}function pn(e,t){let r=O[t].cost(e.persistent.buildingLevels[t],e);return Me(e,t)&&De(e,r)}function fn(e,t){let r=O[t].cost(e.persistent.buildingLevels[t],e);Me(e,t)&&De(e,r)&&ae(e,r)&&(e.persistent.buildingLevels[t]++,e.events.buildingCountChanged.invoke())}function oe(e){let t=0;for(let r of D)t+=e.persistent.activeWorkers[r];return t}function Gt(e,t,r){e.persistent.assignedWorkers[t]=Math.max(0,e.persistent.assignedWorkers[t]+r),hn(e)}function Rt(e,t,r){e.persistent.disabledBuildings[t]=Math.max(0,Math.min(e.persistent.buildingLevels[t]??0,(e.persistent.disabledBuildings[t]??0)-r)),e.events.buildingCountChanged.invoke()}function hn(e){let t=!1;for(let r of D)if(r!=="idle"){let n=e.persistent.activeWorkers[r]-e.persistent.assignedWorkers[r];n>0&&(e.persistent.activeWorkers.idle+=n,e.persistent.activeWorkers[r]-=n)}for(let r of D){if(e.persistent.activeWorkers.idle==0)break;let n=e.persistent.assignedWorkers[r]-e.persistent.activeWorkers[r];if(n>0){let o=Math.min(n,e.persistent.activeWorkers.idle);e.persistent.activeWorkers.idle-=o,e.persistent.activeWorkers[r]+=o}}e.events.workersChanged.invoke()}function ct(e,t){if(t>0)e.persistent.activeWorkers.idle=Math.max(0,e.persistent.activeWorkers.idle+t),hn(e);else if(t<0){t=-t;let r=Math.min(e.persistent.activeWorkers.idle,t);e.persistent.activeWorkers.idle-=r,t-=r;for(let n of D){if(t<=0)break;let o=Math.min(e.persistent.activeWorkers[n],t);e.persistent.activeWorkers[n]-=o,t-=o}e.events.workersChanged.invoke()}}function ie(e,t){let r=e.persistent.military[t]??0,n=e.persistent.battle;if(n!==void 0){r+=n.player.reserves[t]??0;for(let o of n.player.frontRank)o!==null&&o.unit==t&&(r+=o.count);for(let o of n.player.backRank)o!==null&&o.unit==t&&(r+=o.count)}return r}function be(e,t,r){e.persistent.battle!==void 0&&je(e)?e.persistent.battle.player.reserves[t]=(e.persistent.battle.player.reserves[t]??0)+r:e.persistent.military[t]=Math.max(0,(e.persistent.military[t]??0)+r),e.events.standingArmyChanged.invoke()}function ue(e,t){let r=e.recruitment[t];return r!==void 0&&r.max>0}function Le(e,t){return ue(e,t)&&e.persistent.militaryRecruitDisabled[t]!==!0}function yn(e,t,r){ue(e,t)&&(r?delete e.persistent.militaryRecruitDisabled[t]:e.persistent.militaryRecruitDisabled[t]=!0,e.events.standingArmyChanged.invoke())}function Et(e,t){return Math.pow(it,ie(e,t))}function gn(e,t){let r=e.recruitment[t]?.rate??0;if(r>0)return Et(e,t)/r}function _n(e,t){return e.recruitment[t]?.max??0}function Lo(e,t){for(let[r,n]of Object.entries(e.recruitment))if(n!==void 0&&n.rate>0&&ie(e,r)<n.max&&Le(e,r)){let o=n.rate*t/1e3,i=P[r].recruitCost;i&&(ae(e,i(e),o)||(o=0));let s=(e.persistent.militaryRecruitProgress[r]??0)+o,u=0;for(;;){let m=ie(e,r)+u;if(m>=n.max){s=0;break}let l=Math.pow(it,m);if(s>=l)s-=l,++u;else break}e.persistent.militaryRecruitProgress[r]=s,u>0&&be(e,r,u)}}function Ro(e,t){let r=t/1e3,n=Re[e.persistent.culture];e.walletStorage=j(R,0),e.income={},e.recruitment={};let o=1;if(e.enabledFeatures.feat_income)for(let f of He)e.persistent.feats[f]!==void 0&&(o+=Vt);let i={},s={},u={...e.persistent.wallet};e.persistent.wallet.research+=r;let m=[],l=[];for(let[f,b]of Object.entries(e.persistent.techLevels))b>0&&m.push([A[f],b]);for(let[f,b]of Object.entries(e.persistent.buildingLevels)){let _=e.persistent.disabledBuildings[f]??0;b>0&&b>_&&m.push([O[f],b-_]),b>0&&_>0&&l.push([O[f],Math.min(_,b)])}for(let[f,b]of Object.entries(e.persistent.activeSpellEffects))b.durationLeft>0&&m.push([U[f],b.level]);for(let[f,b]of Object.entries(e.persistent.prestige))b&&m.push([$[f],1]);for(let f=m.length-1;f>=0;--f){let[b,_]=m[f];if(b.upkeep!==void 0){let y=b.upkeep(_,e);if(b.upkeepPerWorker!==void 0)for(let[S,F]of Object.entries(b.upkeepPerWorker(_,e)))F!==void 0&&(y[S]=(y[S]??0)*(e.persistent.activeWorkers[F]??0));ae(e,y,r)||(m.splice(f,1),l.push([b,_]))}}for(let[f,b]of m){if(f.modifiers!==void 0){let _=f.modifiers(b,e);for(let[y,S]of Object.entries(_))i[y]=(i[y]??0)+S}if(f.multipliers!==void 0){let _=f.multipliers(b,e);for(let[y,S]of Object.entries(_))s[y]=(s[y]??1)*S}}e.modifiers=i,e.multipliers=s;let d=j(R,1),w=j(R,1);for(let f of R)d[f]*=e.multipliers[`storage_${f}`]??1,w[f]*=(e.multipliers[`income_${f}`]??1)*o;for(let[f,b]of l)if(b>0&&f.storage!==void 0){let _=f.storage(b,e);for(let y of R)e.walletStorage[y]+=(_[y]??0)*d[y]}for(let[f,b]of m)if(b>0){if(f.storage!==void 0){let _=f.storage(b,e);for(let y of R)e.walletStorage[y]+=(_[y]??0)*d[y]}if(f.income!==void 0){let _=f.income(b,e);for(let y of R)e.persistent.wallet[y]+=(_[y]??0)*w[y]*r}}for(let[f,b]of m)if(f.recruit){for(let[_,y]of Object.entries(f.recruit(b,e)))if(y!==void 0){let[S,F]=y,T=e.recruitment[_];T?e.recruitment[_]={max:T.max+F,rate:T.rate+S}:e.recruitment[_]={max:F,rate:S}}}ae(e,n.workerUpkeep(e),r)||Math.random()<nr*oe(e)*r&&ct(e,-1),Lo(e,t),Go(e);for(let f of R)e.income[f]=(e.persistent.wallet[f]-u[f])/r,le(f)&&(ke(f)?e.persistent.wallet[f]=Math.min(e.persistent.wallet[f],e.walletStorage[f]):e.persistent.wallet[f]=0)}function Go(e){let t=e.persistent.wallet.research;if(e.persistent.techTarget!==void 0&&t>0){let r=!1;for(;e.persistent.techTarget!==void 0&&t>0;){let n=A[e.persistent.techTarget],o=Se(e.persistent.techTarget,e.persistent.techLevels[e.persistent.techTarget]??0),i=o-(e.persistent.techProgress[e.persistent.techTarget]??0),s=Math.min(i,t);if((e.persistent.techProgress[e.persistent.techTarget]??0)<o){let m=gt(e,e.persistent.techTarget,e.persistent.techLevels[e.persistent.techTarget]);if(m!==void 0)for(let l of R){let d=m[l]??0;if(d>0&&(s*=Math.min(1,e.persistent.wallet[l]/(d*s/o))),s<=0)break}if(e.techTargetChoked=s<Math.min(i,t),s<=0)break;if(e.persistent.techProgress[e.persistent.techTarget]=(e.persistent.techProgress[e.persistent.techTarget]??0)+s,t-=s,m!==void 0)for(let l of R){let d=m[l]??0;d>0&&(e.persistent.wallet[l]=Math.max(0,e.persistent.wallet[l]-d*s/o))}}let u=e.persistent.techProgress[e.persistent.techTarget]??0;if(u>=o){r=!0,e.persistent.techLevels[e.persistent.techTarget]++,e.persistent.techProgress[e.persistent.techTarget]=u-o;let m=n.event;m!==void 0&&Te(e,m);let l=A[e.persistent.techTarget].maxLevel;l!==void 0&&e.persistent.techLevels[e.persistent.techTarget]>=l&&Tt(e,void 0);let d=e.persistent.techLevels[e.persistent.techTarget];d>=100&&Y(e,"tech100"),d>=500&&Y(e,"tech500")}}r&&(cn(e),St(e),e.events.techLevelsChanged.invoke())}}function bn(e,t){let r=t/1e3;Ro(e,t),e.persistent.battle!==void 0&&To(e,e.persistent.battle,r),e.persistent.invaders!==void 0&&(e.persistent.invaders.countdown-=r,e.persistent.invaders.countdown<=0&&e.persistent.battle===void 0&&So(e)),je(e)||(e.persistent.fortDamage=Math.max(0,e.persistent.fortDamage-_t(e)*r));for(let[n,o]of Object.entries(e.persistent.activeSpellEffects))o.durationLeft=Math.max(0,o.durationLeft-r),o.durationLeft<=0&&delete e.persistent.activeSpellEffects[n];e.persistent.spellQueue.length>0&&xe(e,e.persistent.spellQueue[0].spell)&&(Lt(e,e.persistent.spellQueue[0].spell),Mt(e,0,!1)),e.events.ticked.invoke()}function vn(e){we||qe(e.persistent)}function Y(e,t){e.persistent.feats[t]===void 0&&(e.persistent.feats[t]=!0,e.events.featAchieved.invoke())}function Te(e,t){return e.persistent.events[t]!==!0?(e.persistent.events[t]=!0,e.events.storyEventTriggered.invoke(t),!0):!1}function wn(){let e=yo(Br());cn(e),St(e),qr(e),e.persistent.events.intro!==!0?Te(e,"intro"):e.persistent.feats.prestige===!0&&e.persistent.events.firstprestige!==!0?Te(e,"firstprestige"):e.persistent.feats.killedinbattle===!0&&e.persistent.events.firstkilledinbattle!==!0&&Te(e,"firstkilledinbattle"),bn(e,et),pt(Ot,()=>vn(e)),window.onbeforeunload=()=>vn(e);let t=window.performance.now();pt(et,()=>{if(!ht&&!Hr()){let r=window.performance.now();bn(e,Math.min(1e4,r-t)*e.gameSpeed),t=r}})}var Eo={basic_necromancy:{slot:{x:0,y:0},tier:1,maxLevel:1,icon:"death-note",income:()=>({mana:1}),storage:()=>({mana:100})},necro_workers:{slot:{x:0,y:1},tier:1,maxLevel:1,requires:{basic_necromancy:1},icon:"raise-skeleton",income:()=>({bones:1}),storage:()=>({bones:100}),enableFeatures:["workers"]},necro_cheaper_workers:{slot:{x:2,y:2},tier:1,requires:{necro_workers:1},icon:"candle-skull",multipliers:e=>({summon_skeleton_worker_cost:.7+.3*Math.pow(.96,e)})},necro_bone_scavenging:{slot:{x:-2,y:2},tier:1,requires:{necro_workers:1},specialRequires:(e,t)=>oe(t)>=3,icon:"scavenging",modifiers:e=>({bone_scavenging:.03*e}),income:(e,t)=>({bones:L(t,0,"bone_scavenging")*t.persistent.activeWorkers.wastelands}),hideIncome:["bones"],enableFeatures:["wastelands","job_wastelands"]},necro_bone_piles:{slot:{x:-4,y:3},tier:1,requires:{necro_bone_scavenging:5},icon:"telefrag",storage:e=>({bones:20*e})},necro_lumber:{slot:{x:-2,y:3},tier:1,requires:{necro_bone_scavenging:10},icon:"bone-axe",modifiers:e=>({basic_lumber:.08*e}),income:(e,t)=>({lumber:(t.modifiers.basic_lumber??0)*(t.multipliers.basic_lumber??1)*t.persistent.activeWorkers.forest}),storage:()=>({lumber:600}),hideIncome:["lumber"],enableFeatures:["forest","job_forest"]},necro_stone:{slot:{x:0,y:3},tier:1,requires:{necro_bone_scavenging:10},icon:"stone-pile",modifiers:e=>({basic_stone:.08*e}),income:(e,t)=>({stone:L(t,0,"basic_stone")*t.persistent.activeWorkers.mines}),storage:()=>({stone:600}),hideIncome:["stone"],enableFeatures:["mines","job_mines"]},necro_lumbermill:{slot:{x:-2,y:4},maxLevel:1,tier:1,requires:{necro_lumber:10},icon:"lumbermill"},necro_quarries:{slot:{x:0,y:4},maxLevel:1,tier:1,requires:{necro_stone:10},icon:"quarrying"},necro_librarystacks:{slot:{x:-4,y:4},maxLevel:1,tier:1,requires:{necro_lumber:5},enableFeatures:["sanctum"],icon:"bookshelf"},necro_expanded_mind:{slot:{x:4,y:3},tier:1,maxLevel:1,requires:{necro_cheaper_workers:10},icon:"expanded-mind"},necro_meditation:{slot:{x:4,y:4},tier:1,requires:{necro_expanded_mind:1},multipliers:e=>({expanded_mind_duration:1+.03*e}),icon:"meditation"},necro_obelisks:{slot:{x:2,y:4},maxLevel:1,tier:1,requires:{necro_stone:5,necro_cheaper_workers:10},icon:"leylines"},necro_obeliskstorage:{slot:{x:2,y:5},tier:1,currencyCost:()=>({stone:1.25}),requires:{necro_obelisks:1},modifiers:e=>({obelisk_storage:5*e}),icon:"obeliskstorage"},necro_centralization:{slot:{x:0,y:6},tier:2,maxLevel:1,currencyCost:()=>({lumber:2,stone:2}),requires:{necro_lumbermill:1,necro_quarries:1,necro_obelisks:1},enableFeatures:["courtyard"],storage:()=>({lumber:1e3,stone:1e3}),specialRequires:(e,t)=>t.persistent.buildingLevels.lumbermill>=5&&t.persistent.buildingLevels.quarry>=5,icon:"evil-tower",event:"dying"},necro_mining:{slot:{x:0,y:7},tier:2,maxLevel:1,currencyCost:()=>({lumber:1}),requires:{necro_centralization:1},modifiers:()=>({quarry_ores:15}),income:(e,t)=>({ore:L(t,0,"basic_ore")*t.persistent.activeWorkers.mines}),hideIncome:["ore"],icon:"mine"},necro_smelting:{slot:{x:0,y:8},tier:2,maxLevel:1,currencyCost:()=>({ore:.25}),modifiers:()=>({storageyard_metals:50}),requires:{necro_mining:1},icon:"smelting"},necro_smeltingworkers:{slot:{x:4,y:9},tier:2,currencyCost:()=>({metal:.5}),modifiers:e=>({smelter_workers:.4*e}),enableFeatures:["job_courtyard"],requires:{necro_smelting:1,necro_vigormortis:1},hidden:e=>!V(e),icon:"coal-pile"},necro_metaltools:{slot:{x:0,y:9},tier:2,currencyCost:()=>({metal:.5}),multipliers:e=>({basic_stone:1+.0125*e,basic_lumber:1+.0125*e}),requires:{necro_smelting:1},icon:"anvil-impact"},necro_crystalmining:{slot:{x:0,y:10},tier:2,requires:{necro_metaltools:1},modifiers:e=>({quarry_crystal_storage:50,basic_crystal:.015*e}),income:(e,t)=>({crystal:L(t,0,"basic_crystal")*t.persistent.activeWorkers.mines}),hideIncome:["crystal"],icon:"crystal-mining"},necro_ossuaries:{slot:{x:2,y:7},tier:2,maxLevel:1,currencyCost:()=>({stone:1.5}),requires:{necro_centralization:1},icon:"crypt"},necro_vigormortis:{slot:{x:2,y:8},tier:2,maxLevel:1,currencyCost:()=>({bones:3}),requires:{necro_ossuaries:1},icon:"ribcage"},necro_phylactery:{slot:{x:0,y:11},maxLevel:1,tier:3,currencyCost:()=>({mana:2,bones:1,metal:.5,crystal:.5}),requires:{necro_crystalmining:3},hidden:e=>V(e),icon:"phylactery"},necro_crystaldust:{slot:{x:-2,y:11},maxLevel:1,tier:3,currencyCost:()=>({crystal:.5}),requires:{necro_crystalmining:10,necro_ectostorage:1},storage:()=>({crystaldust:1200}),hidden:e=>!V(e),icon:"crystal-dust"},necro_shrines:{slot:{x:-2,y:7},tier:2,maxLevel:1,currencyCost:()=>({bones:3,stone:1.5,lumber:.5}),storage:()=>({ectoplasm:600}),requires:{necro_centralization:1},hidden:e=>!V(e),icon:"shrine"},necro_librarians:{slot:{x:-4,y:8},tier:2,currencyCost:e=>({ectoplasm:.25}),multipliers:e=>({stacks_research:1+.025*e}),requires:{necro_shrines:1,necro_librarystacks:1},icon:"librarians"},necro_ectostorage:{slot:{x:-2,y:9},tier:3,maxLevel:1,currencyCost:e=>({ectoplasm:.25,bones:1.25}),modifiers:e=>({ossuary_ectoplasm_storage:60}),requires:{necro_shrines:1,necro_ossuaries:1},icon:"ectostorage"},necro_deadlang:{slot:{x:-4,y:9},tier:3,multipliers:e=>({obelisk_income:1+.03*e}),requires:{necro_librarians:10},icon:"wax-tablet"},necro_military:{slot:{x:2,y:10},maxLevel:1,tier:3,currencyCost:()=>({metal:.5,lumber:1,bones:2}),requires:{necro_metaltools:10},hidden:e=>!V(e),enableFeatures:["military","military_necro_soldier"],icon:"barracks"},necro_soldier_armor:{slot:{x:4,y:11},tier:3,currencyCost:e=>({metal:1}),requires:{necro_military:1,necro_smeltingworkers:1},multipliers:e=>({necro_soldier_armor:1+.04*e}),hidden:e=>!V(e),icon:"skull-shield"},necro_palisades:{slot:{x:2,y:11},tier:3,maxLevel:1,currencyCost:e=>({lumber:3,stone:.5}),requires:{necro_military:1},requiresVictories:()=>1,modifiers:()=>({fortifications_repair:.5}),icon:"palisade"},necro_archery:{slot:{x:4,y:12},tier:3,maxLevel:1,currencyCost:e=>({lumber:1,bones:1}),requires:{necro_palisades:1},enableFeatures:["military_necro_archer"],icon:"archery"},necro_firearrows:{slot:{x:4,y:13},tier:3,currencyCost:e=>({ectoplasm:.5}),requires:{necro_archery:1,necro_shrines:1},multipliers:e=>({necro_archer_attack:1+.04*e}),enableFeatures:["military_necro_archer"],icon:"flaming-arrow"},necro_shrine_assistants:{slot:{x:-6,y:9},tier:3,currencyCost:e=>({bones:3}),requires:{necro_librarians:10},icon:"candles",modifiers:e=>({shrine_workers:.3*e})},necro_scriptorium:{slot:{x:-4,y:10},tier:3,maxLevel:1,currencyCost:()=>({ectoplasm:1,crystal:.25}),requires:{necro_ectostorage:1,necro_deadlang:10},icon:"quill-ink"},necro_scriptoriumworkers:{slot:{x:-6,y:11},tier:3,currencyCost:()=>({bones:1.25,crystal:.1}),modifiers:e=>({scriptorium_workers:.4*e}),requires:{necro_scriptorium:1,necro_shrine_assistants:10},enableFeatures:["job_sanctum"],icon:"book-pile"},necro_pillaging:{slot:{x:6,y:12},tier:3,currencyCost:()=>({stone:.25,lumber:.25}),multipliers:e=>({spoils_lumber:1+.12*e,spoils_stone:1+.12*e,spoils_ore:1+.08*e}),requiresVictories:()=>5,requires:{necro_palisades:1},enableFeatures:["spoils_ore"],icon:"swap-bag"},necro_orestore:{slot:{x:6,y:10},tier:3,currencyCost:()=>({stone:1}),modifiers:e=>({storageyard_metals:10*e,storageyard_ore:10*e}),requires:{necro_smeltingworkers:10},icon:"coal-wagon"},necro_metamagic:{slot:{x:-4,y:13},tier:3,maxLevel:5,currencyCost:()=>({crystal:1}),modifiers:e=>({metamagic_level:e}),requires:{necro_brainstorm:1,necro_deeptrance:10},icon:"burning-book"},necro_deeptrance:{slot:{x:-2,y:12},tier:3,currencyCost:()=>({crystaldust:.1}),modifiers:e=>({expanded_mind_mana_income:.12*e}),requires:{necro_crystaldust:1,necro_expanded_mind:1},icon:"steam"},necro_brainstorm:{slot:{x:-4,y:12},tier:3,maxLevel:1,currencyCost:()=>({crystaldust:.1}),requires:{necro_crystaldust:1,necro_scriptorium:1},icon:"brainstorm"},necro_workshops:{slot:{x:0,y:12},tier:3,maxLevel:1,currencyCost:e=>({metal:.5,stone:.75}),requires:{necro_palisades:1},icon:"sword-smithing"},necro_morestorage:{slot:{x:6,y:11},tier:3,currencyCost:e=>({lumber:.5,stone:.5}),multipliers:e=>({storageyard_lumber:1+.04*e,storageyard_stone:1+.04*e}),requires:{necro_orestore:10},icon:"pulley-hook"},necro_workshoprepair:{slot:{x:2,y:13},tier:4,maxLevel:1,currencyCost:e=>({lumber:.5,stone:.5}),modifiers:e=>({workshop_repair:.07}),requires:{necro_workshops:1},icon:"auto-repair"},necro_bonepillaging:{slot:{x:6,y:13},tier:3,requires:{necro_pillaging:5},multipliers:e=>({ossuary_bones_storage:1+.08*e,spoils_bones:1+.14*e}),enableFeatures:["spoils_bones"],icon:"graveyard"},necro_tomepillaging:{slot:{x:-4,y:14},tier:4,maxLevel:1,requires:{necro_metamagic:5,necro_military:1},enableFeatures:["spoils_tomes"],requiresVictories:()=>5,storage:()=>({tomes:450}),icon:"secret-book"},necro_tomestorage:{slot:{x:-6,y:15},tier:4,requires:{necro_tomepillaging:1},modifiers:e=>({stacks_tomestorage:3*e}),icon:"classical-knowledge"},necro_revenants:{slot:{x:0,y:14},maxLevel:1,tier:4,currencyCost:()=>({crystaldust:.1,ectoplasm:.25,bones:.65}),requires:{necro_workshops:1,necro_crystalassay:1},enableFeatures:["military","military_necro_revenant"],icon:"haunting"},necro_crystalassay:{slot:{x:-2,y:13},tier:4,maxLevel:1,currencyCost:e=>({metal:.75,ore:1,crystal:.15}),requires:{necro_deeptrance:10},icon:"pestle-mortar"},necro_soulassumption:{slot:{x:-4,y:15},tier:4,maxLevel:1,currencyCost:e=>({tomes:.0055}),requires:{necro_tomepillaging:1},icon:"embrassed-energy"},necro_scrying:{slot:{x:6,y:14},tier:4,maxLevel:1,currencyCost:e=>({crystal:.3}),requires:{necro_bonepillaging:5},icon:"crystal-ball"},necro_catapults:{slot:{x:2,y:14},tier:4,maxLevel:1,currencyCost:e=>({stone:1}),requires:{necro_workshoprepair:1},enableFeatures:["military_necro_catapult"],modifiers:()=>({workshop_recruit_catapult:1}),icon:"tower-fall"}},A=Eo;var Io={currency_research:"Research",currency_research_lore:"The Buried Library teems with secrets, ancient and powerful. Rigorous study of a variety of topics from arcane rituals to military strategy and engineering will expand your potential for development.",currency_research_income:"Research",currency_prestige:"Soul Essence",currency_prestige_lore:"Your mortal flesh is gone, but your soul is more powerful than ever. You hunger now for nothing but to take the soul essence of others and add it to your own.",currency_prestige_description:"This is your prestige resource. It is stored within your phylactery and persists across reincarnations. You can spend it on permanent upgrades in the Phylactery tab.",currency_prestige_storage:"Unspent Soul Essence",currency_prestigescraps:"Soul Fragments",currency_prestigescraps_lore:"The weak, pale remnants of living souls you have stolen in conquest. It seems absorbing them into the roiling soul essence within you will not be as straightforward as you initially thought.",currency_prestigescraps_description:"While they cannot be spent on upgrades yet, these fragments have the potential to be converted into Soul Essence. Most events that trigger reincarnation will convert a portion of these fragments into usable Soul Essence for your next run.",currency_prestigescraps_storage:"Accumulated Soul Fragments",currency_mana:"Mana",currency_mana_lore:"The magical energy that fills the universe, capable of flattening mountains, boiling the sea, raising the dead and everything in between. The greater your reserves of mana, the greater deeds you will be able to perform.",currency_mana_storage:"Mana Pool",currency_mana_maxstorage:"Mana Capacity",currency_mana_income:"Mana Generation",currency_bones:"Bones",currency_bones_lore:"The skeletal remnants of once-living beings, useful for a variety of grim purposes in the hands of a skilled necromancer.",currency_flesh:"Flesh",currency_flesh_lore:"The fleshy remnants of once-living beings. Harder to store and to work with, but useful for a variety of necromantic purposes.",currency_lumber:"Lumber",currency_lumber_lore:"Wood harvested and processed into a suitable form for large-scale construction.",currency_stone:"Stone",currency_stone_lore:"Rocks are abundant in nature and can be fashioned, with some work, into a useful and long-lasting material for construction and manufacturing.",currency_ore:"Ore",currency_ore_lore:"These minerals are streaked with valuable metals. Before they can be put to productive use, the ores have to be smelted to extract the metal.",currency_metal:"Ingots",currency_metal_lore:"Pure metals like copper, tin and iron cast into ingots, ready to be used in manufacturing.",currency_crystal:"Dragonsblood",currency_crystal_lore:"Despite the name, it is not literally blood, but a deep green gemstone mineral with certain useful magical properties.",currency_crystaldust:"Arcane Dust",currency_crystaldust_lore:"Finely ground dragonsblood crystal dust, useful for enhancing the potency of spells or alchemical preparations.",currency_ectoplasm:"Ectoplasm",currency_ectoplasm_lore:"These spectral emanations originate from the wrathful ghosts of the Witchwood, and can be used to facilitate contact with the spirit realm.",currency_tomes:"Arcana",currency_tomes_lore:"Secret knowledge of ancient sorcerers, once stolen from the library, now returned to their rightful place by your hand.",tech_basic_necromancy:"Necromancy",tech_basic_necromancy_lore:"The lugubrious magical art of mastery over death. This path promises untold power and eternal life, at the cost of forever becoming an outcast from ordinary society. Well, you never needed them anyway.",tech_necro_workers:"Skeletal Minions",tech_necro_workers_lore:"What good is a master without minions? The first thing you must learn is how to animate dead bones into living skeletal servants to do the heavy lifting for you. Until then, you will have to make do with whatever scraps of bone you can find yourself.",tech_necro_workers_description:"Enables the {spell:summon_skeleton_worker} spell, which creates mindless workers out of bones.",tech_necro_bone_scavenging:"Bone Scavenging",tech_necro_bone_scavenging_lore:"The wastelands surrounding the Buried Library contain the remnants of numerous old, forgotten battlefields. Your drudges could dig up these ancient bones for your use.",tech_necro_bone_scavenging_description:"Enables assigning workers to the <span class='Wastelands'>Wastelands</span>.",tech_necro_bone_scavenging_specialreq:"Requires 3 or more Skeletal Drudges",tech_necro_cheaper_workers:"Dark Incantations",tech_necro_cheaper_workers_lore:"Your initial attempts at creating skeletal servants were awkward and clumsy from inexperience. With some work, you can refine the drudge creation spell to be less taxing on your magical reserves.",tech_necro_bone_piles:"Bone Piles",tech_necro_bone_piles_lore:"Now that your drudges are bringing in the bones, a better storage solution is required. You don't yet have the materials to build some proper storage, so for now you'll have to settle for your workers at least organizing them into piles rather than dumping them all over the place.",tech_necro_lumber:"Woodcutting",tech_necro_lumber_lore:"You won't get far without some basic construction materials, and the simplest material available is wood. Some primitive axes fashioned from stone and bone should help get some lumber production started.",tech_necro_lumber_description:"Enables assigning workers to the <span class='Forest'>Witchwood</span>.",tech_necro_stone:"Rockbreaking",tech_necro_stone_lore:"If you are to build an empire, you're going to need construction materials. A nearby canyon has plenty of rock that your drudges should be able to extract and fashion into rough stone blocks.",tech_necro_stone_description:"Enables assigning workers to <span class='Mines'>Spine Canyon</span>.",tech_necro_lumbermill:"Lumber Processing",tech_necro_lumbermill_lore:"Once trees are cut down, they need to be processed into useful lumber. Constructing sites in the forest for this purpose would serve to improve the flow of lumber as well as provide intermediate storage.",tech_necro_lumbermill_description:"Enables building the {building:lumbermill}, which increases lumber income and storage.",tech_necro_quarries:"Quarrying",tech_necro_quarries_lore:"Organizing your rock extraction efforts around open-pit mines with nearby support facilities will allow you to greatly increase the flow of quality building materials.",tech_necro_quarries_description:"Enables building the {building:quarry}, which increases stone income and storage.",tech_necro_expanded_mind:"Ancient Incense",tech_necro_expanded_mind_lore:"In a corner of a dusty storage room in the Buried Library, you find a collection of ancient incense jars that, miraculously, remain sealed and in perfect condition. Some of the tomes you've read suggest these can be used to heighten your awareness of the spirit realm.",tech_necro_expanded_mind_description:"Enables the {spell:expanded_mind} spell, which temporarily increases your mana capacity.",tech_necro_meditation:"Meditation",tech_necro_meditation_lore:"The mind-expanding power of the incense you found can be combined with meditation techniques to extend how long you can keep your mind open to the realm beyond.",tech_necro_librarystacks:"Cataloguing",tech_necro_librarystacks_lore:"Whoever once inhabitated the library left it in pretty poor shape, and most of the original records have long since crumbled to dust, making it hard to find what you're looking for. Organizing the library's contents according to a simple indexing system of your own devising should help.",tech_necro_librarystacks_description:"Enables building the {building:librarystacks}, which increases your {currency:research} speed.",tech_necro_obelisks:"Leylines",tech_necro_obelisks_lore:"The land is criss-crossed by networks of magical energy called leylines that can be tapped into to fuel your spells. Although the wastelands are far from optimal in this regard, their potential still greatly exceeds what you can do with only your own innate mana.",tech_necro_obelisks_description:"Enables buildin the {building:obelisk}, which increase your {income:mana}.",tech_necro_obeliskstorage:"Runed Stelae",tech_necro_obeliskstorage_lore:"Augmenting your obelisks with a network of smaller, supporting monuments may enable them to hold onto mana for longer without channeling it directly into you, effectively increasing how much mana is available to you at any one time.",tech_necro_centralization:"Secure the Heartland",tech_necro_centralization_lore:"With a steady supply of lumber and stone now available, the time has come to turn the area immediately surrounding the Buried Library into a defensible position to act as the center of administration and production for your empire of death.",tech_necro_centralization_description:"Enables building the {building:storageyard}, which increases your storage capacity for {currency:lumber} and {currency:stone}.",tech_necro_centralization_specialreq:"Requires Lumber Mill level 5 and Quarry level 5",tech_necro_mining:"Drift Mining",tech_necro_mining_lore:"The walls of Spine Canyon are rich with a variety of metal ores. Extracting them will allow you to significantly improve many aspects of your economy.",tech_necro_mining_description:"Enables building the {building:mine}, which extracts {currency:ore} containing valuable metals.",tech_necro_smelting:"Ore Smelting",tech_necro_smelting_lore:"Most of the ore brought back from Spine Canyon can't be processed into useful metal simply by heating it over a fire. In order to increase your yields, a dedicated facility that can handle the complex (and very hot) reactions involved is needed.",tech_necro_smelting_description:"Enables building the {building:smelter}, which converts {currency:ore} into {currency:metal}.",tech_necro_smeltingworkers:"Furnace Attendants",tech_necro_smeltingworkers_lore:"Efficient ore smelting requires careful attention to temperature and a consistent supply of fuel. Stationing a few extra workers at the smelters should help.",tech_necro_smeltingworkers_description:"Enables assigning workers to the <span class='Courtyard'>Bailey</span>.",tech_necro_crystalmining:"Dragonsblood Deposits",tech_necro_crystalmining_lore:`The tomes describe the dark green crystal deposits recently discovered in the mines as "dragon's blood", and claims the mineral has a natural ability to absorb and transform mana. Some must be acquired at once.`,tech_necro_ossuaries:"Ossuaries",tech_necro_ossuaries_lore:"You have some new ideas for things you could do to improve your skeletal minions, but you need better access to raw materials first. Constructing a dedicated storage space close to your sanctum will help make sure you always have enough on hand for your experiments.",tech_necro_ossuaries_description:"Enables building the {building:ossuary}, which increases your storage capacity for {currency:bones}.",tech_necro_vigormortis:"Reinforced Ribcages",tech_necro_vigormortis_lore:"The relatively fragile nature of bone makes it hard for your drudges to perform as well as a living creature. However, with some key magical augmentation, you might be able to increase their productive capabilities on a temporary basis, at least.",tech_necro_vigormortis_description:"Enables the {spell:vigormortis} spell, which temporarily increases resource production.",tech_necro_phylactery:"Phylactery",tech_necro_phylactery_lore:"Feverish, fingers trembling, you flip the pages of the dusty book before you. Could it be? The grimoire claims that propery prepared dragonsblood gemstones can be made to absorb and contain the soul of a living being, either to enslave them... or to grant them eternal life. This is it. This is what you've been looking for. You must spare no effort in crafting the device.",tech_necro_phylactery_description:"Enables you to craft a <span class='Spell'>Phylactery</span> in which to store your soul, granting you eternal life. Hopefully. Once ready, you will be able to cast a spell to finalize the process.",tech_necro_crystaldust:"Crystal Grinding",tech_necro_crystaldust_lore:"Raw dragonsblood crystals can hold and conduct mana, but only to a certain degree. Carefully grinding them into a fine powder should improve these qualities. This is a delicate process that can't be entrusted to your drudges.",tech_necro_crystaldust_description:"Enables the {spell:craft_dust} spell, which creates {currency:crystaldust} from {currency:crystal}.",tech_necro_metamagic:"Empowered Magic",tech_necro_metamagic_lore:"The mana-conducting properties of dragonsblood dust can greatly amplify the effects of your spells. Intense study will be required, but you're optimistic that the meta-magical principles can be applied broadly.",tech_necro_metamagic_description:"Enables casting higher-rank versions of many of your spells, at the cost of {currency:crystaldust} and higher {currency:mana} cost.",tech_necro_shrines:"Spirit Communion",tech_necro_shrines_lore:"The Witchwood is haunted by the angry spirits of heretics, sorcerers and others who were unjustly executed for their so-called crimes. By constructing a shrine in the forest, you may be able to commune with those spirits and recruit them to your cause.",tech_necro_shrines_description:"Enables building the {building:shrine}, which generates {currency:ectoplasm}.",tech_necro_librarians:"Spectral Librarians",tech_necro_librarians_lore:"Among the many executed criminals that now haunt the Witchwood are several would-be sorcerers whose hunger for arcane knowledge has not abated in death. Allow them free reign of your library, and they may assist your research efforts.",tech_necro_ectostorage:"Ghost Jars",tech_necro_ectostorage_lore:"Spectral ectoplasm is highly unstable, discorporating into the spirit realm before long. However, you might be able to preserve it longer by allowing it to fuse with properly prepared vessels that can be stored in your ossuaries.",tech_necro_military:"Army of the Dead",tech_necro_military_lore:"Freed from mortal concerns, the time has come to direct your attention towards the subjugation of those who once exiled you. The lands of the living will provide ample soul essence to fuel your newfound powers.",tech_necro_military_description:"Enables the Military tab and the {spell:summon_skeleton_warrior} spell, which creates a simple infantry soldier for your army.",tech_necro_soldier_armor:"Forged Shields",tech_necro_soldier_armor_lore:"Bone, even animated by your dark magic, is relatively fragile. Your skeleton warriors are too unstable to wear a full suit of armor, but they should be able to carry some shields.",tech_necro_palisades:"Military Fortifications",tech_necro_palisades_lore:"With the threat of invasion looming on the horizon, the need to develop some rudimentary fortifications becomes more pressing.",tech_necro_palisades_description:"Enables building the {building:palisade}, which provides defensive bonuses when defending against invading armies.",tech_necro_archery:"Bone Archers",tech_necro_archery_lore:"Basic fortifications are well and good, but you could make better use of them if you had access to soldiers capable of attacking at range.",tech_necro_archery_description:"Enables the {spell:summon_skeleton_archer} spell, which creates a ranged infantry soldier for your army.",tech_necro_firearrows:"Ghostfire Arrows",tech_necro_firearrows_lore:"Cold, ectoplasmic fire can enhance the effect of your bowmen's arrows, and unlike normal fire, carries no risk of accidentally setting them alight.",tech_necro_metaltools:"Metal Tools",tech_necro_metaltools_lore:"Until now, you've had to do with tools made of stone and whatever your minions have been able to scavenge. Now, with a stable source of iron, you can give them proper tools to work with.",tech_necro_workshops:"Organized Manufacturing",tech_necro_workshops_lore:"As your empire grows increasingly militarized, the need for a dedicated facility for the production and maintenance of the means of war has become apparent.",tech_necro_workshops_description:"Enables building the {building:workshop}, which reduces the cost of deploying military units.",tech_necro_deadlang:"Ancient Lexicography",tech_necro_deadlang_lore:"Many of the texts in the library are written in a strange, dead language. By improving your understanding of it, you might be able to refine the runic structure of your obelisks, increasing their potential.",tech_necro_shrine_assistants:"Ritual Preparation",tech_necro_shrine_assistants_lore:"The complex rituals required to allow spirits to manifest are rather taxing. Your laborers can handle some of the menial tasks involved in the shrine rituals, leaving you to focus on matters spiritual.",tech_necro_scriptorium:"Original Research",tech_necro_scriptorium_lore:"Your ghostly minions, having feasted on the great volumes of lore held in the library, are now eager to begin experimenting and writing new volumes of their own. To this end, they require a dedicated space to work.",tech_necro_scriptorium_description:"Enables building the {building:scriptorium}, which further increases your {currency:research} speed.",tech_necro_scriptoriumworkers:"Research Assistants",tech_necro_scriptoriumworkers_lore:"Ghostly scholars have one major problem, aside from their raging, obsessive madness: carrying books between the stacks and the scriptorium is difficult when you're barely able to manifest physically in the first place. Fortunately, your drudges can help with that.",tech_necro_scriptoriumworkers_description:"Enables assigning workers to the <span class='Sanctum'>Inner Sanctum</span>.",tech_necro_pillaging:"Pillaging",tech_necro_pillaging_lore:"The lands of the living are a treasure trove not merely of soul fragments, but of natural resources like stone and lumber as well. Making a concerted effort to bring back anything that looks valuable is sure to increase the profits from your military operations.",tech_necro_pillaging_description:"Spoils of battle may now also include {currency:ore}.",tech_necro_orestore:"Ore Bins",tech_necro_orestore_lore:"As your metal production scales up, establishing a stronger supply line of smeltable ore has become paramount, and with that comes the need to find someplace to store it all.",tech_necro_tomepillaging:"Secret Lore",tech_necro_tomepillaging_lore:"As your research delves deeper, it becomes clear that many volumes are missing from the Buried Library. Other texts mention that they were likely stolen a long time ago by jealous sorcerers. These works must be retrieved from the lands of the living and incorporated into your research.",tech_necro_tomepillaging_description:"Spoils of battle may now also include {currency:tomes}.",tech_necro_tomestorage:"Foreign Books Section",tech_necro_tomestorage_lore:"Lest they be lost among the piles of ancient lore, the books and scrolls looted from the lands of the living should be stored in a dedicated section.",tech_necro_bonepillaging:"Empty the Graveyards",tech_necro_bonepillaging_lore:"Up to now, your soldiers have merely brought back the bones of the recently fallen, but wherever there are living people there are graveyards and crypts teeming with old bones waiting to be dug up and added to your collection.",tech_necro_revenants:"Spectral Incarnation",tech_necro_revenants_lore:"You've made a tremendous discovery: treating bones with dragonsblood dust makes them excellent ectoplasmic vessels, allowing you at last to create a warrior with passable intelligence by allowing a spirit to possess a skeletal construct.",tech_necro_revenants_description:"Enables the {spell:summon_revenant} spell, which creates an evasive soldier with high attack power for your army.",tech_necro_deeptrance:"Crystal Incense",tech_necro_deeptrance_lore:"The books mention theorizing that the incense you use for your meditation sessions could be enhanced by infusing it with dragonsblood dust, but that this was deemed too hazardous for living beings. Well, you are no longer living, so that poses no barrier for you.",tech_necro_brainstorm:"Intense Study",tech_necro_brainstorm_lore:"As your empire grows, you seem to find less and less time to spend immersing yourself in research, but when you do find the time, it's all the more important to not let your mind wander.",tech_necro_brainstorm_description:"Enables the {spell:brainstorm} spell, which boosts your research rate.",tech_necro_crystalassay:"Dragonsblood Assaying",tech_necro_crystalassay_lore:"Even ordinary ore occasionally contains trace amounts of dragonsblood. A simple process can be devised to detect it and feed the ore through drudge-operated grinders and filters to produce arcane dust. The yield is much lower than what you can grind on your own, but won't consume precious gem-grade dragonsblood.",tech_necro_crystalassay_description:"Enables building the {building:oregrinder}, which converts {currency:ore} into {currency:crystaldust}.",tech_necro_morestorage:"Gantry Cranes",tech_necro_morestorage_lore:"As your stockpile of material resources grows, so does the need for efficient means of moving all that bulk around. A system of rope and pulley systems attached to a movable gantry should help make the most out of the space available.",tech_necro_workshopstorage:"Storehouses",tech_necro_workshopstorage_lore:"Your new workshops promise military invention like never before seen, but in order to do so effectively, they need to be well supplied with resources.",tech_necro_workshoprepair:"Masonry Maintenance",tech_necro_workshoprepair_lore:"Each wave of invaders repelled leaves your fortifications in a sorrier state. Organized work crews dedicated to keeping them in top shape should greatly increase the mileage your fortifications provide over time.",tech_necro_soulassumption:"Metempsychosis",tech_necro_soulassumption_lore:"The soul fragments you conquer from their undeserving former owners stubbornly refuse to integrate themselves with your phylactery. Your new tomes speak of a ritual that can accomplish this feat, though it is a dangerous one. Still, it is the only means you have to quell this frustration.",tech_necro_soulassumption_description:"Enables the {spell:soulassumption} spell, which integrates {currency:prestigescraps} into your {currency:prestige} and resets the game.",tech_necro_scrying:"Magical Surveying",tech_necro_scrying_lore:"The lands of the living are a veritable smorgasbord of morsels ripe for the taking, but your choice of targets is limited by what you can survey. With magical scrying tools at your disposal, you could pick and choose your targets more freely.",tech_necro_scrying_description:"Enables the {spell:scry} spell, which replaces your list of war targets with new ones.",tech_necro_catapults:"Siege Engines",tech_necro_catapults_lore:"If you can build fortifications, so can your enemies. Skeletal spearmen might pass muster when it comes to dealing with fleshy rank and file, but fall short against stone walls. Something better is required.",tech_necro_catapults_description:"Your {building:workshop} will now automatically construct siege engines over time that can join your army on assaults.",prestige_brilliance:"Undead Intellect",prestige_brilliance_lore:"Shedding your mortal coil has opened your mind to possibilities you'd never before considered. Untethered from your old flesh, it's as if you can think clearly for the first time ever.",prestige_manaregen:"Concentration",prestige_manaregen_lore:"Swirling magical enemy fills the cavity in your skull where once was a meager, soft brain. Magic flows more easily through you than ever before.",prestige_betterbooks:"Rare Books",prestige_betterbooks_lore:"Your ability to locate the most important and valuable books is slowly improving. You feel like you understand the library a little better with each reincarnation.",prestige_drudge_mastery:"Drudge Mastery",prestige_drudge_mastery_lore:"Practice pays dividends; you've raised so many skeletal workers now that you can do it almost without thinking.",prestige_spell_queue:"Sequential Casting",prestige_spell_queue_lore:"Spells flow easily from your mind, like clear water from a spring. In time, they will become a mighty river, sweeping away your foes.",prestige_spell_queue_description:"Enables the Spell Queue. Any time you attempt to cast a spell you can't afford, it will instead be queued and automatically cast once you do have the resources to cast it.",prestige_morestorage:"Organizer",prestige_morestorage_lore:"Your mind's eye is opened to the joy of efficient organization; boxes, crates, barrels, all will be lined up in perfect, maximally efficient order.",prestige_records:"Hall of Records",prestige_records_lore:"You have accomplished much in little time, and the future holds the promise of even greater glory. It's time to immortalize your deeds.",prestige_records_description:"Enables the Records tab, where you can review statistics and achievements you've completed. Completing achievements now also grants a modest (0.5%) global productivity increase.",modifier_bone_scavenging:"{income:bones} {0}/s per <span class='Wastelands'>Wastelands</span> worker",modifier_basic_lumber:"{income:lumber} {0}/s per <span class='Forest'>Witchwood</span> worker",multiplier_basic_lumber:"{income:lumber} from <span class='Forest'>Witchwood</span> workers {0}",modifier_basic_stone:"{income:stone} {0}/s per <span class='Mines'>Spine Canyon</span> worker",multiplier_basic_stone:"{income:stone} from <span class='Mines'>Spine Canyon</span> workers {0}",modifier_basic_ore:"{income:ore} {0}/s per <span class='Mines'>Spine Canyon</span> worker",multiplier_basic_ore:"{income:ore} from <span class='Mines'>Spine Canyon</span> workers {0}",modifier_basic_crystal:"{income:crystal} {0}/s per <span class='Mines'>Spine Canyon</span> worker",multiplier_basic_crystal:"{income:crystal} from <span class='Mines'>Spine Canyon</span> workers {0}",modifier_stacks_research:"{building:librarystacks} {income:research} {0}",modifier_stacks_tomestorage:"{building:librarystacks} {storage:tomes} {0}",modifier_obelisk_storage:"{building:obelisk} {storage:mana} {0}",modifier_obelisk_income:"{building:obelisk} {income:mana} {0}",modifier_shrine_income:"{building:shrine} {income:ectoplasm} {0}",modifier_shrine_workers:"{building:shrine} {income:ectoplasm} {0} per <span class='Forest'>Witchwood</span> worker",modifier_storageyard_lumber:"{building:storageyard} {storage:lumber} {0}",modifier_storageyard_stone:"{building:storageyard} {storage:stone} {0}",modifier_storageyard_metals:"{building:storageyard} {storage:metal} {0}",modifier_storageyard_ore:"{building:storageyard} {storage:ore} {0}",modifier_quarry_ores:"{building:quarry} {storage:ore} {0}",modifier_quarry_crystal_storage:"{building:quarry} {storage:crystal} {0}",modifier_workshop_storage_lumber:"{building:workshop} {storage:lumber} {0}",modifier_workshop_storage_stone:"{building:workshop} {storage:stone} {0}",modifier_workshop_storage_crystal:"{building:workshop} {storage:crystal} {0}",modifier_workshop_repair:"{building:workshop} <span class='FortStrength'>Fortification Repair Speed</span> {0}/s",modifier_workshop_recruit_catapult:"Max {military:necro_catapult} {0} per {building:workshop}",modifier_ossuary_bones_storage:"{building:ossuary} {storage:bones} {0}",modifier_ossuary_ectoplasm_storage:"{building:ossuary} {storage:ectoplasm} {0}",modifier_smelter_workers:"{building:smelter} Upkeep costs and {income:metal} {0} per <span class='Courtyard'>Bailey</span> worker",modifier_scriptorium_research:"{building:scriptorium} {income:research} {0}",modifier_scriptorium_workers:"{building:scriptorium} {income:research} {0} per <span class='Sanctum'>Inner Sanctum</span> worker",modifier_summon_skeleton_worker_cost:"{spell:summon_skeleton_worker} <span class='Currency CurrencyMana'>Mana Cost</span> {0}",modifier_expanded_mind_duration:"{spell:expanded_mind} Duration {0}",modifier_expanded_mind_mana_income:"{spell:expanded_mind} {income:mana} {0}/s",modifier_deploy_material_cost:"Material Deployment Costs {0}",modifier_necro_soldier_armor:"<span class='MilitaryDefense'>Skeletal Warrior Toughness</span> {0}",modifier_necro_archer_attack:"<span class='MilitaryAttack'>Skeletal Bowman Strength</span> {0}",modifier_metamagic_level:"Maximum <span class='Spell'>Spell Rank</span> {0}",modifier_spellqueue_max:"Maximum <span class='Spell'>Queued Spells</span> {0}",modifier_fortifications:"<span class='FortStrength'>Fortification Strength</span> {0}",modifier_fortifications_repair:"<span class='FortStrength'>Fortification Repair Speed</span> {0}/s",multiplier_fortifications_repair:"<span class='FortStrength'>Fortification Repair Speed</span> {0}",multiplier_storage_mana:"{storage:mana} {0}",multiplier_income_mana:"{income:mana} {0}",multiplier_storage_bones:"{storage:bones} {0}",multiplier_storage_lumber:"{storage:lumber} {0}",multiplier_storage_stone:"{storage:stone} {0}",multiplier_storage_ore:"{storage:ore} {0}",multiplier_spoils_lumber:"{currency:lumber} spoils from battle {0}",multiplier_spoils_stone:"{currency:stone} spoils from battle {0}",multiplier_spoils_ore:"{currency:ore} spoils from battle {0}",multiplier_spoils_bones:"{currency:bones} spoils from battle {0}",spell_summon_skeleton_worker:"Raise Skeletal Drudge",spell_summon_skeleton_worker_lore:"Raising an entire corpse to unlife is a difficult process beyond the capabilities of fledgling necromancers. Fortunately, bones are much easier to work with; any old collection in roughly the correct configuration can make a plausible, if weak servant.",spell_summon_skeleton_worker_description:"Creates a Skeletal Drudge, a mindless worker that can perform a variety of tasks. The cost increases the more drudges you already have.",spell_expanded_mind:"Spirit Trance",spell_expanded_mind_lore:"By attuning your mind to the world beyond the veil of mortality, you can draw in more mana, and thus perform greater magical feats.",spell_vigormortis:"Vigor Mortis",spell_vigormortis_lore:"Strengthens the bones of your skeletal drudges, allowing them to chop faster and dig deeper.",spell_brainstorm:"Brainstorm",spell_brainstorm_lore:"Focuses your undead mind, significantly enhancing your ability to take in and process information for a brief period of time.",spell_phylactery:"Soul Transfer",spell_phylactery_lore:"The phylactery is ready. If everything goes as it should, it will accept your soul within it, and as long as it remains intact, you will live forever. Thus the books promise. Only the final step remains; to chant the sealing spell... and drive a dagger deep within your own heart, ending your current existence and reawakening you as something greater.",spell_phylactery_description:"<span class='Ascension'>This will reset your game. All progress up to this point will be lost, but you will be awakened to a greater potential and a new path in unlife. Further progress through the game will not be possible without taking this route.</span>",spell_soulassumption:"Soul Assumption",spell_soulassumption_lore:"You've finally managed to recreate the ancient ritual that will allow your weak, pale scraps of stolen souls to fully fuse with your phylactery and join with your soul essence within it. However, the raw shock of magical energy will almost surely cause your current body to disintegrate. You've come too far to fear such a mere trifle as death, of course.",spell_soulassumption_description:"<span class='Ascension'>This will reset your game. All normal progress up to this point will be lost, but you will keep your {currency:prestige} and your {currency:prestigescraps} will be converted into {currency:prestige} at an improved rate.</span>",spell_craft_dust:"Craft Arcane Dust",spell_craft_dust_lore:"The delicate nature of the grinding process makes it suitable only for your own bony hands and wears the grindstone down quickly, but the resulting dust holds great promise.",spell_craft_dust_description:"Grinds dragonsblood crystals into <span class='Currency CurrencyCrystaldust'>Arcane Dust</span>. The process is not entirely predictable and the yield varies.",spell_summon_skeleton_warrior:"Raise Skeletal Warrior",spell_summon_skeleton_warrior_lore:"The same fundamental incantations that create your drudges, adapted to more military purposes.",spell_summon_skeleton_warrior_description:"Creates a Skeletal Warrior, a simple infantry soldier. The cost increases the more warriors you already have.",spell_summon_skeleton_archer:"Raise Skeletal Bowman",spell_summon_skeleton_archer_lore:"Enabling a skeleton to fire a bow effectively is going to require augmenting the enchantments holding their shoulder and arm joints together, at the expense of general stability.",spell_summon_skeleton_archer_description:"Creates a Skeletal Bowman, a ranged infantry soldier. The cost increases the more bowmen you already have.",spell_summon_revenant:"Raise Revenant",spell_summon_revenant_lore:"Fuses the spirit of a deceased warrior with a carefully prepared skeleton, creating an intelligent (if somewhat insane) warrior that is neither fully physical nor spectral in nature.",spell_summon_revenant_description:"Creates a Revenant, an evasive infantry soldier. The cost increases the more revenants you already have.",spell_scry:"Scry",spell_scry_lore:"Your mind soars like a bird over the lands of the living, surveying, searching for new avenues of attack.",spell_scry_description:"Replaces all currently available war targets with new ones of the same challenge level.",building_lumbermill:"Lumber Mill",building_lumbermill_lore:"A processing facility for converting felled trees into planks and beams for use in construction.",building_quarry:"Quarry",building_quarry_lore:"An open-pit mine where rock is carved out of the sheer walls and carved into blocks to be used as building material.",building_librarystacks:"Library Stacks",building_librarystacks_lore:"These large, ornate bookcases serve as both storage and indexing system for the library's many tomes and scrolls.",building_obelisk:"Obelisk",building_obelisk_lore:"A towering carved stone pillar, etched with magical runes and placed at an intersection between leylines. It draws mana from the earth, recharging your reserves.",building_storageyard:"Storage Yard",building_storageyard_lore:"All lumber and stone harvested elsewhere in your empire ends up here sooner or later, where it can be stored safely for later dispatch to wherever it's needed.",building_metalmine:"Mine",building_metalmine_lore:"Shafts cut straight into the walls of the canyon for the purpose of the extraction of a variety of mineral ores.",building_ossuary:"Ossuary",building_ossuary_lore:"Dedicated chambers for the storage of skeletal parts, neatly organized in cubby holes and on shelves.",building_smelter:"Smelter",building_smelter_lore:"Large and incredibly hot furnaces that process raw mineral ores into workable metal.",building_shrine:"Shrine",building_shrine_lore:"This elaborate shrine facilitates communion with the angry spirits of the Witchwood, allowing them to materialize physically in exchange for some of your mana.",building_palisade:"Palisade Wall",building_palisade_lore:"A simple defensive structure consisting of sharpened wooden stakes rammed into the ground. Determined attackers can force their way through, but it's better than nothing.",building_workshop:"Workshop",building_workshop_lore:"Day and night, your minions toil here to make weapons, armor and fortifications for your empire.",building_scriptorium:"Scriptorium",building_scriptorium_lore:"Scholarly spirits and long-dead sorcerers congregate in these chambers to analyze the lore within the library, distilling and developing it into actionable research.",building_oregrinder:"Ore Grinder",building_oregrinder_lore:"First, a simple assaying agent is administered to separate the dragonsblood-bearing ore from the chaff, then it is ground in large tumblers, producing a certain amount of usable arcane dust.",military_necro_soldier:"Skeletal Warrior",military_necro_soldier_lore:"Little more than a drudge given a spear and some basic enchantments to improve its combat prowess. Nevertheless, they make decent fighters on fear factor alone, and will fight tirelessly without need for rest or food.",military_necro_archer:"Skeletal Bowman",military_necro_archer_lore:"Equipped with bows, these bony archers will fire volleys of arrows from a safe distance behind your front line infantry. Should the front line fall, they are much less effective.",military_necro_revenant:"Revenant",military_necro_revenant_lore:"A skeleton possessed by one of the wrathful spirits from the Witchwood. Their halfway existence between the physical and spiritual realms allows them to deftly avoid even the swiftest blows.",military_necro_catapult:"Skullapult",military_necro_catapult_lore:"A massive, creaking monstrosity of wood and iron, capable of launching a large skull-shaped rock a tremendous distance, breaking walls and flesh alike.",military_cpu_peasant:"Peasant Militia",military_cpu_peasant_lore:"This poor lot know little more than toil, and fight only by necessity, using improvised weapons hastily cobbled together from farming implements. Even the weakest member of your army should have no problem crushing them underfoot.",military_cpu_infantry_human:"Legionnaire",military_cpu_infantry_human_lore:"The rank and file of the armies of men. They have some training, and functional equipment, but are only truly effective in large numbers.",military_cpu_infantry_elven:"Elven Skirmisher",military_cpu_infantry_elven_lore:"Elven frontline infantry, equipped with curved polearms and lightweight armor. Their culture's preference for ranged combat leaves them somewhat under-equipped compared to their human and dwarven allies.",military_cpu_infantry_dwarven:"Dwarven Axeman",military_cpu_infantry_dwarven_lore:"Stout, resilient dwarven infantry, wielding heavy iron axes and thick mail.",military_cpu_catapult:"Catapult",military_cpu_catapult_lore:"A siege weapon capable of launching large rocks a significant distance, and a significant threat to your fortifications.",militaryability_ethereal:"Ethereal",militaryability_ethereal_description:"Ignores 75% of the attacker's <span class='MilitarySkill'>Prowess</span> when defending and 25% of the defender's <span class='MilitaryDefense'>Toughness</span> when attacking.",militaryability_siege:"Siege Engine",militaryability_siege_description:"Deals triple damage to <span class='FortStrength'>Fortifications</span>.",tt_militaryclass_melee:"Infantry",tt_militaryclass_ranged:"Ranged Infantry",tt_militaryclass_cavalry:"Cavalry",tt_militaryclass_wizard:"Warmage",tt_militaryclass_siege:"Siege Engine",tt_military_skill:"Prowess:",tt_military_attack:"Strength:",tt_military_defense:"Toughness:",tt_military_stats_hint:"Prowess affects chance to hit or evade attacks. Strength and Toughness determine casualties when an attack does hit.",tt_military_recruit:"Trains a {1} every {2} (up to {0})",tt_military_recruit_necro_catapult:"Constructs a {1} every {2} (up to {0})",tt_military_recruit_hint:"Training/construction time depends on how many units you already have.",tt_military_recruit_active_hint:"This unit is being automatically produced every {0} at the following cost (up to {1}). Click this unit's portrait to toggle this off.",tt_military_recruit_inactive_hint:"This unit can be automatically produced. Click this unit's portrait to toggle this on.",wartarget_human:"Human",wartarget_elven:"Elven",wartarget_dwarven:"Dwarven",wartarget_village:"Hamlet",ui_assault_header:"Launch Assault",ui_invaders_header:"Army of Light",ui_invaders_countdown:"Expected Arrival: ",ui_invaderanger_header:"Reckoning",ui_deploy_none:"None",ui_deploy_25:"25%",ui_deploy_50:"50%",ui_deploy_75:"75%",ui_deploy_all:"All",tt_deploy_header:"Deployment",tt_deploy_description:"This interface allows you to send your standing army on assaults against the lands of the living, earning you various resources. Each unit has a deployment cost that must be paid to start an assault. Select the number of each unit you wish to deploy, then select a war target from the list below.",tt_deploy_allocation_help:"Use the arrow buttons to change how many units of this type should be deployed. Selecting more than you have will result in all of them being deployed. Hold <span class='ModifierKey'>Ctrl</span> when clicking to add/remove 5 units at a time, or <span class='ModifierKey'>Shift</span> to add/remove all of your units of that type.",ui_battleresult_victory:"{0}: Victory!",ui_battleresult_victory_lore:"Your foes lie trampled underneath your army's heels, the spoils of victory yours for the taking. You are one step closer to the revenge you deserve.",ui_battleresult_defeat:"{0}: Defeat...",ui_battleresult_defeat_lore:"The sting of defeat is bitter indeed. The remains of your army lies crushed into the blood-soaked mud, and your foes' holdings yet stand. Alas, the day was not yours this time...",ui_battleresult_casualties:"Casualties:",ui_battleresult_spoils:"Spoils:",ui_wartargetbattle_title:"Invasion of {0}",ui_defensebattle_title:"Siege of the Library",ui_battle_side_you:"Your Forces",ui_battle_side_enemy:"Enemy Forces",ui_wartarget_population:"Population: {0}",ui_wartarget_defenders:"Defenders:",tt_battle_retreat:"Retreat",tt_battle_retreat_lore:"Caution is the better part of valor, bitter though it may be.",tt_battle_retreat_description:"If you feel a battle is not going your way, click this button to retreat and spare yourself any further casualties. Be aware, however, that war targets are always fought at their full strength no matter what.",tt_standingarmy_header:"Standing Army",tt_standingarmy_lore:"What cannot be taken with magic will be won through force of arms. With this army, you will lay waste to the insolent worms who scorned you.",tt_standingarmy_description:"This is your standing army. You can send them to assault any of the war targets listed below. While engaged in a battle elsewhere, any new units you create will remain at home. When defending against invasions, created units will instead immediately join the ongoing battle.",tt_fortstrength_header:"Fortifications",tt_fortstrength_lore:"Whether heavy stone ramparts or simple wooden palisades, nothing beats a solid wall in keeping unwanted attention away.",tt_fortstrength_description:"Fortifications protect your armies during sieges, taking damage in their place. Fortifications are automatically repaired over time.",tt_wartarget_assault:"War Target",tt_wartarget_lore:"A sleepy hamlet, unaware of the fate that is to befall them. To you, they are nothing but a trove of soul essence ripe to be added to your own.",tt_wartarget_assault_description:"Click to send your army to attack this war target. If you are victorious in battle, your troops will return with the spoils of war and this target will be replaced with a new, more difficult and more rewarding challenge.",tt_wartarget_cannotassault_noarmy:"Select how many units to deploy above before selecting a war target.",tt_wartarget_cannotassault_cantafford:"You cannot afford to deploy these units. Select fewer units above to reduce the deployment cost.",tt_wartarget_cannotassault_inbattle:"You're already fighting a battle.",tt_wartarget_cannotassault_invaded:"You cannot send troops to assault a war target while the Army of Light is marching on your lands.",tt_invaders_header:"Army of Light",tt_invaders_lore:"The living have been pushed to the point where they have concluded that something must be done to stop your rampage across their lands. Warriors, mercenaries and adventurers of all sorts now flock under the banners of a great alliance, preparing to march on your empire.",tt_invaders_description:"When the countdown expires, enemy forces will besiege the Buried Library. If you are able to repel them, the game will continue and the reckoning gauge will be reset, and you will also receive higher than usual Soul Fragment rewards from this battle. Fail, and you will be slain and your empire laid to ruin.",tt_invaders_prestige:"<span class='Ascension'>Your phylactery will allow you to reincarnate and keep your Soul Essence, but you will have to rebuild your empire once more. A portion of your Soul Fragments will also be converted into Soul Essence.</span>",tt_invaderanger_header:"Reckoning",tt_invaderanger_lore:"As your dark influence extends over the kingdoms of the living they lash out in turn, seeking your undoing.",tt_invaderanger_description:"Every aggressive action you take against the living will advance the reckoning gauge. The higher the gauge, the more likely your next action will cause them to launch an invasion of your empire in retaliation, forcing you to defend the Buried Library or face fatal consequences; however, should you win, you will also reap greater rewards than from a normal battle.",tt_invaderanger_chance:"Current chance:",tt_currency_storage:"Storage",tt_currency_maxstorage:"Storage",tt_currency_income:"Income",tt_currency_upkeep:"Upkeep",tt_tech_notresearched:"Not Researched",tt_tech_researched:"Researched:",tt_tech_researched_level:"Researched Level {0}:",tt_tech_researched_level_max:"Researched Level {0} / {1}:",tt_tech_whenresearched:" When Researched:",tt_tech_nextlevel:"Next Level:",tt_tech_researchcost:"Research Progress: ",tt_tech_requires:"Requires {0}",tt_tech_requires_level:"Requires {0} Level {1}",tt_tech_requires_victories:"Requires {0} military victories",tt_tech_researchcost_progress:"{0}/{1} ({2})",tt_tech_choked:"Your research rate is limited by a lack of available research materials. Completion will take longer than anticipated unless you can produce more of the required materials.",tt_prestige_notpurchased:"Not Purchased",tt_prestige_purchased:"Purchased:",tt_prestige_whenpurchased:"When Purchased:",tt_spell_notactive:"Not Active",tt_spell_activeduration:"Active Effects ({0} left):",tt_spell_castnew:"Casting this spell will grant for {0}:",tt_spell_castextend:"Casting this again will extend the active effect duration by {0}.",tt_spell_cantcast_inbattle:"Cannot be cast in battle",tt_spell_cantcast_outofbattle:"Can only be cast in battle",tt_spell_queue:"Spell Queue",tt_spell_queue_description:"Whenever you click a spell above that you can't afford to cast right now, it will instead be queued and automatically cast later once you do have the required resources. If you change your mind, you can click spells in the queue to cancel them.",tt_spell_queue_help:"Click to remove this spell from the queue. If you have more than one instance of this spell queued up, hold <span class='ModifierKey'>Shift</span> and click to remove all of them.",tt_spell_multicast_hint:"Hold <span class='ModifierKey'>Ctrl</span> when casting a spell to cast it five times at once.",tt_building_level:"Constructed Level {0}:",tt_building_levelpartial:"Constructed Level {0} ({1} Enabled):",tt_building_levelalldisabled:"Constructed Level {0} (Disabled)",tt_building_nextlevel:"Next Level:",tt_emptybuilding:"Empty Improvement Slot",tt_emptybuilding_description:"There is space here for an improvement. With enough research, you will eventually be able to construct something to fill it.",tt_building_multibuild_hint:"Hold <span class='ModifierKey'>Ctrl</span> when building an improvement to build five levels at once.",tt_upkeep:"Upkeep:",tt_upkeep_trailer:"Upkeep",tt_upkeep_perworker:" per <span class='{1}'>{0}</span> Worker",tt_upkeep_allworkers:"Upkeep (All Workers):",tt_upkeep_hint:"If you find yourself unable to consistently pay upkeep, consider disabling some of these improvements with the arrow buttons on either side of the level indicator. They can be enabled again later at no cost. If the improvement provides storage, it will still do so even when disabled.",tt_joballocator:"Worker Assignment",tt_joballocator_description:"Controls how many of your workers are assigned to this location. The number on the right shows how many workers you have assigned to work here, and the number on the left how many are actively working here. Once you've set the desired number of workers, idle workers will be automatically moved to this location when available.",worker_description:"These workers are idle, not performing any useful labor, and should be assigned to a location.",tt_warfeature_walls:"Walls",tt_warfeature_walls_description:"This war target has fortifications that you'll need to destroy before you can inflict casualties on the defenders.",tt_warfeature_lumbermill:"Lumber Mill",tt_warfeature_lumbermill_description:"Spoils from this target will include more {currency:lumber}.",tt_warfeature_quarry:"Quarry",tt_warfeature_quarry_description:"Spoils from this target will include more {currency:stone}.",tt_warfeature_mine:"Mine",tt_warfeature_mine_description:"Spoils from this target will include more {currency:ore}.",tt_warfeature_library:"Library",tt_warfeature_library_description:"Spoils from this target will include more {currency:tomes}.",tt_tab_tech:"Research",tt_tab_tech_description:"Allows you to select research topics for study.",tt_tab_prestige:"Phylactery",tt_tab_prestige_description:"Allows you to spend <span class='Currency CurrencyPrestige'>Soul Essence</span> to improve the potency of your phylactery. Phylactery upgrades are permanent, persisting across resets.",tt_tab_records:"Records",tt_tab_records_description:"Allows you to review statistics and achievements you've completed.",tt_tab_domain:"Domain",tt_tab_domain_description:"Allows you to manage worker assignment and improvements.",tt_tab_military:"Military",tt_tab_military_description:"Allows you to manage your military and launch assaults on enemy settlements.",necromancy_worker:"Skeletal Drudge",necromancy_worker_plural:"Skeletal Drudges",necromancy_worker_lore:"Mindless, loyal, and tireless; skeletons are the perfect workers. Or they would be, if they didn't have a tendency to fall apart and need their bones replaced all the time. Either way, they are the backbone of your labor force and essential to the expansion of your domain.",necromancy_worker_upkeephint:"If you are unable to pay upkeep for all your workers, they will eventually fall apart and will need to be resummoned with your Raise Skeletal Drudge spell.",joblocation_wastelands:"Wastelands",joblocation_wastelands_lore:"The Buried Library sits at the center of a vast, rugged plain ravaged by countless ancient wars. It is a place of great solitude, but also great potential.",joblocation_forest:"Witchwood",joblocation_forest_lore:"The trees here are all twisted and pale, their roots stained with the blood of countless criminals who were executed here in centuries past, and the undergrowth teems with unknown, shadowy beasts.",joblocation_mines:"Spine Canyon",joblocation_mines_lore:"A deep gash cut into the land in a far corner of the wastelands. The high canyon walls keep most of the sunlight out, casting the area in a constant somber gloom.",joblocation_sanctum:"Inner Sanctum",joblocation_sanctum_lore:"The central column of the Buried Library, in which its vast treasure of tablets, tomes and scrolls are kept. There are also many side rooms that could be put to good use.",joblocation_courtyard:"Bailey",joblocation_courtyard_lore:"Immediately surrounding the library is this area, dedicated to the daily productive activities of your workers.",suffix_thousand:"K",suffix_million:"M",suffix_billion:"B",suffix_trillion:"T",suffix_quadrillion:"Q",suffix_persecond:"/s",suffix_hours:"h",suffix_minutes:"m",suffix_seconds:"s",generic_yes:"yes",generic_no:"no",generic_confirm:"confirm",generic_cancel:"cancel",generic_never:"never",generic_verysoon:"any second now",generic_saving:"Saving...",ui_settings:"Settings",ui_settings_description:"Change game settings, export/import saves, game reset, etc.",ui_settings_main:"Preferences",ui_settings_abstooltipvalues:'Show "Next Level" values in tooltips as total rather than difference from previous level',ui_settings_maxstorageinbar:"Show max storage in top bar",ui_settings_close:"Close",ui_settings_reset:"Reset Game",ui_settings_reset_description:'A <strong>Soft Reset</strong> will restart your game from the outset, keeping any permanent prestige rewards you have collected. A <strong>Hard Reset</strong> will erase ALL your progress as if you had never played this game before. To prevent his from being done accidentally, the Hard Reset button is disabled by default. To enable it, type the words "HARD RESET" in the text box below.',ui_settings_softreset:"Soft Reset",ui_settings_hardreset:"Hard Reset",ui_settings_export:"Export Save",ui_settings_export_description:"To export your savegame, simply press the export button and copy the text from the box. To import, paste then press the import button.",ui_settings_import_btn:"Import",ui_settings_export_btn:"Export",ui_prestige_youhavedied:"You Have Died",ui_prestigereset_phylactery:"The pain as the dagger pierces your heart is unbearable. Life ebbs quickly from your dying body. A brief moment of panic\u2014did the spell not work?\u2014but then, blessedly, the warm glow of the newly formed phylactery fills your vision just before your eyes close for the final time...",ui_prestigereset_invasion:"A victory cry rises from the forces of the insolent wretches invading your citadel as the last of your minions falls before their might. Desperate, you retreat towards the safety of your sanctum, but it is too late. From the throng emerges a heroic figure bearing a blessed blade; as it sinks into your chest and your undead body begins to crumble to dust, you spit out a dreadful curse, swearing that you will return and have your vengeance...",ui_prestigereset_soulassumption:"The ritual takes hours. The words come easily at first, the ancient spell-chant slow and methodical, but soon you feel the spell scratching, clawing at your soul as if trying to rip it open. The pain quickly grows unbearable even to your undead self, but you will yourself to accept it, and carry on. Finally, the spell breaks through, and for a moment it seems as if the howling stream of stolen souls is going to overtake you, but your phylactery hungrily devours every single morsel. At the apex where pain crosses over into radiant, searing splendor, you feel your mortal husk crumble to dust and ashes, as you knew it would... but those souls are now yours, truly and forever.",event_intro_header:"Nightmares",event_intro_text:"<p>You awake with a start, the air cold and the barren earth below you hard and dusty. Another nightmare. That's the only kind of dream you have now, cast out from your ancestral home by the jealous curs you used to call family into this pitiful exile. But the nightmares are showing you more than terrors: there is a promise of power hidden in those dreadful shadows, beckoning you deeper into the wasteland. After many days of wandering, the sight of a low stone spire jutting from the ground tells you that you have arrived.</p><p>Below the dead earth lies a treasure trove of arcane knowledge, ancient and long forgotten. Here, at the Buried Library, is where you will find the power to have your revenge on those who cast you out. Ironic, that their punishment would lead you to the tools of their undoing.</p>",event_intro_button:"The tomes beckon...",event_dying_header:"Decay",event_dying_text:"<p>Hastily, you push the grimoire aside and cover your mouth as another coughing fit overtakes you, palm stained by fine droplets of blood. It's not the first time. You can feel your body withering in this cold, lifeless place, so far from your rightful home. There is no doubt in your mind; you are dying, and you are nowhere close to the vengeance you deserve. All you have built will be for nothing if you simply waste away here. Something must be done.</p><p>The tomes speak of a means to preserve a living soul inside a magical device and prolong its lifespan indefinitely, but the details are vague, incomplete. For now, you must put aside thoughts of vengeance and focus on attaining the means to create such a device. Quickly, before your frail flesh is undone by consumption and rot.</p>",event_dying_button:"There's no time to waste",event_firstprestige_header:"Immortality",event_firstprestige_text:"<p>The last thing you remember is pain blooming from where the dagger impaled your heart, and immense cold as your life drained from your body. Now, you feel nothing \u2014 no pain, no fatigue, no hunger. You try to draw a deep breath to shake your senses awake, but can't, and to your combined horror and euphoria find that what was once pliant flesh is now little more than bones animated by the otherworldly energy emanating from your phylactery. Immortality is yours, but it has come at a steep cost: you are no longer human, but undead, and forever bound to the amulet that now holds your soul.</p><p>Exiting your inner sanctum, you realize a long time must have passed since your death. In your absence, what few beginnings of an empire you managed to build no longer stand and your drudges have long since crumbled to dust. What's more, your mind slips as it tries to remember the spells you once knew, and nothing comes to you. It seems you must learn anew, and rebuild what once stood, if you are to have your revenge \u2014 and if that revenge will have to be on the descendants of those who wronged you, then so be it.</p>",event_firstprestige_button:"I have all the time in the world",event_firstmilitaryvictory_header:"Darkness Descends",event_firstmilitaryvictory_text:"<p>What was once a small, yet flourishing hamlet is now nothing but a smoking ruin. Nothing lives here anymore, its erstwhile inhabitants either dead in the streets or else fled in panic. The only sound is the shrieking of the wind and clatter of bone on stone as your skeletal minions trawl through the remains in search of any useful spoils to bring back to the library. You have seen victory today, yet it feels... hollow. The soul essence you've ripped from the victims of your conquest should now be available for your own use, but your phylactery lies quiet and hungry. Something must be missing.</p><p>Gazing towards the horizon, you idly consider what the living are likely to do in reaction to your deeds. Nothing at first, you suppose, torn as they are by petty internal strife and politicking, but it is only a matter of time until they can no longer ignore you and will send armies in retaliation.</p>",event_firstmilitaryvictory_button:"I will be ready",event_firstkilledinbattle_header:"Bitter Glory",event_firstkilledinbattle_text:"<p>Your consciousness blooms out of the darkness once more, startling and raw. Trembling, you run your bony fingers across your ribcage, your skull; no trace remains of the terrible wound you were served by that searing hot blade. The central book storage of the library is as you remember it, curiously untouched by the hands of those killed you, but the same cannot be said for what lies outside. You have no way to know for sure how long has passed, nor whether these silent ruins are a result of the decay of long decades or the triumphant fury of the barbarians responsible for your bitter defeat.</p><p>As you prepare to start anew once more, a subtle sensation of renewed vigor comes to you. Peering into your phylactery, you sense renewed power within; it appears some of the ragged scraps of living souls you claimed in your previous life have integrated themselves into its swirling energies. While you cannot say you relish the thought of dying so painfully again, at least defeat has a certain ironic benefit to it...</p>",event_firstkilledinbattle_button:"Curious...",feat_prestige:"Immortal Unlife",feat_prestige_description:"Shed your mortal coil and ascend as an undying lich.",feat_militaryvictory:"Darkness Descends",feat_militaryvictory_description:"Successfully invade a settlement.",feat_killedinbattle:"Bitter Glory",feat_killedinbattle_description:"Die failing to defend the Buried Library from attack.",feat_tech100:"Technological Superiority",feat_tech100_description:"Reach level 100 in a single research topic.",feat_tech500:"Technological Domination",feat_tech500_description:"Reach level 500 in a single research topic.",feat_victories50:"Victor",feat_victories50_description:"Win 50 battles in a single incarnation.",feat_victories250:"Conqueror",feat_victories250_description:"Win 250 battles in a single incarnation.",ui_about_game:"Game by <a href='https://github.com/movexig'>movexig</a>. Most artwork from <a href='https://game-icons.net/'>game-icons.net</a> by Lorc, Delapouite and other contributors, used under <a href='https://creativecommons.org/licenses/by/3.0/'>CC BY 3.0</a>. <a href='https://github.com/pieroxy/lz-string'>LZ-String</a> by pieroxy.",ui_loading:"Loading, Please Wait",ui_alphatest:"This is an alpha-grade testing version of the game. Expect rampant problems, save incompatibility, and so forth."},It=Io;var me={x:40,y:65},z={x:48,y:48},Bt=19,kn="progresslich-settings",a;function pe(e){return It[e]!==void 0}function ee(e,...t){if(pe(e))return c(e,...t)}function c(e,...t){let r=It[e];if(r!==void 0){let n=r.indexOf("{");if(n<0)return r;{let o=0,i="";for(;;)if(n<0){i+=r.substr(o);break}else{if(i+=r.substr(o,n-o),o=r.indexOf("}",o),o<0)break;let s=r.substr(n+1,o-n-1).split(":");if(s.length<0)break;switch(s[0]){case"currency":i+=`<span class='Currency Currency${s[1].toUpperFirst()}'>${c("currency_"+s[1])}</span>`;break;case"income":let u=ee(`currency_${s[1]}_income`)??`${c(`currency_${s[1]}`)} ${c("tt_currency_income")}`;i+=`<span class='Currency Currency${s[1].toUpperFirst()}'>${u}</span>`;break;case"storage":let m=ee(`currency_${s[1]}_maxstorage`)??`${c(`currency_${s[1]}`)} ${c("tt_currency_storage")}`;i+=`<span class='Currency Currency${s[1].toUpperFirst()}'>${m}</span>`;break;case"building":i+=`<span class='Building'>${c("building_"+s[1])}</span>`;break;case"military":i+=`<span class='MilitaryUnit'>${c("military_"+s[1])}</span>`;break;case"spell":i+=`<span class='Spell'>${c("spell_"+s[1])}</span>`;break;default:let l=parseInt(s[0]);t[l]!==void 0&&(i+=t[l].toString());break}o++,n=r.indexOf("{",o)}return i}}else return e}function fe(e,t,r,n,o){let i=r?c("suffix_persecond"):"";for(let s of R){let u=t[s]??0;if(u!==0){let m=a.gameState.persistent.wallet[s]>=u,l=a.gameState.walletStorage[s]>=u,d=c(`currency_${s}`),w=`${q(u)}${i}`;n&&(le(s)&&!l?w=`<span class='MissingCurrencyStorage'>${w}</span>`:m||(w=`<span class='MissingCurrency'>${w}</span>`)),e.InformationLeftRight(`<span class='Currency Currency${s.toUpperFirst()}'>${d}</span>`,w,o)}}}function Q(e,t,r,n,o,i){let s=i!==0&&r.income!==void 0?r.income(i,a.gameState):{},u=i!==0&&r.storage!==void 0?r.storage(i,a.gameState):{},m=r.income!==void 0?r.income(n,a.gameState):{},l=r.storage!==void 0?r.storage(o,a.gameState):{};if(i===0){let p=`${t}_description`;pe(p)&&e.Information(c(p),"TechEffectText")}let d=i!==0&&r.modifiers!==void 0?r.modifiers(i,a.gameState):{},w=r.modifiers!==void 0?r.modifiers(n,a.gameState):{};for(let[p,h]of Object.entries(w))if(h!==0&&h!==d[p]){let x=`modifier_${p}`;if(pe(x)){let v=!a.settings.absoluteNextLevelTooltipValues&&d[p]?de(h-d[p]):de(h);e.Information(c(x,v),"TechEffectText")}}let f=i!==0&&r.multipliers!==void 0?r.multipliers(i,a.gameState):{},b=r.multipliers!==void 0?r.multipliers(n,a.gameState):{};for(let[p,h]of Object.entries(b))if(h!==0&&h!==f[p]){let x=`multiplier_${p}`;if(pe(x)||(x=`modifier_${p}`),pe(x)){let v=!a.settings.absoluteNextLevelTooltipValues&&f[p]?At(1+h-f[p]):At(h);e.Information(c(x,v),"TechEffectText")}}let _=i!==0&&r.recruit!==void 0?r.recruit(i,a.gameState):{},y=r.recruit!==void 0?r.recruit(n,a.gameState):{},S=!1;for(let[p,h]of Object.entries(y))if(h!==void 0){let[x,v]=h,[se,ye]=_[p]??[0,0],ge=Et(a.gameState,p);if(x!==0&&v!==0&&(ye==0||v!==ye)){let $n=`<span class='MilitaryUnit'>${c(`military_${p}`)}</span>`,Ke=`tt_military_recruit_${p}`;pe(Ke)||(Ke="tt_military_recruit");let Un=X(ge/x),Dn=q(v);e.Information(c(Ke,Dn,$n,Un),"TechEffectText"),S=!0}}for(let p of R){let h=l[p]??0;if(h!==0&&l[p]!==u[p]&&(r.hideStorage===void 0||!r.hideStorage.includes(p))){let v=ee(`currency_${p}_maxstorage`)??`${c(`currency_${p}`)} ${c("tt_currency_storage")}`,se=!a.settings.absoluteNextLevelTooltipValues&&u[p]?de(h-u[p]):de(h);e.Information(`<span class='Currency Currency${p.toUpperFirst()}'>${v}</span> ${se}`,"TechEffect")}let x=m[p]??0;if(x!==0&&m[p]!==s[p]&&(r.hideIncome===void 0||!r.hideIncome.includes(p))){let v=ee(`currency_${p}_income`)??`${c(`currency_${p}`)} ${c("tt_currency_income")}`,se=!a.settings.absoluteNextLevelTooltipValues&&s[p]?Z(x-s[p]):Z(x);e.Information(`<span class='Currency Currency${p.toUpperFirst()}'>${v}</span> ${se}`,"TechEffect")}}let F=i!==0&&r.upkeep!==void 0?r.upkeep(i,a.gameState):{},T=r.upkeep!==void 0?r.upkeep(n,a.gameState):{},G=!1;for(let p of R){let h=c("currency_"+p),x=T[p]??0,v=r.upkeepPerWorker!==void 0?r.upkeepPerWorker(n,a.gameState):{};if(x!==0&&T[p]!==F[p]&&(r.hideIncome===void 0||!r.hideIncome.includes(p))){G||(G=!0);let se=!a.settings.absoluteNextLevelTooltipValues&&F[p]?Z(-(x-F[p])):Z(-x),ye=`<span class='Currency Currency${p.toUpperFirst()}'>${h} ${c("tt_upkeep_trailer")}</span> ${se}`,ge=v[p];ge!==void 0&&(ye+=c("tt_upkeep_perworker",c(`joblocation_${ge}`),ge.toUpperFirst())),e.Information(ye,"TechEffect")}}S&&e.Information(c("tt_military_recruit_hint"),"Hint")}function Ao(e,t){for(let[r,n]of Object.entries(A))if(n.slot.x==e&&n.slot.y==t)return r}function Sn(e,t){let r=Math.floor(Bt/2),n={x:(e.x+r)*me.x,y:e.y*me.y},o={x:(t.x+r)*me.x,y:t.y*me.y},i=Math.min(n.x,o.x),s=Math.min(n.y,o.y),u=Math.max(n.x,o.x)-i+z.x,m=Math.max(n.y,o.y)-s+z.y,l=document.createElementNS("http://www.w3.org/2000/svg","svg");l.classList.add("TechTreeLine"),l.setAttributeNS(null,"viewBox",`${i} ${s} ${u} ${m}`),l.setAttributeNS(null,"width",`${u}`),l.setAttributeNS(null,"height",`${m}`),l.style.left=`${i}px`,l.style.top=`${s}px`;let d="";if(t.y>e.y){let f={x:n.x+z.x/2,y:n.y+z.y},b={x:o.x+z.x/2,y:o.y},_=t.x>e.x?1:-1;if(d+=`M ${b.x},${b.y} `,e.x!=t.x){let y=!0;for(let S=e.y+1;S<t.y;++S)if(Ao(t.x,S)!==void 0){y=!1;break}y?d+=`L ${b.x},${f.y+12} `:d+="l 0,-2 ",d+=`q 0,-6 ${-6*_},-6 `,d+=`l ${f.x-b.x+12*_},0 `,d+=`q ${-6*_},0 ${-6*_},-6 `}d+=`L ${f.x},${f.y} `}else t.x>e.x?(d+=`M ${n.x+z.x},${n.y+z.y/2} `,d+=`L ${o.x},${o.y+z.y/2} `):(d+=`M ${n.x},${n.y+z.y/2} `,d+=`L ${o.x+z.x},${o.y+z.y/2} `);return l.appendChild(document.createElementNS("http://www.w3.org/2000/svg","path")).setAttributeNS(null,"d",d),l}function Bo(){let e=C("#TechTreeLines");if(e!==null)for(let[t,r]of Object.entries(a.techs)){let n=A[t];if(n.requires!==void 0)for(let o of Object.keys(n.requires)){let i=Math.abs(A[o].slot.x-n.slot.x),s=Math.abs(A[o].slot.y-n.slot.y);if((i<=3||s==1)&&s<=4){let u=Sn(A[o].slot,n.slot);e.appendChild(u),r.treeLines[o]=u}}}}function Fo(){let e=C("#PrestigeTreeLines");if(e!==null)for(let[t,r]of Object.entries(a.prestigeUpgrades)){let n=$[t];if(n.requires!==void 0)for(let o of n.requires){let i=Sn($[o].slot,n.slot);i!==null&&(e.appendChild(i),r.treeLines[o]=i)}}}function Po(e){let t=A[e],r=C("#TechTreeNodes");if(r===null)return null;for(;a.techRows.length<=t.slot.y;)a.techRows.push(r.appendChild(document.createElement("div")));let n=a.techRows[t.slot.y],o=Math.floor(Bt/2),i=H(n,"TechnologyTemplate",`Technology${e}`);if(i===null)throw new Error("Failed to create tech panel from template");i.style.backgroundImage="url('images/tech/"+t.icon+".svg')",i.style.left=`${(t.slot.x+o)*me.x}px`;let s=g(i,".Left"),u=g(i,".Right"),m=g(i,".Level");return a.techs[e]={slot:i,progressLeft:s,progressRight:u,level:m,treeLines:{}},i.addEventListener("click",()=>{Tt(a.gameState,e)}),E(i,"right",l=>{l.Header(c(`tech_${e}`)),l.Lore(c(`tech_${e}_lore`)),l.Separator();let d=a.gameState.persistent.techLevels[e]??0,w=t.maxLevel!==void 0&&d>=t.maxLevel,f=d+1;if(d>0&&(t.maxLevel===1?l.Information(c("tt_tech_researched"),"TechEffectHeader"):t.maxLevel!==void 0?l.Information(c("tt_tech_researched_level_max",d,t.maxLevel??0),"TechEffectHeader"):l.Information(c("tt_tech_researched_level",d),"TechEffectHeader"),Q(l,`tech_${e}`,t,d,d,0)),!w){d>0&&l.Separator();let b=a.gameState.techTargetChoked&&a.gameState.persistent.techTarget===e,_=a.gameState.income.research??0,y=a.gameState.persistent.techProgress[e]??0,S=Se(e,d),F=_==0?c("generic_never"):X((S-y)/_),T=c("tt_tech_researchcost_progress",q(y),q(S),b?"?":F),G=gt(a.gameState,e,d);if(G!==void 0)for(let h of R){let x=G[h];x!==void 0&&(G[h]=x*(1-y/S))}let p=!0;if(t.requires!==void 0){for(let[h,x]of Object.entries(t.requires))if(a.gameState.persistent.techLevels[h]<x){p=!1;let v=c("tech_"+h);x==1?l.Information(c("tt_tech_requires",v,x),"Prerequisite"):l.Information(c("tt_tech_requires_level",v,x),"Prerequisite")}}if(t.requiresVictories!==void 0){let h=t.requiresVictories(d+1,a.gameState);a.gameState.persistent.warTargetVictories<h&&(l.Information(c("tt_tech_requires_victories",h),"Prerequisite"),p=!1)}t.specialRequires!==void 0&&(t.specialRequires(d+1,a.gameState)||(l.Information(c(`tech_${e}_specialreq`),"Prerequisite"),p=!1)),p&&(d==0?(l.Information(c("tt_tech_notresearched"),"TechNotResearched"),l.Separator(),l.Information(c("tt_tech_whenresearched"),"TechEffectHeader")):l.Information(c("tt_tech_nextlevel"),"TechEffectHeader"),Q(l,`tech_${e}`,t,f,f,d),l.Separator(),G!==void 0&&fe(l,G,!1,!1),l.InformationLeftRight(c("tt_tech_researchcost"),T,"TechResearch"),b&&l.Information(c("tt_tech_choked"),"Warning"))}}),i}function Cn(){let e=0;for(let[t,r]of Object.entries(A))a.gameState.hiddenTech[t]!==!0&&(e=Math.max(e,r.slot.y));for(let t=0;t<a.techRows.length;++t)k(a.techRows[t],"Hidden",t>e)}function Tn(e){let t=a.gameState,r=a.prestigeUpgrades[e];if(r!==void 0){let n=t.persistent.prestige[e]===!0,o=!dn(a.gameState,e);k(r.slot,"Locked",o),k(r.slot,"Purchased",n);for(let i of Object.values(r.treeLines))k(i,"Locked",o&&!n)}}function Wo(e){let t=$[e],r=C("#PrestigeTreeNodes");if(r===null)return null;for(;a.prestigeRows.length<=t.slot.y;)a.prestigeRows.push(r.appendChild(document.createElement("div")));let n=a.prestigeRows[t.slot.y],o=Math.floor(Bt/2),i=H(n,"PrestigeUpgradeTemplate",`Prestige${e}`);return i===null?null:(i.style.backgroundImage=`url('images/tech/${t.icon}.svg')`,i.style.left=`${(t.slot.x+o)*me.x}px`,a.prestigeUpgrades[e]={slot:i,treeLines:{}},i.addEventListener("click",()=>{un(a.gameState,e),Tn(e)}),E(i,"right",s=>{if(s.Header(c(`prestige_${e}`)),s.Lore(c(`prestige_${e}_lore`)),s.Separator(),a.gameState.persistent.prestige[e]===!0?(s.Information(c("tt_prestige_purchased"),"TechEffectHeader"),Q(s,`prestige_${e}`,t,1,1,0)):(s.Information(c("tt_prestige_notpurchased"),"TechNotResearched"),s.Separator(),s.Information(c("tt_prestige_whenpurchased"),"TechEffectHeader"),Q(s,`prestige_${e}`,t,1,1,0),t.cost.prestige!==void 0&&(s.Separator(),fe(s,t.cost,!1,!0))),t.requires!==void 0)for(let u of t.requires)a.gameState.persistent.prestige[u]!==!0&&s.Information(c("tt_tech_requires",c(`prestige_${u}`)),"Prerequisite")}),Tn(e),i)}function qo(e){let t=U[e],r=C("#SpellList");if(r===null)return;let n=H(r,"SpellButtonTemplate",`Spell${e.toUpperFirst()}`);if(n===null)return;let o=g(n,".SpellButtonButton"),i=C(n,"img");i.src=`images/tech/${t.icon}.svg`;let s=g(n,"h1");s.textContent=c(`spell_${e}`);let u={slot:n,metamagicLevel:g(n,".Level"),metamagicUp:g(n,".Up"),metamagicDown:g(n,".Down"),durationLeft:g(n,".DurationFill.Left"),durationRight:g(n,".DurationFill.Right")};a.spells[e]=u,t.metamagic===!0&&(u.metamagicUp.addEventListener("click",m=>{let l=a.gameState.modifiers.metamagic_level??0;a.gameState.persistent.metamagicLevel[e]=Math.min((a.gameState.persistent.metamagicLevel[e]??0)+1,l),m.stopPropagation(),Ve(e)}),u.metamagicDown.addEventListener("click",m=>{a.gameState.persistent.metamagicLevel[e]=Math.max((a.gameState.persistent.metamagicLevel[e]??0)-1,0),m.stopPropagation(),Ve(e)})),E(n,"right",m=>{let l=1+(a.gameState.persistent.metamagicLevel[e]??0);if(l>1?m.Header(c(`spell_${e}`)+" "+Ne(l)):m.Header(c(`spell_${e}`)),m.Lore(c(`spell_${e}_lore`)),m.Separator(),t.duration!==void 0){let d=t.duration(l,a.gameState),w,f=a.gameState.persistent.activeSpellEffects;f[e]!==void 0?(w=f[e].level,m.Information(c("tt_spell_activeduration",X(f[e].durationLeft)),"SpellEffectHeader"),Q(m,`spell_${e}`,t,w,w,0)):m.Information(c("tt_spell_notactive"),"SpellNotActive"),m.Separator(),w===l?m.Information(c("tt_spell_castextend",X(d)),"SpellEffectHeader"):(m.Information(c("tt_spell_castnew",X(d)),"SpellEffectHeader"),Q(m,`spell_${e}`,t,l,l,0))}else m.Information(c(`spell_${e}_description`));if(m.Separator(),fe(m,ze(a.gameState,e,l),!1,!0),t.checkCastable!==void 0){let d=t.checkCastable(l,a.gameState);d!==!0&&m.Information(c(d),"Prerequisite")}m.Information(c("tt_spell_multicast_hint"),"Hint")}),o.addEventListener("click",m=>{let l=m.ctrlKey?5:1;for(;l>0;--l)xe(a.gameState,e)?Lt(a.gameState,e):mn(a.gameState,e)})}function Mn(e){let t=a.spells[e];if(t===void 0)return;let r=a.gameState,n=U[e],o=r.persistent.activeSpellEffects;k(t.slot,"Visible",xt(r,e)),k(t.slot,"Castable",xe(r,e)),k(t.slot,"HasDuration",o[e]!==void 0),o[e]!==void 0&&o[e].duration>0&&xn(t.durationLeft,t.durationRight,o[e].durationLeft/o[e].duration),k(t.slot,"Metamagic",(r.modifiers.metamagic_level??0)>0&&n.metamagic===!0),t.metamagicLevel.textContent=Ne(1+(r.persistent.metamagicLevel[e]??0))}function Ve(e){Mn(e),Qe()}function Ln(){let e=0;k(a.spellQueue.container,"Hidden",a.gameState.enabledFeatures.spell_queue!==!0);for(let t of a.gameState.persistent.spellQueue){let r=e,n=t.spell,o=U[n];if(a.spellQueue.spells.length<=e){let s=H(a.spellQueue.container,"QueuedSpellTemplate");if(s===null)throw new Error("Failed to create spell queue entry from template");a.spellQueue.spells.push({icon:s,count:g(s,".Count")}),s.addEventListener("click",u=>{Mt(a.gameState,r,u.shiftKey)})}let i=a.spellQueue.spells[e];i.icon.classList.remove("Hidden"),i.icon.style.backgroundImage=`url("images/tech/${o.icon}.svg")`,i.count.innerText=t.count.toString(),k(i.icon,"NoCount",t.count<2),E(i.icon,"top",s=>{let u=a.gameState.persistent.spellQueue[r].level;u>1?s.Header(c(`spell_${n}`)+" "+Ne(u)):s.Header(c(`spell_${n}`)),s.Lore(c(`spell_${n}_lore`)),s.Separator(),s.Information(c("tt_spell_queue_help"))}),++e}for(;e<a.spellQueue.spells.length;++e)a.spellQueue.spells[e].icon.classList.add("Hidden")}function Gn(){for(let e of Object.keys(a.spells))Mn(e);Ln(),Qe()}function Rn(){let e=a.gameState,t=a.techTarget!==void 0?a.techs[a.techTarget]?.slot:void 0,r=e.persistent.techTarget!==void 0?a.techs[e.persistent.techTarget]?.slot:void 0;t!==r&&(t?.classList.remove("Researching"),t?.classList.remove("Choked"),r?.classList.add("Researching")),Qe(),a.techTarget=e.persistent.techTarget}function Ge(){for(let e of Object.keys(a.techs))Ft(e);Qe(),Cn()}function xn(e,t,r){r==0?(e.style.visibility="hidden",t.style.visibility="hidden"):r<.5?(e.style.visibility="hidden",t.style.visibility="visible",t.style.transform=`rotate(${(r/.5-1)*180}deg)`):(e.style.visibility="visible",t.style.visibility="visible",e.style.transform=`rotate(${((r-.5)/.5-1)*180}deg)`,t.style.transform="rotate(0deg)")}function Ft(e){let t=a.gameState,r=a.techs[e];if(r!==void 0){let n=A[e],o=(t.persistent.techProgress[e]??0)/Se(e,t.persistent.techLevels[e]??0),i=t.persistent.techLevels[e],s=t.hiddenTech[e]===!0;xn(r.progressLeft,r.progressRight,o);let u=!Ct(t,e);k(r.slot,"Locked",u),k(r.slot,"MaxLevel1",n.maxLevel==1),k(r.slot,"MaxLevel",n.maxLevel!==void 0&&i>=n.maxLevel),k(r.slot,"Researched",i>0),k(r.slot,"Researching",e===t.persistent.techTarget),k(r.slot,"Choked",e===t.persistent.techTarget&&t.techTargetChoked),k(r.slot,"Hidden",s);for(let m of Object.values(r.treeLines))k(m,"Locked",u&&i==0),k(m,"Hidden",s);n.maxLevel==1?r.level.textContent="":r.level.textContent=i.toString()}}function En(...e){for(let[t,r]of e)t.addEventListener("click",()=>{for(let[n,o]of e)k(n,"InactiveTab",n!==t),k(o,"InactiveTabContent",o!==r)});if(e.length>1)for(let[t,r]of e)k(t,"InactiveTab",t!==e[0][0]),k(r,"InactiveTabContent",r!==e[0][1])}function Ho(){let e=C("#TechTabButton"),t=C("#PrestigeTabButton"),r=C("#RecordsTabButton");if(e&&t&&r){let n=C("#Technologies"),o=C("#PrestigeUpgrades"),i=C("#Records");n&&o&&i&&En([e,n],[t,o],[r,i]),E(e,"bottom",s=>{s.Header(c("tt_tab_tech")),s.Information(c("tt_tab_tech_description"))}),E(t,"bottom",s=>{s.Header(c("tt_tab_prestige")),s.Information(c("tt_tab_prestige_description"))}),E(r,"bottom",s=>{s.Header(c("tt_tab_records")),s.Information(c("tt_tab_records_description"))})}}function qr(e){let t=g("#ActiveBattle"),r=g("#BattleResult"),n=g("#Invaders"),o=g("#InvaderAnger"),i=g("#PlayerFortStrength");te(g("#MainContent")),te(g("#AlphaTest")),a={gameState:e,settings:Yo(),tooltipHandlers:new WeakMap,currencies:{},techRows:[],techs:{},spells:{},spellQueue:{container:g("#SpellQueue"),spells:[]},domain:{},idleWorkers:g("#IdleWorkers"),prestigeRows:[],prestigeUpgrades:{},prestigePopup:g("#PrestigeDeathPopup"),prestigeMessage:g("#PrestigeMessage"),militaryUnits:{},deployMilitary:{units:{},container:g("#ArmyDeployment"),cost:g("#ArmyDeploymentCost"),warTargetsContainer:g("#WarTargets"),warTargets:[]},activeBattle:{container:t,title:g(t,".BattleName"),fortPlayer:g(t,".PlayerFort"),fortEnemy:g(t,".EnemyFort"),frontlines:[],retreat:g(t,".RetreatButton")},playerFortStrength:{container:i,fill:g(i,".BarFill"),text:g(i,".BarText")},invaders:{container:n,army:g(n,".ArmyList"),countdown:g(n,".Countdown")},invaderAnger:{container:o,barFill:g(o,".BarFill")},battleResults:{container:r,name:g(r,".BattleName"),casualties:g(r,".BattleResultCasualties"),spoils:g(r,".BattleResultSpoils")},records:{feats:{}},settingsCheckboxes:{}};let s=C("#LoadingScreen");s&&(s.textContent=c("ui_loading")),V(e)&&document.body.classList.add("PrestigeEnabled"),Ho(),Oo(),E(a.idleWorkers,"bottom",d=>{let w=Re[e.persistent.culture];d.Header(c(`${w.workerName}_plural`)),d.Lore(c(`${w.workerName}_lore`)),d.Separator(),d.Information(c("worker_description")),d.Separator(),d.Information(c("tt_upkeep_allworkers"),"UpkeepHeader"),fe(d,w.workerUpkeep(a.gameState),!0,!1),d.Information(c(`${w.workerName}_upkeephint`),"Hint")});let u=C("#CurrenciesBar");if(u!==null)for(let d of R){let w=`Currency${d.toUpperFirst()}`,f=H(u,"CurrencyBarTemplate",w);if(f){f.classList.add(w);let b=g(f,".Current"),_=g(f,".Income");a.currencies[d]={parent:f,current:b,income:_},E(f,"bottom",y=>{y.Header(c(`currency_${d}`)),y.Lore(c(`currency_${d}_lore`)),y.Separator();let S=ee(`currency_${d}_description`);if(S!==void 0&&(y.Information(S),y.Separator()),le(d)){if(ke(d)){let F=ee(`currency_${d}_storage`)??c("tt_currency_storage");y.Information(`<span class='Currency Currency${d.toUpperFirst()}'>${F}:</span> ${q(e.persistent.wallet[d])} / ${q(e.walletStorage[d])}`)}}else{let F=ee(`currency_${d}_storage`)??c("tt_currency_storage");y.Information(`<span class='Currency Currency${d.toUpperFirst()}'>${F}:</span> ${q(e.persistent.wallet[d])}`)}if(yt(d)){let F=ee(`currency_${d}_income`)??c("tt_currency_income");y.Information(`<span class='Currency Currency${d.toUpperFirst()}'>${F}:</span> ${Z(e.income[d]??0)}`)}})}}for(let d of Object.keys(A))Po(d);Bo();for(let d of Object.keys($))Wo(d);Fo();for(let d of Object.keys(A))Ft(d);for(let d of Object.keys(U))qo(d),Ve(d);E(a.spellQueue.container,"top",d=>{d.Header(c("tt_spell_queue")),d.Separator(),d.Information(c("tt_spell_queue_description"))});let m=C("#SaveIndicator");m!==null&&(m.textContent=c("generic_saving")),Qo(),zo(),Uo(),jo(),C("#PrestigeReviveButton")?.addEventListener("click",()=>{Or(a.gameState)}),te(a.prestigePopup);let l=a.gameState.events;l.ticked.listen(An),l.techLevelsChanged.listen(()=>{Ge(),Gn()}),l.techTargetChanged.listen(()=>{Rn()}),l.spellCast.listen(d=>{Ve(d)}),l.battleEnded.listen((d,w,f,b)=>{Do(d,w,f,b),Pt(),Wt(),Ge()}),l.buildingCountChanged.listen(()=>{In(),Ge()}),l.standingArmyChanged.listen(()=>{qt(),Ge()}),l.workersChanged.listen(()=>{$o(),Ge()}),l.spellQueueChanged.listen(Ln),l.warTargetsChanged.listen(()=>{Pt(),qt()}),l.storyEventTriggered.listen(No),l.prestigeResetTriggered.listen(Vo),l.invasionBegan.listen(Wt),l.featAchieved.listen(Ht),l.prestigeUpgradesChanged.listen(Ht),An(),Rn(),Pt(),Cn()}function Bn(e){let t=a.gameState,r=t.persistent.activeWorkers[e],n=t.persistent.assignedWorkers[e],o=a.domain[e];o!==void 0&&(o.workerAssignmentText.textContent=`${r} / ${n}`,a.idleWorkers.textContent=t.persistent.activeWorkers.idle.toString())}function $o(){for(let e of D)Bn(e)}function $t(e,t,r){e.textContent="";for(let[n,o]of Object.entries(t)){let i=P[n],s=H(e,"SmallMilitaryUnitTemplate");if(s===null)throw new Error("Failed to create defender template instance");let u=g(s,".Icon");u.style.backgroundImage=`url("images/military/${i.icon}.svg")`;let m=g(s,".Text");if(r){let l=o;o<100?l=Math.max(1,Math.round(o/10))*10:l=Math.max(1,Math.round(o/25))*25,m.innerHTML=`&#8764;${q(l)}`}else m.innerHTML=`${q(o)}`;E(s,"left",l=>Ye(n,l))}}function Pt(){for(let e=0;e<ne;++e){let t=a.gameState.warTargets[e];a.deployMilitary.warTargets[e].name.textContent=t.name;let r=c(`wartarget_${t.culture}`),n=c("wartarget_village"),o=c("ui_wartarget_population",q(t.population));a.deployMilitary.warTargets[e].population.textContent=`${r} ${n}, ${o}`,$t(a.deployMilitary.warTargets[e].defenders,a.gameState.warTargets[e].defenders,!0);for(let i of Object.keys(t.features))if(Vr(a.gameState,i)){let s=a.deployMilitary.warTargets[e].defenders.appendChild(document.createElement("div"));s.classList.add("WarTargetFeature"),s.style.backgroundImage=`url('images/warfeature/${i}.svg')`,E(s,"left",u=>{u.Header(c(`tt_warfeature_${i}`)),u.Information(c(`tt_warfeature_${i}_description`))})}}}function Je(e,t){t?(e.classList.add("HasUnit"),k(e,"Casualties",t.casualties>0),e.style.backgroundImage=`url("images/military/${P[t.unit].icon}.svg")`,g(e,".Count").textContent=t.count.toString(),E(e,"left",r=>Ye(t.unit,r))):(e.classList.remove("HasUnit"),e.classList.remove("Casualties"),e.style.backgroundImage="none",Fn(e))}function Wt(){a.invaders.army.innerHTML="",a.gameState.persistent.invaders!==void 0&&$t(a.invaders.army,a.gameState.persistent.invaders.army,!0)}function Pn(e,t){t.fortificationsMax<=0?e.classList.add("Hidden"):(e.classList.remove("Hidden"),e.textContent=(100*t.fortifications/t.fortificationsMax).toFixed(0)+"%")}function he(){let e=Ue(a.gameState),t=!Dr(e);k(a.deployMilitary.cost,"NoCost",!t),t?(a.deployMilitary.cost.innerHTML="",Wn(a.deployMilitary.cost,e)):a.deployMilitary.cost.innerHTML="-";for(let[r,n]of Object.entries(a.deployMilitary.units))if(n!==void 0){let o=(a.gameState.persistent.militaryDeployment[r]??0)>(a.gameState.persistent.military[r]??0);k(n.slot,"Overassigned",o)}}function qt(){let e=a.gameState;for(let[t,r]of Object.entries(a.militaryUnits))r&&(r.count.textContent=(a.gameState.persistent.military[t]??0).toFixed(0),k(r.slot,"Hidden",e.enabledFeatures[`military_${t}`]!==!0),k(r.slot,"CanToggleRecruitment",ue(e,t)),k(r.slot,"Recruiting",Le(e,t)));for(let[t,r]of Object.entries(a.deployMilitary.units))r&&(r.count.textContent=(a.gameState.persistent.militaryDeployment[t]??0).toFixed(0),k(r.slot,"Hidden",e.enabledFeatures[`military_${t}`]!==!0));if((e.modifiers.fortifications??0)>0){let t=Math.floor((1-e.persistent.fortDamage/e.modifiers.fortifications)*100);a.playerFortStrength.container.classList.remove("Hidden"),a.playerFortStrength.fill.style.width=`${t}%`,a.playerFortStrength.text.innerText=`${q(Math.ceil(e.modifiers.fortifications-e.persistent.fortDamage))} / ${q(e.modifiers.fortifications)}`}else a.playerFortStrength.container.classList.add("Hidden");if(e.persistent.battle!==void 0){let t=e.persistent.battle,r=t.player.frontRank.length;a.deployMilitary.warTargetsContainer.classList.add("Hidden"),a.deployMilitary.container.classList.add("Hidden"),a.activeBattle.container.classList.remove("Hidden"),a.battleResults.container.classList.remove("Visible"),k(a.activeBattle.container,"Defensive",e.persistent.battle.warTargetIndex===void 0),t.warTargetIndex!==void 0?a.activeBattle.title.textContent=c("ui_wartargetbattle_title",e.warTargets[t.warTargetIndex].name):a.activeBattle.title.textContent=c("ui_defensebattle_title"),Pn(a.activeBattle.fortPlayer,t.player),Pn(a.activeBattle.fortEnemy,t.enemy);for(let n=0;n<r;++n){let o=a.activeBattle.frontlines[n];Je(o.playerBack,t.player.backRank[n]),Je(o.playerFront,t.player.frontRank[n]),Je(o.enemyFront,t.enemy.frontRank[n]),Je(o.enemyBack,t.enemy.backRank[n]),k(o.container,"Empty",t.player.backRank[n]==null&&t.player.frontRank[n]==null&&t.enemy.backRank[n]==null&&t.enemy.frontRank[n]==null);let i=t.player.frontRank[n]?.attackDirection??t.player.backRank[n]?.attackDirection,s=t.enemy.frontRank[n]?.attackDirection??t.enemy.backRank[n]?.attackDirection,u=i===0||s===0,m=i===void 0&&s===void 0;k(o.interaction,"None",m),k(o.interaction,"Clash",u&&!m),k(o.interaction,"Flank",!u&&!m),!u&&!m&&(k(o.interaction,"AttackerRight",i!==void 0&&i>0),k(o.interaction,"AttackerLeft",i!==void 0&&i<0),k(o.interaction,"DefenderRight",s!==void 0&&s>0),k(o.interaction,"DefenderLeft",s!==void 0&&s<0))}}else a.deployMilitary.warTargetsContainer.classList.remove("Hidden"),a.deployMilitary.container.classList.remove("Hidden"),a.activeBattle.container.classList.add("Hidden");a.gameState.persistent.invaders!==void 0?(a.invaders.countdown.textContent=c("ui_invaders_countdown")+X(Math.ceil(a.gameState.persistent.invaders.countdown)),k(a.invaders.container,"Hidden",je(a.gameState))):a.invaders.container.classList.add("Hidden"),k(a.invaderAnger.container,"Hidden",a.gameState.persistent.invaderAnger<=0),a.invaderAnger.barFill.style.width=`${(a.gameState.persistent.invaderAnger*100).toFixed(0)}%`,he()}function In(){for(let[e,t]of Object.entries(a.domain))if(t!==void 0){k(t.location,"Visible",a.gameState.enabledFeatures[e]===!0),k(t.workerAssignments,"Visible",a.gameState.enabledFeatures[`job_${e}`]===!0);for(let[r,n]of Object.entries(t.buildingSlots)){let o=Me(a.gameState,r);k(n.slot,"Hidden",!o),k(n.slot,"Affordable",pn(a.gameState,r));let i=a.gameState.persistent.disabledBuildings[r]??0;n.level.textContent=((a.gameState.persistent.buildingLevels[r]??0)-i).toString(),k(n.slot,"SomeDisabled",i>0)}}}function Uo(){let e=C("#DomainLocations");if(e===null)return;for(let n of D){if(n=="idle")continue;let o=H(e,"DomainLocationTemplate",`Domain${n.toUpperFirst()}`);if(o===null)throw new Error("Failed to create domain template instance");let i=g(o,".LocationName"),s=g(o,".WorkerAssignments"),u=g(o,".Buildings"),m=g(s,".Allocation");i.textContent=c(`joblocation_${n}`),E(i,"left",l=>{l.Header(c(`joblocation_${n}`)),l.Lore(c(`joblocation_${n}_lore`))}),E(s,"left",l=>{l.Header(c("tt_joballocator")),l.Information(c("tt_joballocator_description"))}),C(s,".Up")?.addEventListener("click",()=>Gt(a.gameState,n,1)),C(s,".Down")?.addEventListener("click",()=>Gt(a.gameState,n,-1)),a.domain[n]={location:o,workerAssignments:s,workerAssignmentText:m,buildingSlots:{}};for(let[l,d]of Object.entries(O))if(d.location==n){let w=H(u,"DomainBuildingTemplate",`Building${l.toUpperFirst()}`);if(w===null)continue;d.upkeep!==void 0&&w.classList.add("HasUpkeep");let f=C(w,"img");f.src=`images/building/${d.icon}.svg`;let b=g(w,".Level");E(w,"left",_=>{if(Me(a.gameState,l)){let y=a.gameState.persistent.buildingLevels[l],S=a.gameState.persistent.disabledBuildings[l];_.Header(c(`building_${l}`)),_.Lore(c(`building_${l}_lore`)),y-S>0?(_.Separator(),S>0?_.Information(c("tt_building_levelpartial",y,y-S),"TechEffectHeader"):_.Information(c("tt_building_level",y),"TechEffectHeader"),Q(_,`building_${l}`,d,y-S,y,0)):y>0&&S==y&&(_.Separator(),_.Information(c("tt_building_levelalldisabled",y),"TechEffectHeader"),Q(_,`building_${l}`,d,0,y,0)),_.Separator(),_.Information(c("tt_building_nextlevel"),"TechEffectHeader"),Q(_,`building_${l}`,d,y+1,y+1,y),_.Separator(),fe(_,d.cost(y,a.gameState),!1,!0),d.upkeep!==void 0&&_.Information(c("tt_upkeep_hint"),"Hint"),_.Information(c("tt_building_multibuild_hint"),"Hint")}else _.Header(c("tt_emptybuilding")),_.Information(c("tt_emptybuilding_description"))}),f.addEventListener("click",_=>{let y=_.ctrlKey?5:1;for(;y>0;--y)fn(a.gameState,l)}),C(w,".Up")?.addEventListener("click",()=>{Rt(a.gameState,l,1)}),C(w,".Down")?.addEventListener("click",()=>{Rt(a.gameState,l,-1)}),a.domain[n].buildingSlots[l]={slot:w,level:b}}Bn(n)}let t=C("#DomainTabButton"),r=C("#MilitaryTabButton");if(t!==null&&r!==null){let n=C("#Domain"),o=C("#Military");n!==null&&o!==null&&En([t,n],[r,o]),E(t,"bottom",i=>{i.Header(c("tt_tab_domain")),i.Information(c("tt_tab_domain_description"))}),E(r,"bottom",i=>{i.Header(c("tt_tab_military")),i.Information(c("tt_tab_military_description"))})}}function Wn(e,t){for(let r of R){let n=t[r];if(n!==void 0&&n>0){let o=e.appendChild(document.createElement("span"));o.classList.add("Currency"),o.classList.add(`Currency${r.toUpperFirst()}`),o.textContent=q(n)+" ",E(o,"left",i=>{i.Header(c(`currency_${r}`)),i.Lore(c(`currency_${r}_lore`))})}}}function Ye(e,t){let r=P[e],n=a.gameState;if(t.Header(c(`military_${e}`)),t.Lore(c(`military_${e}_lore`)),t.Separator(),t.Information(c(`tt_militaryclass_${r.unitClass}`)),t.Information(`<span class="MilitarySkill StatBlock">${c("tt_military_skill")}</span> ${r.skill(n).toString()}`),t.Information(`<span class="MilitaryAttack StatBlock">${c("tt_military_attack")}</span> ${r.attack(n).toString()}`),t.Information(`<span class="MilitaryDefense StatBlock">${c("tt_military_defense")}</span> ${r.defense(n).toString()}`),t.Information(c("tt_military_stats_hint"),"Hint"),r.abilities!==void 0){let o=!1;for(let[i,s]of Object.entries(r.abilities(n)))if(s!==void 0&&s>0){o===!1&&(o=!0,t.Separator());let u=c(`militaryability_${i}`),m=c(`militaryability_${i}_description`);t.Information(`<span class="MilitaryAbility">${u}</span> &mdash; ${m}`)}}}function Do(e,t,r,n){k(a.battleResults.container,"Victory",e),k(a.battleResults.container,"Visible",!0),k(a.battleResults.container,"NoCasualties",Object.keys(r).length==0),k(a.battleResults.container,"NoSpoils",Object.keys(n).length==0);let o=t?.name??c("ui_defensebattle_title"),i=c(e?"ui_battleresult_victory":"ui_battleresult_defeat",o);a.battleResults.name.textContent=i,a.battleResults.casualties.innerHTML="",a.battleResults.spoils.innerHTML="",$t(a.battleResults.casualties,r,!1),Wn(a.battleResults.spoils,n),e?E(a.battleResults.name,"left",s=>{s.Header(i),s.Lore(c("ui_battleresult_victory_lore"))}):E(a.battleResults.name,"left",s=>{s.Header(i),s.Lore(c("ui_battleresult_defeat_lore"))})}function jo(){let e=C("#PlayerStandingArmy");if(e===null)return;let t=C("#ArmyDeploymentUnits");if(t===null)return;E(e,"left",n=>{n.Header(c("tt_standingarmy_header")),n.Lore(c("tt_standingarmy_lore")),n.Separator(),n.Information(c("tt_standingarmy_description"))});for(let n=0;n<ne;++n){let o=H(a.deployMilitary.warTargetsContainer,"WarTarget");if(o===null)throw new Error("Failed to create war target template instance");te(o);let i={container:o,name:g(o,".CityName"),defenders:g(o,".ArmyList"),population:g(o,".CityPopulation")};a.deployMilitary.warTargets.push(i),E(i.container,"left",s=>{s.Header(c("tt_wartarget_assault")),s.Lore(c("tt_wartarget_lore")),s.Separator();let u=kt(a.gameState,a.gameState.warTargets[n]);u===!0?s.Information(c("tt_wartarget_assault_description")):s.Information(c(`tt_wartarget_cannotassault_${u}`),"Prerequisite")}),i.container.addEventListener("click",()=>{Zr(a.gameState,n)})}E(a.invaders.container,"left",n=>{n.Header(c("tt_invaders_header")),n.Lore(c("tt_invaders_lore")),n.Separator(),n.Information(c("tt_invaders_description")),n.Information(c("tt_invaders_prestige"))}),E(a.invaderAnger.container,"left",n=>{n.Header(c("tt_invaderanger_header")),n.Lore(c("tt_invaderanger_lore")),n.Separator(),n.Information(c("tt_invaderanger_description")),n.Separator(),n.InformationLeftRight(c("tt_invaderanger_chance"),`${(wt(a.gameState)*100).toFixed(1)}%`)}),te(a.activeBattle.container),te(a.battleResults.container);for(let[n,o]of Object.entries(P)){{let i=H(e,"StandingArmyUnitTemplate",`MilitaryUnit${n.toUpperFirst()}`);if(i===null)throw new Error("Failed to create military unit template instance");a.militaryUnits[n]={slot:i,count:g(i,".Count")},g(i,".Portrait").style.backgroundImage=`url("images/military/${o.icon}.svg")`,E(i,"left",s=>{if(Ye(n,s),ue(a.gameState,n))if(s.Separator(),Le(a.gameState,n)){let u=gn(a.gameState,n);if(u!==void 0){s.Information(c("tt_military_recruit_active_hint",X(u),q(_n(a.gameState,n))));let m=P[n].recruitCost;if(m!==void 0){let l=m(a.gameState);Ur(l,a.gameState.recruitment[n]?.rate??0),fe(s,l,!0,!1)}}}else s.Information(c("tt_military_recruit_inactive_hint"))}),i.addEventListener("click",()=>{ue(a.gameState,n)&&yn(a.gameState,n,!Le(a.gameState,n))})}{let i=H(t,"ArmyDeploymentWidgetTemplate",`DeployUnit${n.toUpperFirst()}`);if(i===null)throw new Error("Failed to create military deployment template instance");let s={slot:i,count:g(i,".Count"),assignUp:g(i,".Up"),assignDown:g(i,".Down")};a.deployMilitary.units[n]=s,g(i,".Portrait").style.backgroundImage=`url("images/military/${o.icon}.svg")`,E(i,"left",u=>{Ye(n,u),u.Separator(),u.Information(c("tt_deploy_allocation_help"))}),s.assignUp.addEventListener("click",u=>{u.shiftKey?a.gameState.persistent.militaryDeployment[n]=a.gameState.persistent.military[n]??0:u.ctrlKey?a.gameState.persistent.militaryDeployment[n]=(a.gameState.persistent.militaryDeployment[n]??0)+5:a.gameState.persistent.militaryDeployment[n]=(a.gameState.persistent.militaryDeployment[n]??0)+1,he()}),s.assignDown.addEventListener("click",u=>{u.shiftKey?delete a.gameState.persistent.militaryDeployment[n]:u.ctrlKey?a.gameState.persistent.militaryDeployment[n]=Math.max(0,(a.gameState.persistent.militaryDeployment[n]??0)-5):a.gameState.persistent.militaryDeployment[n]=Math.max(0,(a.gameState.persistent.militaryDeployment[n]??0)-1),he()})}}let r=g(a.activeBattle.container,".Frontline");for(let n=0;n<re;++n){let o=H(r,"BattleFileTemplate");if(o===null)throw new Error("Failed to create battle file template instance");a.activeBattle.frontlines.push({container:o,playerBack:g(o,".AttackerBack"),playerFront:g(o,".AttackerFront"),interaction:g(o,".Interaction"),enemyFront:g(o,".DefenderFront"),enemyBack:g(o,".DefenderBack")})}E(a.activeBattle.retreat,"left",n=>{n.Header(c("tt_battle_retreat")),n.Lore(c("tt_battle_retreat_lore")),n.Separator(),n.Information(c("tt_battle_retreat_description"))}),a.activeBattle.retreat.addEventListener("click",()=>tn(a.gameState)),Wt(),E(a.playerFortStrength.container,"left",n=>{n.Header(c("tt_fortstrength_header")),n.Lore(c("tt_fortstrength_lore")),n.Separator(),n.Information(c("tt_fortstrength_description")),n.Separator(),n.Information(c("modifier_fortifications_repair",_t(a.gameState)))}),E(a.deployMilitary.container,"left",n=>{n.Header(c("tt_deploy_header")),n.Separator(),n.Information(c("tt_deploy_description"))}),g("#ArmyDeployAll").addEventListener("click",n=>{for(let o of Object.keys(P))a.gameState.persistent.militaryDeployment[o]=a.gameState.persistent.military[o]??0;he()}),g("#ArmyDeployNone").addEventListener("click",n=>{for(let o of Object.keys(P))delete a.gameState.persistent.militaryDeployment[o];he()}),he()}function te(e){e.textContent?.charAt(0)=="$"&&(e.innerHTML=c(e.textContent.substr(1)));for(let t of e.children)t instanceof HTMLElement&&te(t)}function Jo(){let e=a.gameState;for(let t of R){let r=a.currencies[t];if(r!==void 0){let n=$r(e,t),o=yt(t),i=e.income[t]??0;k(r.parent,"Visible",n),k(r.income,"Negative",i<0),n&&(ke(t)?(r.current.textContent=q(Math.floor(e.persistent.wallet[t])),le(t)&&a.settings.showMaxStorageInCurrencyBar&&(r.current.textContent+=`/${q(Math.floor(e.walletStorage[t]))}`),o&&(r.income.textContent=`(${Z(i)})`)):o&&(r.income.textContent=Z(i)))}}}function An(){let e=a.gameState;k(document.body,"MilitaryEnabled",e.enabledFeatures.military===!0),e.persistent.techTarget!==void 0&&Ft(e.persistent.techTarget),a.idleWorkers.textContent=e.persistent.activeWorkers.idle.toString(),k(a.idleWorkers,"Visible",e.enabledFeatures.workers===!0),Jo(),Gn(),In(),qt()}function E(e,t,r){Fn(e);let n=o=>{Ko(e,t,r),o.stopPropagation()};a.tooltipHandlers.set(e,n),e.addEventListener("mouseover",n),e.addEventListener("mouseout",qn)}function Fn(e){let t=a.tooltipHandlers.get(e);t&&(e.removeEventListener("mouseover",t),e.removeEventListener("mouseout",qn))}function Ko(e,t,r){let n=C("#Tooltip");n!==null&&(a.activeTooltip=new Xe(n,r),a.activeTooltip.ShowOn(e,t))}function Qe(){a.activeTooltip?.Refresh()}function qn(){C("#Tooltip")?.classList.remove("Visible"),a.activeTooltip=void 0}function Oo(){let e=g("#FeatsContainer");for(let t of He){let r=H(e,"FeatTemplate");if(r===null)throw new Error("Failed to create feat panel from template");a.records.feats[t]=r;let n=g(r,".FeatName"),o=g(r,".FeatDescription");n.innerText=c(`feat_${t}`),o.innerText=c(`feat_${t}_description`)}Ht()}function Ht(){k(document.body,"RecordsEnabled",a.gameState.enabledFeatures.records===!0);for(let[e,t]of Object.entries(a.records.feats))k(t,"Achieved",a.gameState.persistent.feats[e]!==void 0)}function zo(){C("#MessagePopup_Close")?.addEventListener("click",()=>{if(C("#MessagePopup")?.classList.remove("Visible"),a.messageCallback){let e=a.messageCallback;a.messageCallback=void 0,e()}})}function Zo(e,t,r,n){C("#MessagePopup")?.classList.add("Visible");let o=C("#MessageHeader");o!==null&&(o.textContent=e);let i=C("#MessageText");i!==null&&(i.innerHTML=t);let s=C("#MessagePopup_Close");s!==null&&(s.textContent=r),a.messageCallback=n}function No(e,t){Zo(c(`event_${e}_header`),c(`event_${e}_text`),c(`event_${e}_button`),t)}function Hr(){return a.messageCallback!==void 0}function dt(e){k(C("#SaveIndicator"),"Visible",e)}function Vo(e){a.prestigePopup.classList.add("Visible"),a.prestigeMessage.textContent=c(e)}function Qo(){let e=g("#SettingsButton"),t=g("#SettingsPopup"),r=g("#SettingsPopup_Close");E(e,"left",l=>{l.Header(c("ui_settings")),l.Information(c("ui_settings_description"))}),e.addEventListener("click",()=>{Xo(a.settings),t.classList.add("Visible")}),t.addEventListener("click",l=>{l.target===t&&(t.classList.remove("Visible"),Hn())}),r.addEventListener("click",()=>{t.classList.remove("Visible"),Hn()});let n=C("#SettingsPopup_SaveGame");C("#SettingsPopup_Import").addEventListener("click",()=>{let l=n.value.trim();l!==null&&l.length>0&&jr(l)}),C("#SettingsPopup_Export").addEventListener("click",()=>{let l=Pr(a.gameState.persistent);n.textContent=l,n.setSelectionRange(0,l.length),n.focus()}),C("#SettingsPopup_SoftReset").addEventListener("click",()=>{bt(a.gameState)});let u=C("#SettingsPopup_HardReset");u.disabled=!0,u.addEventListener("click",()=>{zr()});let m=C("#SettingsPopup_HardResetEnable");m.addEventListener("change",()=>{u.disabled=m.value!=="HARD RESET"}),te(t),a.settingsCheckboxes={absoluteNextLevelTooltipValues:g(t,"#SettingsPopup_AbsTooltipValues"),showMaxStorageInCurrencyBar:g(t,"#SettingsPopup_MaxStorageInBar")}}function Xo(e){for(let[t,r]of Object.entries(a.settingsCheckboxes))r&&(r.checked=e[t]===!0)}function ei(e){for(let[t,r]of Object.entries(a.settingsCheckboxes))r&&(e[t]=r.checked)}function Hn(){ei(a.settings),localStorage.setItem(kn,JSON.stringify(a.settings))}function Yo(){let e={absoluteNextLevelTooltipValues:!1,showMaxStorageInCurrencyBar:!1},t=localStorage.getItem(kn);if(t){let r=JSON.parse(t);r&&(e.absoluteNextLevelTooltipValues=r.absoluteNextLevelTooltipValues===!0,e.showMaxStorageInCurrencyBar=r.showMaxStorageInCurrencyBar===!0)}return e}String.prototype.toUpperFirst||(String.prototype.toUpperFirst=function(){return this.length==0?this:this.charAt(0).toUpperCase()+this.substr(1)});function C(e,t){return typeof e=="string"?document.querySelector(e):t!==void 0?e.querySelector(t):null}function g(e,t){if(typeof e=="string"){let r=C(e);if(r===null)throw new Error(`Failed to find required element with selector ${e}`);return r}else if(t!==void 0){let r=C(e,t);if(r===null)throw new Error(`Failed to find required element with selector ${t} on ${e}`);return r}throw new Error("Bad $Required")}function H(e,t,r){let o=document.getElementById(t)?.content?.firstElementChild;if(o){let i=e.appendChild(o.cloneNode(!0));return r!==void 0&&(i.id=r),i}return null}function k(e,t,r){r?e?.classList.add(t):e?.classList.remove(t)}function pt(e,t){window.setInterval(t,e)}function ft(e){return e<15?Math.ceil(e/2)*2:e<50?Math.ceil(e/5)*5:e<500?Math.ceil(e/10)*10:Math.ceil(e/100)*100}function Ut(e){for(let t=0;t<e.length;++t)if(e[t]=="."){for(let r=e.length-1;r>t;--r)if(e[r]!="0"&&e[r]!=".")return e.substr(0,r+1);return e.substr(0,t)}return e}function q(e){let t=Math.abs(e);return t>=1e9?(e/1e9).toPrecision(3)+c("suffix_billion"):t>=1e6?(e/1e6).toPrecision(3)+c("suffix_million"):t>=1e3?(e/1e3).toPrecision(3)+c("suffix_thousand"):t>=10?Ut(e.toPrecision(3)):Ut(e.toFixed(2))}function de(e){return(e>0?"+":"")+q(e)}function At(e){let t=(e-1)*100;return`${t>0?"+":""}${Ut(t.toFixed(2))}%`}function X(e){e=Math.floor(e);let t=e%60,r=Math.floor(e%3600/60),n=Math.floor(e/3600),o=[];return n>0&&o.push(n.toString()+c("suffix_hours")),r>0&&o.push(r.toString()+c("suffix_minutes")),t>0&&o.push(t.toString()+c("suffix_seconds")),o.length==0?c("generic_verysoon"):o.join(" ")}function Z(e){return de(e)+c("suffix_persecond")}function j(e,t){let r={};for(let n of e)r[n]=t;return r}function B(e,t){return Object.prototype.hasOwnProperty.call(e,t)}var ti={M:1e3,DM:900,D:500,CD:400,C:100,XC:90,X:10,IX:9,V:5,IV:4,I:1};function Ne(e){let t="";for(let[r,n]of Object.entries(ti)){let o=Math.floor(e/n);t+=r.repeat(o),e-=o*n}return t}var N=class{constructor(t){this.seed=Math.abs(Math.floor(t)%2147483647)}float(t,r){return this.seed=Math.floor(this.seed*48271)%2147483647,t!==void 0&&r!==void 0?t+(r-t)*this.seed/2147483648:(t??1)*this.seed/2147483648}int(t,r){return Math.floor(this.float(t,r))}chance(t){return this.float(0,1)<=t}pick(t){return t[this.int(0,t.length)]}pick_remove(t){let r=this.int(0,t.length),n=t[r];return t.splice(r,1),n}};window.addEventListener("DOMContentLoaded",()=>{wn()});window.addEventListener("load",()=>{C("#LoadingScreen")?.classList.add("Hidden")});})();
