(()=>{var Ct=window.location.hostname=="localhost",St=Ct&&!0,he=125,xt=1e4,Tt=Ct?4:1,Lt=1.15,Mt=.005,Gt=5,Et=1.15,Rt=1.01,It=4,Bt=1.15,At=6,qe=.8,He=6,Pt=1.1,Ft=1.5,qt=1.3,Ht=.02,Y=7,J=3,Wt=50,We=1.3,Dt=3,$t=.1,Ut=.5,Ot=.06,De=.2,jt=.05,zt=.2,Nt=400,Vt=1.3,Qt=5*60,Yt=5*60,Jt=1,Kt=.012,$e=.2,Xt=12,Ue=.2,Zt=24,Oe=.2;var tn={brilliance:{slot:{x:0,y:0},cost:{prestige:50},income:()=>({mana:2,research:2}),storage:()=>({mana:100}),icon:"book-aura"},manaregen:{slot:{x:-1,y:1},cost:{prestige:40},multipliers:()=>({income_mana:1.25}),requires:["brilliance"],icon:"dead-eye"},betterbooks:{slot:{x:-1,y:2},cost:{prestige:60},multipliers:()=>({stacks_research:1.25,scriptorium_research:1.25}),requires:["manaregen"],icon:"bookmarklet"},drudge_mastery:{slot:{x:-3,y:1},cost:{prestige:20},multipliers:()=>({summon_skeleton_worker_cost:.5}),requires:["brilliance"],icon:"candle-skull"},morestorage:{slot:{x:-3,y:2},cost:{prestige:35},multipliers:()=>({storage_bones:1.25,storage_lumber:1.25,storage_stone:1.25,storage_ore:1.25}),requires:["drudge_mastery"],icon:"wooden-crate"},spell_queue:{slot:{x:1,y:1},cost:{prestige:15},enableFeatures:["spell_queue"],requires:["brilliance"],modifiers:()=>({spellqueue_max:8}),icon:"splashy-stream"},records:{slot:{x:3,y:1},cost:{prestige:5},requires:["brilliance"],enableFeatures:["records","feat_income"],icon:"classical-knowledge"}},A=tn;var rn={lumbermill:{icon:"lumbermill",location:"forest",requiresAny:{necro_lumbermill:1},cost:e=>({lumber:v(120,e)}),storage:e=>({lumber:25*e}),multipliers:e=>({basic_lumber:1+.02*e})},quarry:{icon:"quarrying",location:"mines",requiresAny:{necro_quarries:1},cost:e=>({lumber:v(60,e),stone:v(60,e)}),storage:(e,t)=>({stone:25*e,ore:k(t,0,"quarry_ores")*e,crystal:k(t,0,"quarry_crystal_storage")*e}),multipliers:e=>({basic_stone:1+.02*e})},librarystacks:{icon:"bookshelf",location:"sanctum",requiresAny:{necro_librarystacks:1},cost:e=>({lumber:v(80,e*1.5),stone:e>=10?v(150,(e-10)*1.5):0}),income:(e,t)=>({research:k(t,.2,"stacks_research")*e}),storage:(e,t)=>({tomes:k(t,0,"stacks_tomestorage")*e})},obelisk:{icon:"obelisk",location:"wastelands",requiresAny:{necro_obelisks:1},cost:e=>({stone:v(90,e),mana:v(70,e)}),income:(e,t)=>({mana:k(t,.2,"obelisk_income")*e}),storage:(e,t)=>({mana:k(t,0,"obelisk_storage")*e})},storageyard:{icon:"wooden-crate",location:"courtyard",requiresAny:{necro_centralization:1},cost:e=>({lumber:v(40,e),stone:v(20,e)}),storage:(e,t)=>({lumber:k(t,75,"storageyard_lumber")*e,stone:k(t,75,"storageyard_stone")*e,metal:k(t,0,"storageyard_metals")*e,ore:k(t,0,"storageyard_ore")*e})},metalmine:{icon:"mine",location:"mines",requiresAny:{necro_mining:1},cost:e=>({lumber:v(80,e),stone:v(30,e)}),modifiers:e=>({basic_ore:e*.1})},smelter:{icon:"smelting",location:"courtyard",requiresAny:{necro_smelting:1},cost:e=>({stone:v(225,e),metal:e>=5?v(75,(e-5)*1.25):0}),upkeep:(e,t)=>({lumber:4*e*(1+(t.modifiers.smelter_workers??0)/100*t.persistent.activeWorkers.courtyard),ore:1*e*(1+(t.modifiers.smelter_workers??0)/100*t.persistent.activeWorkers.courtyard)}),income:(e,t)=>({metal:.25*e*(1+(t.modifiers.smelter_workers??0)/100*t.persistent.activeWorkers.courtyard)})},ossuary:{icon:"crypt",location:"sanctum",requiresAny:{necro_ossuaries:1},cost:e=>({stone:v(120,e),bones:v(60,e)}),storage:(e,t)=>({bones:k(t,60,"ossuary_bones_storage")*e,ectoplasm:k(t,0,"ossuary_ectoplasm_storage")*e})},shrine:{icon:"shrine",location:"forest",requiresAny:{necro_shrines:1},cost:e=>({lumber:v(100,e),stone:v(100,e),bones:v(60,e)}),upkeep:e=>({mana:.3*e}),income:(e,t)=>({ectoplasm:k(t,.2,"shrine_income")*(1+(t.modifiers.shrine_workers??0)/100*t.persistent.activeWorkers.forest)*e})},palisade:{icon:"palisade",location:"wastelands",requiresAny:{necro_palisades:1},cost:e=>({lumber:v(400,e),stone:v(120,e)}),modifiers:e=>({fortifications:e*125})},workshop:{icon:"workshop",location:"courtyard",requiresAny:{necro_workshops:1},cost:e=>({lumber:v(600,e),stone:v(600,e),metal:v(300,e)}),multipliers:e=>({deploy_material_cost:Math.floor((.5+.5*Math.pow(.98,e))*1e3)/1e3}),storage:(e,t)=>({lumber:k(t,0,"workshop_storage_lumber")*e,stone:k(t,0,"workshop_storage_stone")*e,crystal:k(t,0,"workshop_storage_crystal")*e})},scriptorium:{icon:"scriptorium",location:"sanctum",requiresAny:{necro_scriptorium:1},cost:e=>({stone:v(500,e),crystal:v(50,e),ectoplasm:v(100,e)}),upkeep:e=>({ectoplasm:.3*e}),income:(e,t)=>({research:k(t,.3,"scriptorium_research")*e*(1+(t.modifiers.scriptorium_workers??0)/100*t.persistent.activeWorkers.sanctum)})},oregrinder:{icon:"oregrinder",location:"mines",requiresAny:{necro_crystalassay:1},cost:e=>({stone:v(1500,e),metal:v(500,e)}),upkeep:e=>({ore:3*e}),income:(e,t)=>({crystaldust:.4*e}),storage:(e,t)=>({crystaldust:75*e})}},F=rn;var nn={summon_skeleton_worker:{icon:"raise-skeleton",requiresAny:{necro_workers:1},cost:(e,t)=>{let r=X(t);return{mana:v(20*(t.multipliers.summon_skeleton_worker_cost??1),r),bones:v(8,r)}},execute:(e,t)=>{ze(t,1)}},summon_skeleton_warrior:{icon:"spears",requiresAny:{necro_military:1},cost:(e,t)=>{let r=ye(t,"necro_soldier");return{mana:v(20,r),metal:v(10,r),bones:v(20,r)}},execute:(e,t)=>{_e(t,"necro_soldier",1)}},summon_skeleton_archer:{icon:"archery",requiresAny:{necro_archery:1},cost:(e,t)=>{let r=ye(t,"necro_archer");return{mana:v(20,r),lumber:v(30,r),bones:v(15,r)}},execute:(e,t)=>{_e(t,"necro_archer",1)}},summon_revenant:{icon:"haunting",requiresAny:{necro_revenants:1},cost:(e,t)=>{let r=ye(t,"necro_revenant");return{mana:v(100,r),ectoplasm:v(100,r),bones:v(75,r)}},execute:(e,t)=>{_e(t,"necro_revenant",1)}},expanded_mind:{icon:"expanded-mind",metamagic:!0,requiresAny:{necro_expanded_mind:1},duration:(e,t)=>(t.multipliers.expanded_mind_duration??1)*300,cost:e=>({mana:ge(100,e-1),crystaldust:e<=1?0:oe(60,e-1)}),storage:e=>({mana:125+(e-1)*25}),income:(e,t)=>({mana:k(t,0,"expanded_mind_mana_income")*(1+(e-1)*.25)})},vigormortis:{icon:"ribcage",metamagic:!0,requiresAny:{necro_vigormortis:1},duration:(e,t)=>(t.multipliers.vigormortis_duration??1)*180,cost:e=>({mana:ge(150,e-1),bones:oe(200,e-1),crystaldust:e<=1?0:oe(110,e-1)}),modifiers:e=>({basic_stone:1+(e-1)*.5,basic_lumber:1+(e-1)*.5,basic_ore:1+(e-1)*.25})},brainstorm:{icon:"brainstorm",metamagic:!0,requiresAny:{necro_brainstorm:1},duration:(e,t)=>120,cost:e=>({mana:ge(800,e-1),crystaldust:oe(275,e-1)}),income:e=>({research:12+(e-1)*4})},phylactery:{icon:"phylactery",requiresAny:{necro_phylactery:1},cost:()=>({mana:650,crystal:100}),execute:(e,t)=>{N(t,"prestige"),t.persistent.wallet.prestige+=50,Ne(t,"ui_prestigereset_phylactery",0)}},craft_dust:{icon:"crystal-dust",requiresAny:{necro_crystaldust:1},cost:()=>({mana:25,stone:150,crystal:10}),execute:(e,t)=>{je(t,{crystaldust:20+10*Math.random()})}}},P=nn;var an={necro_soldier:{unitClass:"melee",deployCost:(e,t)=>({mana:3*e,bones:k(t,4,"deploy_material_cost")*e}),icon:"spears",skill:()=>8,attack:()=>6,defense:e=>k(e,2,"necro_soldier_armor"),stackSize:100},necro_revenant:{unitClass:"melee",deployCost:(e,t)=>({mana:15*e,bones:k(t,20,"deploy_material_cost")*e,ectoplasm:k(t,30,"deploy_material_cost")*e}),icon:"revenant",skill:()=>10,attack:()=>12,defense:()=>2,abilities:()=>({ethereal:1}),stackSize:100},necro_archer:{unitClass:"ranged",deployCost:(e,t)=>({mana:3*e,bones:k(t,5,"deploy_material_cost")*e}),icon:"archer",skill:()=>4,attack:e=>k(e,4,"necro_archer_attack"),defense:()=>0,stackSize:100},cpu_peasant:{unitClass:"melee",icon:"peasant",skill:()=>3,attack:()=>3,defense:()=>0,stackSize:100,enemyPointCost:3},cpu_infantry_human:{unitClass:"melee",icon:"human-soldier",skill:()=>8,attack:()=>8,defense:()=>2,stackSize:100,enemyPointCost:8},cpu_infantry_elven:{unitClass:"melee",icon:"elf-soldier",skill:()=>10,attack:()=>6,defense:()=>1,stackSize:100,enemyPointCost:8},cpu_infantry_dwarven:{unitClass:"melee",icon:"dwarf-soldier",skill:()=>6,attack:()=>10,defense:()=>5,stackSize:100,enemyPointCost:10}},G=an;var on=2,Qe="progresslich-savedata";function L(e){if(typeof e=="number")return e;throw"Malformed save data"}function ve(e){if(typeof e=="string")return e;throw"Malformed save data"}function sn(e,t){let r=[];for(let n of t)typeof n=="object"&&n&&M(n,"spell")&&M(n,"level")&&M(n,"count")&&r.push({spell:ve(n.spell),level:L(n.level),count:L(n.count)});return r}function ln(e,t){if(typeof t=="object"&&t&&M(t,"level")&&M(t,"duration")&&M(t,"durationLeft"))return{level:L(t.level),duration:L(t.duration),durationLeft:L(t.durationLeft)};throw"Malformed save data"}function we(e,t){if(typeof t=="object"&&t){let r={};for(let n of Object.keys(G))if(M(t,n)){let a=L(t[n]);a>0&&(r[n]=a)}return r}throw"Malformed save data"}function er(e,t){if(Array.isArray(t)){let r=new Array(t.length);for(let n=0;n<t.length;++n){let a=t[n];if(!a)r[n]=null;else if(typeof a=="object"&&a&&M(a,"unit")&&M(a,"count")&&M(a,"casualties"))G[a.unit]!==void 0?r[n]={unit:ve(a.unit),count:L(a.count),casualties:L(a.casualties)}:r[n]=null;else throw"Malformed save data"}return r}throw"Malformed save data"}function tr(e,t){if(typeof t=="object"&&t&&M(t,"startingArmy")&&M(t,"reserves")&&M(t,"fortifications")&&M(t,"fortificationsMax")&&M(t,"frontRank")&&M(t,"backRank"))return{startingArmy:we(e,t.startingArmy),reserves:we(e,t.startingArmy),fortifications:L(t.fortifications),fortificationsMax:L(t.fortificationsMax),frontRank:er(e,t.frontRank),backRank:er(e,t.backRank)};throw"Malformed save data"}function cn(e,t){if(typeof t=="object"&&t&&M(t,"timer")&&M(t,"player")&&M(t,"enemy")){let r={timer:L(t.timer),player:tr(e,t.player),enemy:tr(e,t.enemy)};return M(t,"warTargetIndex")&&typeof t.warTargetIndex=="number"&&(r.warTargetIndex=t.warTargetIndex),r}throw"Malformed save data"}function un(e,t){if(typeof t=="object"&&t&&M(t,"seed")&&M(t,"wave")&&M(t,"army")&&M(t,"countdown"))return{seed:L(t.seed),wave:L(t.wave),countdown:L(t.countdown),army:we(e,t.army)};throw"Malformed save data"}function Ye(e){try{let t=JSON.parse(atob(e));if(typeof t.version!="number"||typeof t.data!="object")throw"Malformed save data";let r=t.version,n=be();n.seed=L(t.data.seed),n.culture=ve(t.data.culture);for(let a of S)t.data.wallet[a]!==void 0&&(n.wallet[a]=L(t.data.wallet[a]));for(let[a,o]of Object.entries(T))t.data.techLevels[a]!==void 0&&(n.techLevels[a]=Math.max(0,L(t.data.techLevels[a])),o.maxLevel!==void 0&&(n.techLevels[a]=Math.min(n.techLevels[a],o.maxLevel))),t.data.techProgress[a]!==void 0&&(n.techProgress[a]=Math.max(0,L(t.data.techProgress[a])));if(t.data.techTarget!==void 0){let a=ve(t.data.techTarget);T[a]!==void 0&&(n.techTarget=a)}for(let a of q)n.activeWorkers[a]=L(t.data.activeWorkers?.[a]??0),n.assignedWorkers[a]=L(t.data.assignedWorkers?.[a]??0);for(let a of Object.keys(F))n.buildingLevels[a]=L(t.data.buildingLevels?.[a]??0),n.disabledBuildings[a]=L(t.data.disabledBuildings?.[a]??0);if(t.data.activeSpellEffects)for(let[a,o]of Object.entries(t.data.activeSpellEffects))n.activeSpellEffects[a]=ln(r,o);for(let a of Object.keys(t.data.feats))n.feats[a]=!0;for(let a of Object.keys(A))(t.data.prestige?.[a]??!1)&&(n.prestige[a]=!0);for(let a of Object.keys(P))n.metamagicLevel[a]=L(t.data.metamagicLevel?.[a]??0);Array.isArray(t.data.spellQueue)&&(n.spellQueue=sn(r,t.data.spellQueue));for(let[a,o]of Object.entries(t.data.events))(typeof o=="string"||typeof o=="boolean"||typeof o=="number")&&(n.events[a]=o);if(n.military=we(r,t.data.military),typeof t.data.militaryDeployment=="object"&&t.data.militaryDeployment)for(let a of Object.keys(G)){let o=t.data.militaryDeployment[a];o&&(n.militaryDeployment[a]=L(o))}if(typeof t.data.battle=="object"&&(n.battle=cn(r,t.data.battle)),typeof t.data.invaders=="object"&&(n.invaders=un(r,t.data.invaders)),n.invaderAnger=Math.max(0,L(t.data.invaderAnger??0)),Array.isArray(t.data.warTargets)){for(let a=0;a<J;++a)if(a<t.data.warTargets.length){let o=t.data.warTargets[a];if(typeof o=="object"&&o&&M(o,"seed")&&M(o,"level"))n.warTargets[a]={seed:L(o.seed),level:L(o.level)};else throw"Malformed save data"}}return n.warTargetVictories=L(t.data.warTargetVictories??0),n.fortDamage=L(t.data.fortDamage??0),n}catch(t){console.error(`Error deserializing save: ${t}`);return}}function Je(e){return btoa(JSON.stringify({version:on,data:e}))}function rr(){let e=localStorage.getItem(Qe);if(e!==null){let t=Ye(e);if(t!==void 0)return t}return be()}function ke(e){Ve(!0),localStorage.setItem(Qe,Je(e)),Ve(!1)}function nr(){localStorage.removeItem(Qe)}var dn=["prestige","militaryvictory","killedinbattle","tech100","tech500","victories50","victories250"],Ce=dn;var se=!1,et=!1,S=["prestige","prestigescraps","research","mana","bones","flesh","lumber","stone","ore","metal","crystal","crystaldust","ectoplasm","tomes","soulgem"];function mn(){return D(S,0)}var q=["idle","wastelands","forest","mines","sanctum","courtyard"],tt={necromancy:{workerName:"necromancy_worker",workerUpkeep:e=>({bones:X(e)*.1})}};function v(e,t){return Math.floor(e*Math.pow(Lt,t))}function oe(e,t){return Math.floor(e*Math.pow(qt,t))}function ge(e,t){return Math.floor(e*Math.pow(Ft,t))}function ie(e){return e!="research"}function Se(e){return e!="prestige"&&e!="prestigescraps"}function rt(e){return e!="prestige"&&e!="prestigescraps"}function sr(e,t){return t=="research"||e.walletStorage[t]>0||t=="prestige"&&$(e)||t=="prestigescraps"&&e.persistent.feats.militaryvictory===!0}function pn(e,t){for(let r of S)e[r]=(e[r]??0)+(t[r]??0)}function ir(e){for(let t of S)if((e[t]??0)!==0)return!1;return!0}function le(e,t){let r=T[e],n=Gt*Math.pow(It,r.tier-1)*Math.pow(Bt,r.slot.y);return r.maxLevel===1?n*=At:n=n*Math.pow(Et,t),r.slot.y<He&&(n*=1-qe+qe*r.slot.y/He),n=Ze(n),n}function nt(e,t,r){let n=T[t];if(n.currencyCost!==void 0){let a=le(t,r),o=n.currencyCost(r,e);for(let l of S){let u=o[l];u!==void 0&&(o[l]=Ze(u*a*Math.pow(Rt,r-1)))}return o}}function $(e){return e.persistent.feats.prestige}function k(e,t,...r){for(let n of r)t+=e.modifiers[n]??0;for(let n of r)t*=e.multipliers[n]??1;return t}function at(e){return k(e,0,"fortifications_repair")}function lr(e){let t=Ye(e);t!==void 0?(ke(t),se=!0,location.reload()):console.error("Failed to load game from string")}function be(){let e={seed:Math.floor(Math.random()*2147483647),culture:"necromancy",wallet:mn(),techLevels:D(Object.keys(T),0),techProgress:{},activeWorkers:D(q,0),assignedWorkers:D(q,0),buildingLevels:D(Object.keys(F),0),disabledBuildings:{},activeSpellEffects:{},spellQueue:[],feats:{},prestige:{},metamagicLevel:{},events:{},military:{},militaryDeployment:{},invaderAnger:0,warTargets:[],warTargetVictories:0,fortDamage:0};return fn(e),e}function Ne(e,t,r){se=!0,et=!0,e.persistent.wallet.prestige+=Math.ceil(e.persistent.wallet.prestigescraps*r),e.events.prestigeResetTriggered.invoke(t)}function cr(e){et&&ot(e)}function ot(e){let t=be();t.feats={...e.persistent.feats},t.prestige={...e.persistent.prestige},t.wallet.prestige=e.persistent.wallet.prestige,t.events=e.persistent.events,ke(t),se=!0,location.reload()}function ur(){nr(),se=!0,location.reload()}function fn(e){let t=O(e.seed);for(let r=e.warTargets.length;r<J;++r)e.warTargets.push({level:0,seed:t(2147483647)})}function yn(e){return{persistent:e,gameSpeed:Tt,walletStorage:D(S,0),income:{},modifiers:{},multipliers:{},enabledFeatures:{},hiddenTech:{},techTargetChoked:!1,warTargets:hn(e),retreatRequested:!1,events:{ticked:new R,battleBegan:new R,battleEnded:new R,buildingCountChanged:new R,standingArmyChanged:new R,techLevelsChanged:new R,techTargetChanged:new R,spellCast:new R,spellExpired:new R,spellQueueChanged:new R,invasionBegan:new R,prestigeResetTriggered:new R,prestigeUpgradesChanged:new R,workersChanged:new R,storyEventTriggered:new R,featAchieved:new R}}}function K(e,t,r){let n=G[t];if(n!==void 0&&n.enemyPointCost!==void 0){let a=Math.floor(Math.floor(r)/n.enemyPointCost);if(a>0)return e[t]=(e[t]??0)+a,a*n.enemyPointCost}return 0}function gn(e,t,r){let n=O(r),a={},o=Math.floor(Nt*n(.9,1.1)*Math.pow(Vt,e));return o-=K(a,"cpu_infantry_elven",o*n(.2,.4)),o-=K(a,"cpu_infantry_dwarven",o*n(.2,.4)),K(a,"cpu_infantry_human",o),a}function _n(e,t,r){let n=O(r),a={},o=Math.floor(Wt*n(.9,1.1)*Math.pow(We,t));if(t>=2){let l=o*.6*Math.min(1,(t-2)/7);switch(e){default:case"human":o-=K(a,"cpu_infantry_human",l);break;case"elven":o-=K(a,"cpu_infantry_elven",l);break;case"dwarven":o-=K(a,"cpu_infantry_dwarven",l);break}}return K(a,"cpu_peasant",o),a}function bn(e,t){let r={},n=O(t.seed);switch(r.bones=.8,t.culture){default:case"human":r.lumber=.5,r.stone=.5,e.enabledFeatures.spoils_ore&&(r.ore=.15),e.enabledFeatures.spoils_tomes&&(r.tomes=.04);break;case"elven":r.lumber=.7,r.stone=.3,e.enabledFeatures.spoils_tomes&&(r.tomes=.055);break;case"dwarven":r.lumber=.1,r.stone=.7,e.enabledFeatures.spoils_ore&&(r.ore=.5),e.enabledFeatures.spoils_tomes&&(r.tomes=.04);break}for(let a of S){let o=r[a];o!==void 0&&(r[a]=Math.floor(n(.9,1.1)*t.population*o*(e.multipliers[`spoils_${a}`]??1)))}return r.prestigescraps=t.population*Kt*n(1-$e,1+$e),r}function dr(e,t){let r=O(t),n=Math.floor((.75+r(.5))*100*Math.pow(We,e)),a;switch(Math.floor(r(3))){default:case 0:a="human";break;case 1:a="elven";break;case 2:a="dwarven";break}let o=Ke(`wartarget_${a}_village_a`,r)+Ke(`wartarget_${a}_village_b`,r),l=_n(a,e,t);return{seed:t,culture:a,name:o,population:n,defenders:l}}function hn(e){let t=[];for(let r of e.warTargets)t.push(dr(r.level,r.seed));return t}function vn(e){let t=(e.persistent.invaders?.wave??-1)+1,r=e.persistent.invaders?.seed??Math.floor(Math.random()*2147483647);e.persistent.invaders={army:gn(t,e.persistent.warTargetVictories,r),wave:t,seed:Math.floor(O(r)(2147483647)),countdown:t==0?Yt:Qt},e.events.invasionBegan.invoke()}function st(e){return Math.max(0,e.persistent.invaderAnger-De)/(1-De)}function mr(e,t){e.persistent.invaders||(Math.random()<st(e)?(e.persistent.invaderAnger=0,vn(e)):e.persistent.invaderAnger=Math.min(1,e.persistent.invaderAnger+t*(.5+Math.random()*.5)))}function pr(e,t){for(let r=0;r<t.length;++r){let n=t[r];if(n){let a=Math.min(e[n.unit]??0,G[n.unit].stackSize-n.count);n.count+=a,e[n.unit]=(e[n.unit]??0)-a}}}function fr(e){for(let t=0;t<e.length;++t){let r=e[t];r&&r.count==0&&(e[t]=null)}}function hr(e){let t=Math.floor(e.length/2),r=t;for(let n=t;n>=0;--n)e[n]!==null&&(n!==r&&(e[r]=e[n],e[n]=null),r--);r=t;for(let n=t;n<e.length;++n)e[n]!==null&&(n!==r&&(e[r]=e[n],e[n]=null),r++)}function wn(e,t){let r=Math.floor(e.length/2);for(let n=r;n>=0&&n<e.length;n+=t)if(e[n]===null)return n}function kn(e,t,r,n,a){let o=wn(t,n);if(o!==void 0&&o>=a&&o<t.length-a){let l=G[r],u=Math.min(e.reserves[r],l.stackSize);if(u>0)return t[o]={unit:r,count:u,casualties:0},e.reserves[r]-=u,u}return 0}function xe(e,t,r,n){let a=1;for(let o of Object.keys(e.reserves))if(G[o].unitClass==r)for(;e.reserves[o]>0;){let u=kn(e,t,o,a,n);if(a=a==1?-1:1,u==0&&u==0)break}}function Z(e){pr(e.reserves,e.frontRank),pr(e.reserves,e.backRank),fr(e.frontRank),fr(e.backRank),hr(e.frontRank),hr(e.backRank),xe(e,e.frontRank,"melee",1),xe(e,e.frontRank,"cavalry",0),xe(e,e.frontRank,"melee",0),xe(e,e.backRank,"ranged",0);for(let t=0;t<e.frontRank.length;++t)e.frontRank[t]===null&&e.backRank[t]!==null&&(e.frontRank[t]=e.backRank[t],e.backRank[t]=null)}function Te(e,t){let r={reserves:{...e},startingArmy:{...e},fortifications:0,fortificationsMax:0,frontRank:new Array(t),backRank:new Array(t)};return r.frontRank.fill(null),r.backRank.fill(null),r}function it(e,t){if(e.persistent.invaders)return"invaded";if(e.persistent.battle)return"inbattle";let r=!1;for(let[n,a]of Object.entries(e.persistent.militaryDeployment))if(a!==void 0&&Math.min(a,e.persistent.military[n]??0)>0){r=!0;break}return r?Me(e,Le(e))?!0:"cantafford":"noarmy"}function Le(e){let t={};for(let[r,n]of Object.entries(e.persistent.militaryDeployment))if(n!==void 0&&n>0){let a=G[r].deployCost;if(a!==void 0){let o=Math.min(n,e.persistent.military[r]??0);pn(t,a(o,e))}}return t}function yr(e,t){let r=e.warTargets[t];if(it(e,r)!==!0)return;ee(e,Le(e));let n={};for(let[o,l]of Object.entries(e.persistent.militaryDeployment))if(l!==void 0){let u=Math.min(l,e.persistent.military[o]??0);u>0&&(e.persistent.military[o]-=u,n[o]=u)}let a={timer:0,warTargetIndex:t,player:Te(n,Y),enemy:Te(r.defenders,Y)};Z(a.player),Z(a.enemy),e.persistent.battle=a,e.retreatRequested=!1,e.events.battleBegan.invoke()}function Cn(e){if(e.persistent.invaders!==void 0){let t={timer:0,player:Te(e.persistent.military,Y),enemy:Te(e.persistent.invaders.army,Y)};e.persistent.military={},t.player.fortificationsMax=e.modifiers.fortifications,t.player.fortifications=e.modifiers.fortifications-e.persistent.fortDamage,Z(t.player),Z(t.enemy),e.persistent.battle=t,e.retreatRequested=!1,e.events.battleBegan.invoke()}}function Ge(e){return e.persistent.battle!==void 0&&e.persistent.battle.warTargetIndex===void 0}function gr(e,t){let r={};for(let[n,a]of Object.entries(t.reserves))r[n]=(r[n]??0)+a;for(let n of t.frontRank)n!==null&&(r[n.unit]=(r[n.unit]??0)+n.count);for(let n of t.backRank)n!==null&&(r[n.unit]=(r[n.unit]??0)+n.count);return r}function br(e){e.persistent.battle!==void 0&&e.persistent.battle.warTargetIndex!==void 0&&(e.retreatRequested=!0,_r(e,e.persistent.battle))}function Sn(e){if(e.persistent.battle!==void 0){let t=gr(e,e.persistent.battle.player);for(let[r,n]of Object.entries(t))e.persistent.military[r]=(e.persistent.military[r]??0)+n;e.persistent.battle=void 0}}function vr(e,t,r){let n=G[t],a=n.unitClass=="ranged"||n.unitClass=="cavalry"?2:1;for(let o=0;o<=a;++o){if(e-o>=0&&r[e-o]!==null)return e-o;if(e+o<r.length&&r[e+o]!==null)return e+o}}function wr(e,t,r,n){if(t&&r){let a=G[t.unit],o=G[r.unit],l=a.abilities?a.abilities(e):{},u=o.abilities?o.abilities(e):{},f=n.fortificationsMax==0?0:1-(1-n.fortifications/n.fortificationsMax*Ut);if(Math.random()<=f){let _=a.attack(e);if(_>0){let m=(.5+Math.random())*_*t.count*Ot;a.unitClass==="siege"&&(m*=Dt),n.fortifications=Math.max(0,n.fortifications-m)}return}let c=a.skill(e),d=o.skill(e);u.ethereal!==void 0&&(c*=.25);let C=1+Math.random()*c,p=1+Math.random()*d;if(C>=p){let _=a.attack(e);if(_>0){let m=o.defense(e);l.ethereal!==void 0&&(m*=.75);let h=(.5+Math.random())*_/(_+m)*t.count*$t,w=Math.floor(h)+(Math.random()<h%1?1:0);r.casualties+=w}}}}function kr(e,t,r,n){t.attackDirection=void 0;let a=vr(r,t.unit,n.frontRank);if(a!==void 0){let o=n.frontRank[a];o&&(wr(e,t,o,n),t.attackDirection=a-r)}else{let o=vr(r,t.unit,n.backRank);if(o!==void 0){let l=n.backRank[o];l&&(wr(e,t,l,n),t.attackDirection=o-r)}}}function Cr(e,t,r){let n=t.frontRank.length;for(let a=0;a<n;++a){let o=t.frontRank[a],l=t.backRank[a];o!==null&&kr(e,o,a,r),l!==null&&kr(e,l,a,r)}}function Sr(e,t){for(let r=0;r<t.frontRank.length;++r){let n=t.frontRank[r];n&&(n.count=Math.max(0,n.count-n.casualties));let a=t.backRank[r];a&&(a.count=Math.max(0,a.count-a.casualties))}}function Ee(e,t){for(let r=0;r<t.length;++r){let n=t[r];n&&(n.casualties=0)}}function xr(e,t){let r=0;for(let n=0;n<t.frontRank.length;++n){let a=t.frontRank[n],o=t.backRank[n];a&&(r+=a.count),o&&(r+=o.count)}return r}function _r(e,t){let r=t.warTargetIndex===void 0,n=xr(e,t.enemy)==0,a=!n&&(e.retreatRequested||xr(e,t.player)==0),o=r?void 0:e.warTargets[t.warTargetIndex??0];if(n||a){let l=gr(e,t.player),u={...t.player.startingArmy};for(let[f,c]of Object.entries(l)){let d=u[f];d!==void 0&&(d<=c?delete u[f]:u[f]=d-c)}if(Sn(e),a)e.events.battleEnded.invoke(!1,o,u,{}),r?(N(e,"killedinbattle"),Ne(e,"ui_prestigereset_invasion",Jt)):mr(e,jt);else if(n){let f={};if(t.warTargetIndex!==void 0&&o!==void 0){if(f=bn(e,o),je(e,f),t.warTargetIndex!==void 0){let c=e.persistent.warTargets[t.warTargetIndex];c.level++,c.seed=Math.floor(O(c.seed)(2147483647)),e.warTargets[t.warTargetIndex]=dr(c.level,c.seed)}}else if(r&&e.persistent.invaders!==void 0){let c=O(e.persistent.invaders.seed);f.bones=e.persistent.invaders.wave*Zt*c(1-Oe,1+Oe),f.prestigescraps=e.persistent.invaders.wave*Xt*c(1-Ue,1+Ue)}e.persistent.feats.militaryvictory!==!0&&(N(e,"militaryvictory"),ce(e,"firstmilitaryvictory")),e.persistent.warTargetVictories++,e.persistent.warTargetVictories>=50&&N(e,"victories50"),e.persistent.warTargetVictories>=250&&N(e,"victories250"),r?e.persistent.invaders=void 0:mr(e,zt),e.events.battleEnded.invoke(!0,o,u,f)}return!0}return!1}function xn(e,t,r){for(t.timer+=r;t.timer>=1||e.retreatRequested;){t.timer-=1;let n=t.warTargetIndex==null;if(Ee(e,t.player.backRank),Ee(e,t.player.frontRank),Ee(e,t.enemy.frontRank),Ee(e,t.enemy.backRank),Cr(e,t.player,t.enemy),Cr(e,t.enemy,t.player),Sr(e,t.player),Sr(e,t.enemy),Z(t.player),Z(t.enemy),n&&(e.persistent.fortDamage=Math.max(e.persistent.fortDamage,t.player.fortificationsMax-t.player.fortifications)),_r(e,t))break}}function lt(e){e.enabledFeatures={};for(let[t,r]of Object.entries(e.persistent.techLevels)){let n=T?.[t]?.enableFeatures;if(r>0&&n!==void 0)for(let a of n)e.enabledFeatures[a]=!0}for(let[t,r]of Object.entries(e.persistent.prestige)){let n=A?.[t]?.enableFeatures;if(r===!0&&n!==void 0)for(let a of n)e.enabledFeatures[a]=!0}}function Tn(){let e={};for(let t of Object.keys(T))e[t]=[];for(let[t,r]of Object.entries(T))if(r.requires!==void 0)for(let n of Object.keys(r.requires))e[n].push(t);return e}function Tr(e){e.hiddenTech={};let t=Tn(),r=n=>{let a=[n];for(let o=0;o<a.length;++o)e.hiddenTech[a[o]]!==!0&&(e.hiddenTech[a[o]]=!0,a.push(...t[a[o]]))};for(let n of Object.keys(t)){let a=T[n];if(e.hiddenTech[n]!==!0){if(a.hidden!==void 0&&a.hidden(e)){r(n);continue}if(!St&&a.requires!==void 0){let o=!1;for(let[l]of Object.entries(a.requires))if(e.persistent.techLevels[l]>0){o=!0;break}if(!o){r(n);continue}}}}}function ct(e,t){if(t!==void 0){if(e.hiddenTech[t]===!0)return!1;let r=T[t].maxLevel;if(r!==void 0&&e.persistent.techLevels[t]>=r)return!1;let n=T[t].requires;if(n!==void 0){for(let[l,u]of Object.entries(n))if(e.persistent.techLevels[l]<u)return!1}let a=T[t].requiresVictories;if(a!==void 0&&e.persistent.warTargetVictories<a(e.persistent.techLevels[t]+1,e))return!1;let o=T[t].specialRequires;if(o!==void 0&&!o(e.persistent.techLevels[t]+1,e))return!1}return!0}function ee(e,t,r){r=r??1;for(let n of S){let a=t[n];if(a!==void 0&&e.persistent.wallet[n]<a*r)return!1}for(let n of S){let a=t[n];a!==void 0&&(e.persistent.wallet[n]-=a*r)}return!0}function je(e,t,r){r=r??1;for(let n of S){let a=t[n];a!==void 0&&(e.persistent.wallet[n]+=a*r),Se(n)&&(ie(n)?e.persistent.wallet[n]=Math.min(e.persistent.wallet[n],e.walletStorage[n]):e.persistent.wallet[n]=0)}}function Me(e,t){for(let r of S){let n=t[r];if(n!==void 0&&e.persistent.wallet[r]<n)return!1}return!0}function ut(e,t){if(ct(e,t)){let r=e.persistent.techTarget;e.persistent.techTarget=t,e.techTargetChoked=!1,e.events.techTargetChanged.invoke()}}function Lr(e,t){e.persistent.prestige[t]!==!0&&ee(e,A[t].cost)&&(e.persistent.prestige[t]=!0,lt(e),e.events.prestigeUpgradesChanged.invoke())}function Mr(e,t){let r=A[t];if(e.persistent.prestige[t]===!0||!Me(e,A[t].cost))return!1;if(r.requires!==void 0){for(let n of r.requires)if(e.persistent.prestige[n]!==!0)return!1}return!0}function dt(e,t){let r=P[t];for(let[n,a]of Object.entries(r.requiresAny))if(e.persistent.techLevels[n]>=a)return!0;return!1}function ue(e,t){let r=P[t],n=Re(e,t,1+(e.persistent.metamagicLevel[t]??0));for(let a of S){let o=n[a];if(o!==void 0&&e.persistent.wallet[a]<o)return!1}return dt(e,t)}function Ln(e){let t=0;for(let r of e.persistent.spellQueue)t+=r.count;return t}function Re(e,t,r){let n=P[t],a=n.cost(r,e);if(n.duration!==void 0&&e.persistent.activeSpellEffects[t]!==void 0&&e.persistent.activeSpellEffects[t].level==r){let o=n.duration(r,e),l=e.persistent.activeSpellEffects[t]?.durationLeft??0,u=Math.pow(Pt,Math.ceil(l/o));for(let[f,c]of Object.entries(a))a[f]=c*u}for(let[o,l]of Object.entries(a))a[o]=Math.ceil(l);return a}function mt(e,t,r){t>=0&&t<e.persistent.spellQueue.length&&(!r&&e.persistent.spellQueue[t].count>1?e.persistent.spellQueue[t].count--:e.persistent.spellQueue.splice(t,1)),e.events.spellQueueChanged.invoke()}function Gr(e,t){if(e.enabledFeatures.spell_queue!==!0)return;let r=e.modifiers.spellqueue_max??0;if(Ln(e)>=r)return;let n=1+(e.persistent.metamagicLevel[t]??0),a=e.persistent.spellQueue.length>0?e.persistent.spellQueue[e.persistent.spellQueue.length-1]:void 0;a&&a.spell==t&&a.level==n?a.count++:e.persistent.spellQueue.push({spell:t,level:n,count:1}),e.events.spellQueueChanged.invoke()}function pt(e,t){if(!ue(e,t))return;let r=P[t],n=1+(e.persistent.metamagicLevel[t]??0),a=e.persistent.activeSpellEffects;if(ee(e,Re(e,t,n))){if(r.execute!==void 0&&r.execute(n,e),r.duration!==void 0){let o=r.duration(n,e);a[t]!==void 0&&a[t].level==n?(a[t].durationLeft+=o,a[t].duration=a[t].durationLeft):a[t]={duration:o,durationLeft:o,level:n}}e.events.spellCast.invoke(t)}}function de(e,t){let r=F[t];for(let[n,a]of Object.entries(r.requiresAny))if(e.persistent.techLevels[n]>=a)return!0;return!1}function Er(e,t){let r=F[t].cost(e.persistent.buildingLevels[t],e);return de(e,t)&&Me(e,r)}function Rr(e,t){let r=F[t].cost(e.persistent.buildingLevels[t],e);de(e,t)&&Me(e,r)&&ee(e,r)&&(e.persistent.buildingLevels[t]++,e.events.buildingCountChanged.invoke())}function X(e){let t=0;for(let r of q)t+=e.persistent.activeWorkers[r];return t}function ft(e,t,r){e.persistent.assignedWorkers[t]=Math.max(0,e.persistent.assignedWorkers[t]+r),Ir(e)}function ht(e,t,r){e.persistent.disabledBuildings[t]=Math.max(0,Math.min(e.persistent.buildingLevels[t]??0,(e.persistent.disabledBuildings[t]??0)-r)),e.events.buildingCountChanged.invoke()}function Ir(e){let t=!1;for(let r of q)if(r!=="idle"){let n=e.persistent.activeWorkers[r]-e.persistent.assignedWorkers[r];n>0&&(e.persistent.activeWorkers.idle+=n,e.persistent.activeWorkers[r]-=n)}for(let r of q){if(e.persistent.activeWorkers.idle==0)break;let n=e.persistent.assignedWorkers[r]-e.persistent.activeWorkers[r];if(n>0){let a=Math.min(n,e.persistent.activeWorkers.idle);e.persistent.activeWorkers.idle-=a,e.persistent.activeWorkers[r]+=a}}e.events.workersChanged.invoke()}function ze(e,t){if(t>0)e.persistent.activeWorkers.idle=Math.max(0,e.persistent.activeWorkers.idle+t),Ir(e);else if(t<0){t=-t;let r=Math.min(e.persistent.activeWorkers.idle,t);e.persistent.activeWorkers.idle-=r,t-=r;for(let n of q){if(t<=0)break;let a=Math.min(e.persistent.activeWorkers[n],t);e.persistent.activeWorkers[n]-=a,t-=a}e.events.workersChanged.invoke()}}function ye(e,t){let r=e.persistent.military[t]??0,n=e.persistent.battle;if(n!==void 0){r+=n.player.reserves[t]??0;for(let a of n.player.frontRank)a!==null&&a.unit==t&&(r+=a.count);for(let a of n.player.backRank)a!==null&&a.unit==t&&(r+=a.count)}return r}function _e(e,t,r){e.persistent.battle!==void 0&&Ge(e)?e.persistent.battle.player.reserves[t]=(e.persistent.battle.player.reserves[t]??0)+r:e.persistent.military[t]=Math.max(0,(e.persistent.military[t]??0)+r),e.events.standingArmyChanged.invoke()}function Gn(e,t){let r=t/1e3,n=tt[e.persistent.culture];e.walletStorage=D(S,0),e.income={};let a=1;if(e.enabledFeatures.feat_income)for(let p of Ce)e.persistent.feats[p]!==void 0&&(a+=Mt);let o={},l={},u={...e.persistent.wallet};e.persistent.wallet.research+=r;let f=[],c=[];for(let[p,_]of Object.entries(e.persistent.techLevels))_>0&&f.push([T[p],_]);for(let[p,_]of Object.entries(e.persistent.buildingLevels)){let m=e.persistent.disabledBuildings[p]??0;_>0&&_>m&&f.push([F[p],_-m]),_>0&&m>0&&c.push([F[p],Math.min(m,_)])}for(let[p,_]of Object.entries(e.persistent.activeSpellEffects))_.durationLeft>0&&f.push([P[p],_.level]);for(let[p,_]of Object.entries(e.persistent.prestige))_&&f.push([A[p],1]);for(let p=f.length-1;p>=0;--p){let[_,m]=f[p];if(_.upkeep!==void 0){let h=_.upkeep(m,e);if(_.upkeepPerWorker!==void 0)for(let[w,E]of Object.entries(_.upkeepPerWorker(m,e)))E!==void 0&&(h[w]=(h[w]??0)*(e.persistent.activeWorkers[E]??0));ee(e,h,r)||(f.splice(p,1),c.push([_,m]))}}for(let[p,_]of f){if(p.modifiers!==void 0){let m=p.modifiers(_,e);for(let[h,w]of Object.entries(m))o[h]=(o[h]??0)+w}if(p.multipliers!==void 0){let m=p.multipliers(_,e);for(let[h,w]of Object.entries(m))l[h]=(l[h]??1)*w}}e.modifiers=o,e.multipliers=l;let d=D(S,1),C=D(S,1);for(let p of S)d[p]*=e.multipliers[`storage_${p}`]??1,C[p]*=(e.multipliers[`income_${p}`]??1)*a;for(let[p,_]of c)if(_>0&&p.storage!==void 0){let m=p.storage(_,e);for(let h of S)e.walletStorage[h]+=(m[h]??0)*d[h]}for(let[p,_]of f)if(_>0){if(p.storage!==void 0){let m=p.storage(_,e);for(let h of S)e.walletStorage[h]+=(m[h]??0)*d[h]}if(p.income!==void 0){let m=p.income(_,e);for(let h of S)e.persistent.wallet[h]+=(m[h]??0)*C[h]*r}}ee(e,n.workerUpkeep(e),r)||Math.random()<Ht*X(e)*r&&ze(e,-1),Mn(e);for(let p of S)e.income[p]=(e.persistent.wallet[p]-u[p])/r,Se(p)&&(ie(p)?e.persistent.wallet[p]=Math.min(e.persistent.wallet[p],e.walletStorage[p]):e.persistent.wallet[p]=0)}function Mn(e){let t=e.persistent.wallet.research;if(e.persistent.techTarget!==void 0&&t>0){let r=!1;for(;e.persistent.techTarget!==void 0&&t>0;){let n=T[e.persistent.techTarget],a=le(e.persistent.techTarget,e.persistent.techLevels[e.persistent.techTarget]??0),o=a-(e.persistent.techProgress[e.persistent.techTarget]??0),l=Math.min(o,t);if((e.persistent.techProgress[e.persistent.techTarget]??0)<a){let f=nt(e,e.persistent.techTarget,e.persistent.techLevels[e.persistent.techTarget]);if(f!==void 0)for(let c of S){let d=f[c]??0;if(d>0&&(l*=Math.min(1,e.persistent.wallet[c]/(d*l/a))),l<=0)break}if(e.techTargetChoked=l<Math.min(o,t),l<=0)break;if(e.persistent.techProgress[e.persistent.techTarget]=(e.persistent.techProgress[e.persistent.techTarget]??0)+l,t-=l,f!==void 0)for(let c of S){let d=f[c]??0;d>0&&(e.persistent.wallet[c]=Math.max(0,e.persistent.wallet[c]-d*l/a))}}let u=e.persistent.techProgress[e.persistent.techTarget]??0;if(u>=a){r=!0,e.persistent.techLevels[e.persistent.techTarget]++,e.persistent.techProgress[e.persistent.techTarget]=u-a;let f=n.event;f!==void 0&&ce(e,f);let c=T[e.persistent.techTarget].maxLevel;c!==void 0&&e.persistent.techLevels[e.persistent.techTarget]>=c&&ut(e,void 0);let d=e.persistent.techLevels[e.persistent.techTarget];d>=100&&N(e,"tech100"),d>=500&&N(e,"tech500")}}r&&(Tr(e),lt(e),e.events.techLevelsChanged.invoke())}}function Br(e,t){let r=t/1e3;Gn(e,t),e.persistent.battle!==void 0&&xn(e,e.persistent.battle,r),e.persistent.invaders!==void 0&&(e.persistent.invaders.countdown-=r,e.persistent.invaders.countdown<=0&&e.persistent.battle===void 0&&Cn(e)),Ge(e)||(e.persistent.fortDamage=Math.max(0,e.persistent.fortDamage-at(e)*r));for(let[n,a]of Object.entries(e.persistent.activeSpellEffects))a.durationLeft=Math.max(0,a.durationLeft-r),a.durationLeft<=0&&delete e.persistent.activeSpellEffects[n];e.persistent.spellQueue.length>0&&ue(e,e.persistent.spellQueue[0].spell)&&(pt(e,e.persistent.spellQueue[0].spell),mt(e,0,!1)),e.events.ticked.invoke()}function Ar(e){se||ke(e.persistent)}function N(e,t){e.persistent.feats[t]===void 0&&(e.persistent.feats[t]=!0,e.events.featAchieved.invoke())}function ce(e,t){return e.persistent.events[t]!==!0?(e.persistent.events[t]=!0,e.events.storyEventTriggered.invoke(t),!0):!1}function Pr(){let e=yn(rr());Tr(e),lt(e),ar(e),e.persistent.events.intro!==!0?ce(e,"intro"):e.persistent.feats.prestige===!0&&e.persistent.events.firstprestige!==!0?ce(e,"firstprestige"):e.persistent.feats.killedinbattle===!0&&e.persistent.events.firstkilledinbattle!==!0&&ce(e,"firstkilledinbattle"),Br(e,he),Xe(xt,()=>Ar(e)),window.onbeforeunload=()=>Ar(e),Xe(he,()=>{!et&&!or()&&Br(e,he*e.gameSpeed)})}var En={basic_necromancy:{slot:{x:0,y:0},tier:1,maxLevel:1,icon:"death-note",income:()=>({mana:1}),storage:()=>({mana:100})},necro_workers:{slot:{x:0,y:1},tier:1,maxLevel:1,requires:{basic_necromancy:1},icon:"raise-skeleton",income:()=>({bones:.5}),storage:()=>({bones:30}),enableFeatures:["workers"]},necro_cheaper_workers:{slot:{x:2,y:2},tier:1,requires:{necro_workers:1},icon:"candle-skull",multipliers:e=>({summon_skeleton_worker_cost:.7+.3*Math.pow(.96,e)})},necro_bone_scavenging:{slot:{x:-2,y:2},tier:1,requires:{necro_workers:1},specialRequires:(e,t)=>X(t)>=3,icon:"scavenging",modifiers:e=>({bone_scavenging:.03*e}),income:(e,t)=>({bones:k(t,0,"bone_scavenging")*t.persistent.activeWorkers.wastelands}),hideIncome:["bones"],enableFeatures:["wastelands","job_wastelands"]},necro_bone_piles:{slot:{x:-4,y:3},tier:1,requires:{necro_bone_scavenging:5},icon:"telefrag",storage:e=>({bones:5*e})},necro_lumber:{slot:{x:-2,y:3},tier:1,requires:{necro_bone_scavenging:10},icon:"bone-axe",modifiers:e=>({basic_lumber:.08*e}),income:(e,t)=>({lumber:(t.modifiers.basic_lumber??0)*(t.multipliers.basic_lumber??1)*t.persistent.activeWorkers.forest}),storage:()=>({lumber:200}),hideIncome:["lumber"],enableFeatures:["forest","job_forest"]},necro_stone:{slot:{x:0,y:3},tier:1,requires:{necro_bone_scavenging:10},icon:"stone-pile",modifiers:e=>({basic_stone:.08*e}),income:(e,t)=>({stone:k(t,0,"basic_stone")*t.persistent.activeWorkers.mines}),storage:()=>({stone:125}),hideIncome:["stone"],enableFeatures:["mines","job_mines"]},necro_lumbermill:{slot:{x:-2,y:4},maxLevel:1,tier:1,requires:{necro_lumber:10},icon:"lumbermill"},necro_quarries:{slot:{x:0,y:4},maxLevel:1,tier:1,requires:{necro_stone:10},icon:"quarrying"},necro_librarystacks:{slot:{x:-4,y:4},maxLevel:1,tier:1,requires:{necro_lumber:5},enableFeatures:["sanctum"],icon:"bookshelf"},necro_expanded_mind:{slot:{x:4,y:3},tier:1,maxLevel:1,requires:{necro_cheaper_workers:10},icon:"expanded-mind"},necro_meditation:{slot:{x:4,y:4},tier:1,requires:{necro_expanded_mind:1},multipliers:e=>({expanded_mind_duration:1+.03*e}),icon:"meditation"},necro_obelisks:{slot:{x:2,y:4},maxLevel:1,tier:1,requires:{necro_stone:5,necro_cheaper_workers:10},icon:"leylines"},necro_obeliskstorage:{slot:{x:2,y:5},tier:1,currencyCost:()=>({stone:1.25}),requires:{necro_obelisks:1},modifiers:e=>({obelisk_storage:1.5*e}),icon:"obeliskstorage"},necro_centralization:{slot:{x:0,y:6},tier:2,maxLevel:1,currencyCost:()=>({lumber:2,stone:2}),requires:{necro_lumbermill:1,necro_quarries:1,necro_obelisks:1},enableFeatures:["courtyard"],storage:()=>({lumber:300,stone:300}),specialRequires:(e,t)=>t.persistent.buildingLevels.lumbermill>=5&&t.persistent.buildingLevels.quarry>=5,icon:"evil-tower",event:"dying"},necro_mining:{slot:{x:0,y:7},tier:2,maxLevel:1,currencyCost:()=>({lumber:1}),requires:{necro_centralization:1},modifiers:()=>({quarry_ores:15}),income:(e,t)=>({ore:k(t,0,"basic_ore")*t.persistent.activeWorkers.mines}),hideIncome:["ore"],icon:"mine"},necro_smelting:{slot:{x:0,y:8},tier:2,maxLevel:1,currencyCost:()=>({ore:.25}),modifiers:()=>({storageyard_metals:15}),requires:{necro_mining:1},icon:"smelting"},necro_smeltingworkers:{slot:{x:4,y:9},tier:2,currencyCost:()=>({metal:.5}),modifiers:e=>({smelter_workers:.4*e}),enableFeatures:["job_courtyard"],requires:{necro_smelting:1,necro_vigormortis:1},hidden:e=>!$(e),icon:"coal-pile"},necro_metaltools:{slot:{x:0,y:9},tier:2,currencyCost:()=>({metal:.5}),multipliers:e=>({basic_stone:1+.03*e,basic_lumber:1+.03*e}),requires:{necro_smelting:1},icon:"anvil-impact"},necro_crystalmining:{slot:{x:0,y:10},tier:2,requires:{necro_metaltools:1},modifiers:e=>({quarry_crystal_storage:5,basic_crystal:.02*e}),income:(e,t)=>({crystal:k(t,0,"basic_crystal")*t.persistent.activeWorkers.mines}),hideIncome:["crystal"],icon:"crystal-mining"},necro_ossuaries:{slot:{x:2,y:7},tier:2,maxLevel:1,currencyCost:()=>({stone:1.5}),requires:{necro_centralization:1},icon:"crypt"},necro_vigormortis:{slot:{x:2,y:8},tier:2,maxLevel:1,currencyCost:()=>({bones:3}),requires:{necro_ossuaries:1},icon:"ribcage"},necro_phylactery:{slot:{x:0,y:11},maxLevel:1,tier:3,currencyCost:()=>({mana:2,bones:1,metal:.5,crystal:.5}),requires:{necro_crystalmining:3},hidden:e=>$(e),icon:"phylactery"},necro_crystaldust:{slot:{x:-2,y:11},maxLevel:1,tier:3,currencyCost:()=>({crystal:.5}),requires:{necro_crystalmining:10,necro_ectostorage:5},storage:()=>({crystaldust:300}),hidden:e=>!$(e),icon:"crystal-dust"},necro_shrines:{slot:{x:-2,y:7},tier:2,maxLevel:1,currencyCost:()=>({bones:3,stone:1.5,lumber:.5}),storage:()=>({ectoplasm:125}),requires:{necro_centralization:1},hidden:e=>!$(e),icon:"shrine"},necro_librarians:{slot:{x:-4,y:8},tier:2,currencyCost:e=>({ectoplasm:.25}),multipliers:e=>({stacks_research:1+.025*e}),requires:{necro_shrines:1,necro_librarystacks:1},icon:"librarians"},necro_ectostorage:{slot:{x:-2,y:9},tier:3,currencyCost:e=>({ectoplasm:.25,bones:1.25}),modifiers:e=>({ossuary_ectoplasm_storage:2.5*e}),requires:{necro_shrines:1,necro_ossuaries:1},icon:"ectostorage"},necro_deadlang:{slot:{x:-4,y:9},tier:3,multipliers:e=>({obelisk_income:1+.03*e}),requires:{necro_librarians:10},icon:"wax-tablet"},necro_military:{slot:{x:2,y:10},maxLevel:1,tier:3,currencyCost:()=>({metal:1,lumber:1,bones:3}),requires:{necro_metaltools:10},hidden:e=>!$(e),enableFeatures:["military","military_necro_soldier"],icon:"barracks"},necro_soldier_armor:{slot:{x:4,y:11},tier:3,currencyCost:e=>({metal:1}),requires:{necro_military:1,necro_smeltingworkers:1},multipliers:e=>({necro_soldier_armor:1+.04*e}),hidden:e=>!$(e),icon:"skull-shield"},necro_palisades:{slot:{x:2,y:11},tier:3,maxLevel:1,currencyCost:e=>({lumber:3,stone:.5}),requires:{necro_military:1},requiresVictories:()=>1,modifiers:()=>({fortifications_repair:1}),icon:"palisade"},necro_archery:{slot:{x:4,y:12},tier:3,maxLevel:1,currencyCost:e=>({lumber:1,bones:1}),requires:{necro_palisades:1},enableFeatures:["military_necro_archer"],icon:"archery"},necro_firearrows:{slot:{x:4,y:13},tier:3,currencyCost:e=>({ectoplasm:.5}),requires:{necro_archery:1,necro_shrines:1},multipliers:e=>({necro_archer_attack:1+.04*e}),enableFeatures:["military_necro_archer"],icon:"flaming-arrow"},necro_shrine_assistants:{slot:{x:-6,y:9},tier:3,currencyCost:e=>({bones:3}),requires:{necro_librarians:10},icon:"candles",modifiers:e=>({shrine_workers:.3*e})},necro_scriptorium:{slot:{x:-4,y:10},tier:3,maxLevel:1,currencyCost:()=>({ectoplasm:1,crystal:.25}),requires:{necro_ectostorage:10,necro_deadlang:10},icon:"quill-ink"},necro_scriptoriumworkers:{slot:{x:-6,y:11},tier:3,currencyCost:()=>({bones:1.25,crystal:.1}),modifiers:e=>({scriptorium_workers:.4*e}),requires:{necro_scriptorium:1,necro_shrine_assistants:10},enableFeatures:["job_sanctum"],icon:"book-pile"},necro_pillaging:{slot:{x:6,y:12},tier:3,currencyCost:()=>({stone:.25,lumber:.25}),multipliers:e=>({spoils_lumber:1+.12*e,spoils_stone:1+.12*e,spoils_ore:1+.08*e}),requires:{necro_palisades:1},enableFeatures:["spoils_ore"],icon:"swap-bag"},necro_orestore:{slot:{x:6,y:10},tier:3,currencyCost:()=>({stone:1}),modifiers:e=>({storageyard_metals:3*e,storageyard_ore:3*e}),requires:{necro_smeltingworkers:10},icon:"coal-wagon"},necro_metamagic:{slot:{x:-4,y:13},tier:3,maxLevel:5,currencyCost:()=>({crystal:1}),modifiers:e=>({metamagic_level:e}),requires:{necro_brainstorm:1,necro_deeptrance:10},icon:"burning-book"},necro_deeptrance:{slot:{x:-2,y:12},tier:3,currencyCost:()=>({crystaldust:.1}),modifiers:e=>({expanded_mind_mana_income:.12*e}),requires:{necro_crystaldust:1,necro_expanded_mind:1},icon:"steam"},necro_brainstorm:{slot:{x:-4,y:12},tier:3,maxLevel:1,currencyCost:()=>({crystaldust:.1}),requires:{necro_crystaldust:1,necro_scriptorium:1},icon:"brainstorm"},necro_workshops:{slot:{x:0,y:12},tier:3,maxLevel:1,currencyCost:e=>({metal:.5,stone:.75}),requires:{necro_palisades:1},icon:"sword-smithing"},necro_morestorage:{slot:{x:6,y:11},tier:3,currencyCost:e=>({lumber:.5,stone:.5}),multipliers:e=>({storageyard_lumber:1+.04*e,storageyard_stone:1+.04*e}),requires:{necro_orestore:10},icon:"pulley-hook"},necro_workshopstorage:{slot:{x:2,y:13},tier:3,currencyCost:e=>({lumber:.25,stone:.75}),modifiers:e=>({workshop_storage_lumber:5*e,workshop_storage_stone:5*e,workshop_storage_crystal:1*e}),requires:{necro_workshops:1},icon:"chest"},necro_bonepillaging:{slot:{x:6,y:13},tier:4,requires:{necro_pillaging:5},multipliers:e=>({ossuary_bones_storage:1+.08*e,spoils_bones:1+.14*e}),enableFeatures:["spoils_bones"],icon:"graveyard"},necro_tomepillaging:{slot:{x:6,y:14},tier:4,maxLevel:1,requires:{necro_bonepillaging:10},enableFeatures:["spoils_tomes"],storage:()=>({tomes:150}),icon:"secret-book"},necro_tomestorage:{slot:{x:6,y:15},tier:4,requires:{necro_tomepillaging:1},currencyCost:e=>({tomes:.001}),modifiers:e=>({stacks_tomestorage:1*e}),icon:"classical-knowledge"},necro_revenants:{slot:{x:0,y:14},maxLevel:1,tier:4,currencyCost:()=>({crystaldust:.1,ectoplasm:.25,bones:.65}),requires:{necro_workshops:1,necro_crystalassay:1},enableFeatures:["military","military_necro_revenant"],icon:"haunting"},necro_crystalassay:{slot:{x:-2,y:13},tier:4,maxLevel:1,currencyCost:e=>({metal:.75,ore:1,crystal:.15}),requires:{necro_deeptrance:1},icon:"pestle-mortar"}},T=En;var Rn={currency_research:"Research",currency_research_lore:"The Buried Library teems with secrets, ancient and powerful. Rigorous study of a variety of topics from arcane rituals to military strategy and engineering will expand your potential for development.",currency_prestige:"Soul Essence",currency_prestige_lore:"Your mortal flesh is gone, but your soul is more powerful than ever. You hunger now for nothing but to take the soul essence of others and add it to your own.",currency_prestige_description:"This is your prestige resource. It is stored within your phylactery and persists across reincarnations. You can spend it on permanent upgrades in the Phylactery tab.",currency_prestige_storage:"Unspent Soul Essence",currency_prestigescraps:"Soul Fragments",currency_prestigescraps_lore:"The weak, pale remnants of living souls you have stolen in conquest. It seems absorbing them into the roiling soul essence within you will not be as straightforward as you initially thought.",currency_prestigescraps_description:"While they cannot be spent on upgrades yet, these fragments have the potential to be converted into Soul Essence. Most events that trigger reincarnation will convert a portion of these fragments into usable Soul Essence for your next run.",currency_prestigescraps_storage:"Accumulated Soul Fragments",currency_mana:"Mana",currency_mana_lore:"The magical energy that fills the universe, capable of flattening mountains, boiling the sea, raising the dead and everything in between. The greater your reserves of mana, the greater deeds you will be able to perform.",currency_mana_storage:"Mana Pool",currency_mana_limit:"Capacity",currency_mana_income:"Generation",currency_bones:"Bones",currency_bones_lore:"The skeletal remnants of once-living beings, useful for a variety of grim purposes in the hands of a skilled necromancer.",currency_flesh:"Flesh",currency_flesh_lore:"The fleshy remnants of once-living beings. Harder to store and to work with, but useful for a variety of necromantic purposes.",currency_lumber:"Lumber",currency_lumber_lore:"Wood harvested and processed into a suitable form for large-scale construction.",currency_stone:"Stone",currency_stone_lore:"Rocks are abundant in nature and can be fashioned, with some work, into a useful and long-lasting material for construction and manufacturing.",currency_ore:"Ore",currency_ore_lore:"These minerals are streaked with valuable metals. Before they can be put to productive use, the ores have to be smelted to extract the metal.",currency_metal:"Ingots",currency_metal_lore:"Pure metals like copper, tin and iron cast into ingots, ready to be used in manufacturing.",currency_crystal:"Dragonsblood",currency_crystal_lore:"Despite the name, it is not literally blood, but a deep green gemstone mineral with certain useful magical properties.",currency_crystaldust:"Arcane Dust",currency_crystaldust_lore:"Finely ground dragonsblood crystal dust, useful for enhancing the potency of spells or alchemical preparations.",currency_ectoplasm:"Ectoplasm",currency_ectoplasm_lore:"These spectral emanations originate from the wrathful ghosts of the Witchwood, and can be used to facilitate contact with the spirit realm.",currency_tomes:"Arcana",currency_tomes_lore:"Secret knowledge of ancient sorcerers, once stolen from the library, now returned to their rightful place by your hand.",tech_basic_necromancy:"Necromancy",tech_basic_necromancy_lore:"The lugubrious magical art of mastery over death. This path promises untold power and eternal life, at the cost of forever becoming an outcast from ordinary society. Well, you never needed them anyway.",tech_necro_workers:"Skeletal Minions",tech_necro_workers_lore:"What good is a master without minions? The first thing you must learn is how to animate dead bones into living skeletal servants to do the heavy lifting for you. Until then, you will have to make do with whatever scraps of bone you can find yourself.",tech_necro_workers_description:"Enables the <span class='Spell'>Raise Skeletal Drudge</span> spell, which creates mindless workers out of bones.",tech_necro_bone_scavenging:"Bone Scavenging",tech_necro_bone_scavenging_lore:"The wastelands surrounding the Buried Library contain the remnants of numerous old, forgotten battlefields. Your drudges could dig up these ancient bones for your use.",tech_necro_bone_scavenging_description:"Enables assigning workers to the <span class='Wastelands'>Wastelands</span>.",tech_necro_bone_scavenging_specialreq:"Requires 3 or more Skeletal Drudges",tech_necro_cheaper_workers:"Dark Incantations",tech_necro_cheaper_workers_lore:"Your initial attempts at creating skeletal servants were awkward and clumsy from inexperience. With some work, you can refine the drudge creation spell to be less taxing on your magical reserves.",tech_necro_bone_piles:"Bone Piles",tech_necro_bone_piles_lore:"Now that your drudges are bringing in the bones, a better storage solution is required. You don't yet have the materials to build some proper storage, so for now you'll have to settle for your workers at least organizing them into piles rather than dumping them all over the place.",tech_necro_lumber:"Woodcutting",tech_necro_lumber_lore:"You won't get far without some basic construction materials, and the simplest material available is wood. Some primitive axes fashioned from stone and bone should help get some lumber production started.",tech_necro_lumber_description:"Enables assigning workers to the <span class='Forest'>Witchwood</span>.",tech_necro_stone:"Rockbreaking",tech_necro_stone_lore:"If you are to build an empire, you're going to need construction materials. A nearby canyon has plenty of rock that your drudges should be able to extract and fashion into rough stone blocks.",tech_necro_stone_description:"Enables assigning workers to <span class='Mines'>Spine Canyon</span>.",tech_necro_lumbermill:"Lumber Processing",tech_necro_lumbermill_lore:"Once trees are cut down, they need to be processed into useful lumber. Constructing sites in the forest for this purpose would serve to improve the flow of lumber as well as provide intermediate storage.",tech_necro_lumbermill_description:"Enables building the <span class='Building'>Lumber Mill</span>, which increases lumber income and storage.",tech_necro_quarries:"Quarrying",tech_necro_quarries_lore:"Organizing your rock extraction efforts around open-pit mines with nearby support facilities will allow you to greatly increase the flow of quality building materials.",tech_necro_quarries_description:"Enables building the <span class='Building'>Quarry</span>, which increases stone income and storage.",tech_necro_expanded_mind:"Ancient Incense",tech_necro_expanded_mind_lore:"In a corner of a dusty storage room in the Buried Library, you find a collection of ancient incense jars that, miraculously, remain sealed and in perfect condition. Some of the tomes you've read suggest these can be used to heighten your awareness of the spirit realm.",tech_necro_expanded_mind_description:"Enables the <span class='Spell'>Spirit Trance</span> spell, which temporarily increases your mana capacity.",tech_necro_meditation:"Meditation",tech_necro_meditation_lore:"The mind-expanding power of the incense you found can be combined with meditation techniques to extend how long you can keep your mind open to the realm beyond.",tech_necro_librarystacks:"Cataloguing",tech_necro_librarystacks_lore:"Whoever once inhabitated the library left it in pretty poor shape, and most of the original records have long since crumbled to dust, making it hard to find what you're looking for. Organizing the library's contents according to a simple indexing system of your own devising should help.",tech_necro_librarystacks_description:"Enables building the <span class='Building'>Library Stacks</span>, which increases your <span class='Currency CurrencyResearch'>Research</span> speed.",tech_necro_obelisks:"Leylines",tech_necro_obelisks_lore:"The land is criss-crossed by networks of magical energy called leylines that can be tapped into to fuel your spells. Although the wastelands are far from optimal in this regard, their potential still greatly exceeds what you can do with only your own innate mana.",tech_necro_obelisks_description:"Enables building <span class='Building'>Obelisks</span>, which increase your mana generation.",tech_necro_obeliskstorage:"Runed Stelae",tech_necro_obeliskstorage_lore:"Augmenting your obelisks with a network of smaller, supporting monuments may enable them to hold onto mana for longer without channeling it directly into you, effectively increasing how much mana is available to you at any one time.",tech_necro_centralization:"Secure the Heartland",tech_necro_centralization_lore:"With a steady supply of lumber and stone now available, the time has come to turn the area immediately surrounding the Buried Library into a defensible position to act as the center of administration and production for your empire of death.",tech_necro_centralization_description:"Enables building the <span class='Building'>Storage Yard</span>, which increases your storage capacity for <span class='Currency CurrencyLumber'>Lumber</span> and <span class='Currency CurrencyStone'>Stone</span>.",tech_necro_centralization_specialreq:"Requires Lumber Mill level 5 and Quarry level 5",tech_necro_mining:"Drift Mining",tech_necro_mining_lore:"The walls of Spine Canyon are rich with a variety of metal ores. Extracting them will allow you to significantly improve many aspects of your economy.",tech_necro_mining_description:"Enables building the <span class='Building'>Mine</span>, which extracts <span class='Currency CurrencyOre'>Ore</span> containing valuable metals.",tech_necro_smelting:"Ore Smelting",tech_necro_smelting_lore:"Most of the ore brought back from Spine Canyon can't be processed into useful metal simply by heating it over a fire. In order to increase your yields, a dedicated facility that can handle the complex (and very hot) reactions involved is needed.",tech_necro_smelting_description:"Enables building the <span class='Building'>Smelter</span>, which converts <span class='Currency CurrencyOre'>Ore</span> into <span class='Currency CurrencyMetal'>Ingots</span>.",tech_necro_smeltingworkers:"Furnace Attendants",tech_necro_smeltingworkers_lore:"Efficient ore smelting requires careful attention to temperature and a consistent supply of fuel. Stationing a few extra workers at the smelters should help.",tech_necro_smeltingworkers_description:"Enables assigning workers to the <span class='Courtyard'>Bailey</span>.",tech_necro_crystalmining:"Dragonsblood Deposits",tech_necro_crystalmining_lore:`The tomes describe the dark green crystal deposits recently discovered in the mines as "dragon's blood", and claims the mineral has a natural ability to absorb and transform mana. Some must be acquired at once.`,tech_necro_ossuaries:"Ossuaries",tech_necro_ossuaries_lore:"You have some new ideas for things you could do to improve your skeletal minions, but you need better access to raw materials first. Constructing a dedicated storage space close to your sanctum will help make sure you always have enough on hand for your experiments.",tech_necro_ossuaries_description:"Enables building the <span class='Building'>Ossuary</span>, which increases your storage capacity for <span class='Currency CurrencyBones'>Bones</span>.",tech_necro_vigormortis:"Reinforced Ribcages",tech_necro_vigormortis_lore:"The relatively fragile nature of bone makes it hard for your drudges to perform as well as a living creature. However, with some key magical augmentation, you might be able to increase their productive capabilities on a temporary basis, at least.",tech_necro_vigormortis_description:"Enables the <span class='Spell'>Vigor Mortis</span> spell, which temporarily increases resource production.",tech_necro_phylactery:"Phylactery",tech_necro_phylactery_lore:"Feverish, fingers trembling, you flip the pages of the dusty book before you. Could it be? The grimoire claims that propery prepared dragonsblood gemstones can be made to absorb and contain the soul of a living being, either to enslave them... or to grant them eternal life. This is it. This is what you've been looking for. You must spare no effort in crafting the device.",tech_necro_phylactery_description:"Enables you to craft a <span class='Spell'>Phylactery</span> in which to store your soul, granting you eternal life. Hopefully. Once ready, you will be able to cast a spell to finalize the process.",tech_necro_crystaldust:"Crystal Grinding",tech_necro_crystaldust_lore:"Raw dragonsblood crystals can hold and conduct mana, but only to a certain degree. Carefully grinding them into a fine powder should improve these qualities. This is a delicate process that can't be entrusted to your drudges.",tech_necro_crystaldust_description:"Enables the <span class='Spell'>Craft Arcane Dust</span> spell, which creates <span class='Currency CurrencyCrystaldust'>Arcane Dust</span> from <span class='Currency CurrencyCrystal'>Dragonsblood</span>.",tech_necro_metamagic:"Empowered Magic",tech_necro_metamagic_lore:"The mana-conducting properties of dragonsblood dust can greatly amplify the effects of your spells. Intense study will be required, but you're optimistic that the meta-magical principles can be applied broadly.",tech_necro_metamagic_description:"Enables casting higher-rank versions of many of your spells, at the cost of <span class='Currency CurrencyCrystaldust'>Arcane Dust</span> and higher <span class='Currency CurrencyMana'>Mana</span> cost.",tech_necro_shrines:"Spirit Communion",tech_necro_shrines_lore:"The Witchwood is haunted by the angry spirits of heretics, sorcerers and others who were unjustly executed for their so-called crimes. By constructing a shrine in the forest, you may be able to commune with those spirits and recruit them to your cause.",tech_necro_shrines_description:"Enables building the <span class='Building'>Shrine</span>, which generates <span class='Currency CurrencyEctoplasm'>Ectoplasm</span>.",tech_necro_librarians:"Spectral Librarians",tech_necro_librarians_lore:"Among the many executed criminals that now haunt the Witchwood are several would-be sorcerers whose hunger for arcane knowledge has not abated in death. Allow them free reign of your library, and they may assist your research efforts.",tech_necro_ectostorage:"Ghost Jars",tech_necro_ectostorage_lore:"Spectral ectoplasm is highly unstable, discorporating into the spirit realm before long. However, you might be able to preserve it longer by allowing it to fuse with properly prepared vessels that can be stored in your ossuaries.",tech_necro_military:"Army of the Dead",tech_necro_military_lore:"Freed from mortal concerns, the time has come to direct your attention towards the subjugation of those who once exiled you. The lands of the living will provide ample soul essence to fuel your newfound powers.",tech_necro_military_description:"Enables the Military tab and the <span class='Spell'>Raise Skeletal Warrior</span> spell, which creates a simple infantry soldier for your army.",tech_necro_soldier_armor:"Forged Shields",tech_necro_soldier_armor_lore:"Bone, even animated by your dark magic, is relatively fragile. Your skeleton warriors are too unstable to wear a full suit of armor, but they should be able to carry some shields.",tech_necro_palisades:"Military Fortifications",tech_necro_palisades_lore:"With the threat of invasion looming on the horizon, the need to develop some rudimentary fortifications becomes more pressing.",tech_necro_palisades_description:"Enables building the <span class='Building'>Palisade Wall</span>, which provides defensive bonuses when defending against invading armies.",tech_necro_archery:"Bone Archers",tech_necro_archery_lore:"Basic fortifications are well and good, but you could make better use of them if you had access to soldiers capable of attacking at range.",tech_necro_archery_description:"Enables the <span class='Spell'>Raise Skeletal Bowman</span> spell, which creates a ranged infantry soldier for your army.",tech_necro_firearrows:"Ghostfire Arrows",tech_necro_firearrows_lore:"Cold, ectoplasmic fire can enhance the effect of your bowmen's arrows, and unlike normal fire, carries no risk of accidentally setting them alight.",tech_necro_metaltools:"Metal Tools",tech_necro_metaltools_lore:"Until now, you've had to do with tools made of stone and whatever your minions have been able to scavenge. Now, with a stable source of iron, you can give them proper tools to work with.",tech_necro_workshops:"Organized Manufacturing",tech_necro_workshops_lore:"As your empire grows increasingly militarized, the need for a dedicated facility for the production and maintenance of the means of war has become apparent.",tech_necro_workshops_description:"Enables building the <span class='Building'>Workshop</span>, which reduces the cost of deploying military units.",tech_necro_deadlang:"Ancient Lexicography",tech_necro_deadlang_lore:"Many of the texts in the library are written in a strange, dead language. By improving your understanding of it, you might be able to refine the runic structure of your obelisks, increasing their potential.",tech_necro_shrine_assistants:"Ritual Preparation",tech_necro_shrine_assistants_lore:"The complex rituals required to allow spirits to manifest are rather taxing. Your laborers can handle some of the menial tasks involved in the shrine rituals, leaving you to focus on matters spiritual.",tech_necro_scriptorium:"Original Research",tech_necro_scriptorium_lore:"Your ghostly minions, having feasted on the great volumes of lore held in the library, are now eager to begin experimenting and writing new volumes of their own. To this end, they require a dedicated space to work.",tech_necro_scriptorium_description:"Enables building the <span class='Building'>Scriptorium</span>, which further increases your <span class='Currency CurrencyResearch'>Research</span> speed.",tech_necro_scriptoriumworkers:"Research Assistants",tech_necro_scriptoriumworkers_lore:"Ghostly scholars have one major problem, aside from their raging, obsessive madness: carrying books between the stacks and the scriptorium is difficult when you're barely able to manifest physically in the first place. Fortunately, your drudges can help with that.",tech_necro_scriptoriumworkers_description:"Enables assigning workers to the <span class='Sanctum'>Inner Sanctum</span>.",tech_necro_pillaging:"Pillaging",tech_necro_pillaging_lore:"The lands of the living are a treasure trove not merely of soul fragments, but of natural resources like stone and lumber as well. Making a concerted effort to bring back anything that looks valuable is sure to increase the profits from your military operations.",tech_necro_pillaging_description:"Spoils of battle may now also include <span class='Currency CurrencyOre'>Ore</span>.",tech_necro_orestore:"Ore Bins",tech_necro_orestore_lore:"As your metal production scales up, establishing a stronger supply line of smeltable ore has become paramount, and with that comes the need to find someplace to store it all.",tech_necro_tomepillaging:"Secret Lore",tech_necro_tomepillaging_lore:"As your research delves deeper, it becomes clear that many volumes are missing from the Buried Library. Other texts mention that they were likely stolen a long time ago by jealous sorcerers. These works must be retrieved from the lands of the living and incorporated into your research.",tech_necro_tomepillaging_description:"Spoils of battle may now also include <span class='Currency CurrencyTomes'>Arcana</span>.",tech_necro_tomestorage:"Foreign Books Section",tech_necro_tomestorage_lore:"Lest they be lost among the piles of ancient lore, the books and scrolls looted from the lands of the living should be stored in a dedicated section.",tech_necro_bonepillaging:"Empty the Graveyards",tech_necro_bonepillaging_lore:"Up to now, your soldiers have merely brought back the bones of the recently fallen, but wherever there are living people there are graveyards and crypts teeming with old bones waiting to be dug up and added to your collection.",tech_necro_revenants:"Spectral Incarnation",tech_necro_revenants_lore:"You've made a tremendous discovery: treating bones with dragonsblood dust makes them excellent ectoplasmic vessels, allowing you at last to create a warrior with passable intelligence by allowing a spirit to possess a skeletal construct.",tech_necro_revenants_description:"Enables the <span class='Spell'>Raise Revenant</span> spell, which creates an evasive soldier with high attack power for your army.",tech_necro_deeptrance:"Crystal Incense",tech_necro_deeptrance_lore:"The books mention theorizing that the incense you use for your meditation sessions could be enhanced by infusing it with dragonsblood dust, but that this was deemed too hazardous for living beings. Well, you are no longer living, so that poses no barrier for you.",tech_necro_brainstorm:"Intense Study",tech_necro_brainstorm_lore:"As your empire grows, you seem to find less and less time to spend immersing yourself in research, but when you do find the time, it's all the more important to not let your mind wander.",tech_necro_brainstorm_description:"Enables the <span class='Spell'>Brainstorm</span> spell, which boosts your research rate.",tech_necro_crystalassay:"Dragonsblood Assaying",tech_necro_crystalassay_lore:"Even ordinary ore occasionally contains trace amounts of dragonsblood. A simple process can be devised to detect it and feed the ore through drudge-operated grinders and filters to produce arcane dust. The yield is much lower than what you can grind on your own, but won't consume precious gem-grade dragonsblood.",tech_necro_crystalassay_description:"Enables building the <span class='Building'>Ore Grinder</span>, which converts <span class='Currency CurrencyOre'>Ore</span> into <span class='Currency CurrencyCrystaldust'>Arcane Dust</span>.",tech_necro_morestorage:"Gantry Cranes",tech_necro_morestorage_lore:"As your stockpile of material resources grows, so does the need for efficient means of moving all that bulk around. A system of rope and pulley systems attached to a movable gantry should help make the most out of the space available.",tech_necro_workshopstorage:"Storehouses",tech_necro_workshopstorage_lore:"Your new workshops promise military invention like never before seen, but in order to do so effectively, they need to be well supplied with resources.",prestige_brilliance:"Undead Intellect",prestige_brilliance_lore:"Shedding your mortal coil has opened your mind to possibilities you'd never before considered. Untethered from your old flesh, it's as if you can think clearly for the first time ever.",prestige_manaregen:"Concentration",prestige_manaregen_lore:"Swirling magical enemy fills the cavity in your skull where once was a meager, soft brain. Magic flows more easily through you than ever before.",prestige_betterbooks:"Rare Books",prestige_betterbooks_lore:"Your ability to locate the most important and valuable books is slowly improving. You feel like you understand the library a little better with each reincarnation.",prestige_drudge_mastery:"Drudge Mastery",prestige_drudge_mastery_lore:"Practice pays dividends; you've raised so many skeletal workers now that you can do it almost without thinking.",prestige_spell_queue:"Sequential Casting",prestige_spell_queue_lore:"Spells flow easily from your mind, like clear water from a spring. In time, they will become a mighty river, sweeping away your foes.",prestige_spell_queue_description:"Enables the Spell Queue. Any time you attempt to cast a spell you can't afford, it will instead be queued and automatically cast once you do have the resources to cast it.",prestige_morestorage:"Organizer",prestige_morestorage_lore:"Your mind's eye is opened to the joy of efficient organization; boxes, crates, barrels, all will be lined up in perfect, maximally efficient order.",prestige_records:"Hall of Records",prestige_records_lore:"You have accomplished much in little time, and the future holds the promise of even greater glory. It's time to immortalize your deeds.",prestige_records_description:"Enables the Records tab, where you can review statistics and achievements you've completed. Completing achievements now also grants a modest global productivity increase.",modifier_bone_scavenging:"<span class='Currency CurrencyBones'>Bones Income</span> +{0}/s per <span class='Wastelands'>Wastelands</span> worker",modifier_basic_lumber:"<span class='Currency CurrencyLumber'>Lumber Income</span> +{0}/s per <span class='Forest'>Witchwood</span> worker",multiplier_basic_lumber:"<span class='Currency CurrencyLumber'>Lumber Income</span> from <span class='Forest'>Witchwood</span> workers +{0}%",modifier_basic_stone:"<span class='Currency CurrencyStone'>Stone Income</span> +{0}/s per <span class='Mines'>Spine Canyon</span> worker",multiplier_basic_stone:"<span class='Currency CurrencyStone'>Stone Income</span> from <span class='Mines'>Spine Canyon</span> workers +{0}%",modifier_basic_ore:"<span class='Currency CurrencyOre'>Ore Income</span> +{0}/s per <span class='Mines'>Spine Canyon</span> worker",multiplier_basic_ore:"<span class='Currency CurrencyOre'>Ore Income</span> from <span class='Mines'>Spine Canyon</span> workers +{0}%",modifier_scriptorium_research:"<span class='Currency CurrencyResearch'>Research</span> +{0}/s per <span class='Sanctum'>Inner Sanctum</span> worker",modifier_basic_crystal:"<span class='Currency CurrencyCrystal'>Dragonsblood Income</span> +{0}/s per <span class='Mines'>Spine Canyon</span> worker",multiplier_basic_crystal:"<span class='Currency CurrencyCrystal'>Dragonsblood Income</span> from <span class='Mines'>Spine Canyon</span> workers +{0}%",multiplier_stacks_research:"<span class='Building'>Library Stacks:</span> <span class='Currency CurrencyResearch'>Research Income</span> +{0}%",modifier_stacks_tomestorage:"<span class='Building'>Library Stacks:</span> <span class='Currency CurrencyTomes'>Arcana Storage</span> +{0}",multiplier_scriptorium_research:"<span class='Building'>Scriptorium:</span> <span class='Currency CurrencyResearch'>Research Income</span> +{0}%",modifier_obelisk_storage:"<span class='Building'>Obelisk:</span> <span class='Currency CurrencyMana'>Mana Capacity</span> +{0}",multiplier_obelisk_income:"<span class='Building'>Obelisk:</span> <span class='Currency CurrencyMana'>Mana Generation</span> +{0}%",multiplier_shrine_income:"<span class='Building'>Shrine:</span> <span class='Currency CurrencyEctoplasm'>Ectoplasm Income</span> +{0}%",modifier_shrine_workers:"<span class='Building'>Shrine:</span> <span class='Currency CurrencyEctoplasm'>Ectoplasm Income</span> +{0}% per <span class='Forest'>Witchwood</span> worker",modifier_storageyard_lumber:"<span class='Building'>Storage Yard:</span> <span class='Currency CurrencyLumber'>Lumber Storage</span> +{0}",multiplier_storageyard_lumber:"<span class='Building'>Storage Yard:</span> <span class='Currency CurrencyLumber'>Lumber Storage</span> +{0}%",modifier_storageyard_stone:"<span class='Building'>Storage Yard:</span> <span class='Currency CurrencyStone'>Stone Storage</span> +{0}",multiplier_storageyard_stone:"<span class='Building'>Storage Yard:</span> <span class='Currency CurrencyStone'>Stone Storage</span> +{0}%",modifier_storageyard_metals:"<span class='Building'>Storage Yard:</span> <span class='Currency CurrencyMetal'>Metals Storage</span> +{0}",modifier_storageyard_ore:"<span class='Building'>Storage Yard:</span> <span class='Currency CurrencyOre'>Ore Storage</span> +{0}",modifier_quarry_ores:"<span class='Building'>Quarry:</span> <span class='Currency CurrencyOre'>Ore Storage</span> +{0}",modifier_quarry_crystal_storage:"<span class='Building'>Quarry:</span> <span class='Currency CurrencyCrystal'>Dragonsblood Storage</span> +{0}",modifier_workshop_storage_lumber:"<span class='Building'>Workshop:</span> <span class='Currency CurrencyLumber'>Lumber Storage</span> +{0}",modifier_workshop_storage_stone:"<span class='Building'>Workshop:</span> <span class='Currency CurrencyStone'>Stone Storage</span> +{0}",modifier_workshop_storage_crystal:"<span class='Building'>Workshop:</span> <span class='Currency CurrencyCrystal'>Dragonsblood Storage</span> +{0}",modifier_ossuary_bones_storage:"<span class='Building'>Ossuary:</span> <span class='Currency CurrencyBones'>Bones Storage</span> +{0}",multiplier_ossuary_bones_storage:"<span class='Building'>Ossuary:</span> <span class='Currency CurrencyBones'>Bones Storage</span> +{0}%",modifier_ossuary_ectoplasm_storage:"<span class='Building'>Ossuary:</span> <span class='Currency CurrencyEctoplasm'>Ectoplasm Storage</span> +{0}",multiplier_ossuary_ectoplasm_storage:"<span class='Building'>Ossuary:</span> <span class='Currency CurrencyEctoplasm'>Ectoplasm Storage</span> +{0}%",modifier_smelter_workers:"<span class='Building'>Smelter:</span> Upkeep costs and <span class='Currency CurrencyMetal'>Ingot Income</span> +{0}% per <span class='Courtyard'>Bailey</span> worker",modifier_scriptorium_workers:"<span class='Building'>Scriptorium:</span> <span class='Currency CurrencyResearch'>Research Income</span> +{0}% per <span class='Sanctum'>Inner Sanctum</span> worker",multiplier_summon_skeleton_worker_cost:"<span class='Spell'>Raise Skeletal Drudge</span> <span class='Currency CurrencyMana'>Mana Cost</span> {0}%",multiplier_expanded_mind_duration:"<span class='Spell'>Spirit Trance:</span> Duration +{0}%",modifier_expanded_mind_mana_income:"<span class='Spell'>Spirit Trance:</span> <span class='Currency CurrencyMana'>Mana Generation</span> +{0}/s",multiplier_deploy_material_cost:"Material Deployment Costs {0}%",modifier_necro_soldier_armor:"<span class='MilitaryDefense'>Skeletal Warrior Toughness</span> +{0}",multiplier_necro_soldier_armor:"<span class='MilitaryDefense'>Skeletal Warrior Toughness</span> +{0}%",modifier_necro_archer_attack:"<span class='MilitaryAttack'>Skeletal Bowman Strength</span> +{0}",multiplier_necro_archer_attack:"<span class='MilitaryAttack'>Skeletal Bowman Strength</span> +{0}%",modifier_metamagic_level:"Maximum <span class='Spell'>Spell Rank</span> +{0}",modifier_spellqueue_max:"Maximum <span class='Spell'>Queued Spells</span> +{0}",modifier_fortifications:"<span class='FortStrength'>Fortification Strength</span> +{0}",modifier_fortifications_repair:"<span class='FortStrength'>Fortification Repair Speed</span> +{0}/s",multiplier_fortifications_repair:"<span class='FortStrength'>Fortification Repair Speed</span> +{0}%",multiplier_storage_mana:"<span class='Currency CurrencyMana'>Mana Capacity</span> +{0}%",multiplier_income_mana:"<span class='Currency CurrencyMana'>Mana Generation</span> +{0}%",multiplier_storage_bones:"<span class='Currency CurrencyBones'>Bones Storage</span> +{0}%",multiplier_storage_lumber:"<span class='Currency CurrencyLumber'>Lumber Storage</span> +{0}%",multiplier_storage_stone:"<span class='Currency CurrencyStone'>Stone Storage</span> +{0}%",multiplier_storage_ore:"<span class='Currency CurrencyOre'>Ore Storage</span> +{0}%",multiplier_spoils_lumber:"<span class='Currency CurrencyLumber'>Lumber</span> spoils from battle +{0}%",multiplier_spoils_stone:"<span class='Currency CurrencyStone'>Stone</span> spoils from battle +{0}%",multiplier_spoils_ore:"<span class='Currency CurrencyOre'>Ore</span> spoils from battle +{0}%",multiplier_spoils_bones:"<span class='Currency CurrencyBones'>Bones</span> spoils from battle +{0}%",spell_summon_skeleton_worker:"Raise Skeletal Drudge",spell_summon_skeleton_worker_lore:"Raising an entire corpse to unlife is a difficult process beyond the capabilities of fledgling necromancers. Fortunately, bones are much easier to work with; any old collection in roughly the correct configuration can make a plausible, if weak servant.",spell_summon_skeleton_worker_description:"Creates a Skeletal Drudge, a mindless worker that can perform a variety of tasks. The cost increases the more drudges you already have.",spell_expanded_mind:"Spirit Trance",spell_expanded_mind_lore:"By attuning your mind to the world beyond the veil of mortality, you can draw in more mana, and thus perform greater magical feats.",spell_vigormortis:"Vigor Mortis",spell_vigormortis_lore:"Strengthens the bones of your skeletal drudges, allowing them to chop faster and dig deeper.",spell_brainstorm:"Brainstorm",spell_brainstorm_lore:"Focuses your undead mind, significantly enhancing your ability to take in and process information for a brief period of time.",spell_phylactery:"Soul Transfer",spell_phylactery_lore:"The phylactery is ready. If everything goes as it should, it will accept your soul within it, and as long as it remains intact, you will live forever. Thus the books promise. Only the final step remains; to chant the sealing spell... and drive a dagger deep within your own heart, ending your current existence and reawakening you as something greater.",spell_phylactery_description:"<span class='Ascension'>This will reset your game. All progress up to this point will be lost, but you will be awakened to a greater potential and a new path in unlife. Further progress through the game will not be possible without taking this route.</span>",spell_craft_dust:"Craft Arcane Dust",spell_craft_dust_lore:"The delicate nature of the grinding process makes it suitable only for your own bony hands and wears the grindstone down quickly, but the resulting dust holds great promise.",spell_craft_dust_description:"Grinds dragonsblood crystals into <span class='Currency CurrencyCrystaldust'>Arcane Dust</span>. The process is not entirely predictable and the yield varies.",spell_summon_skeleton_warrior:"Raise Skeletal Warrior",spell_summon_skeleton_warrior_lore:"The same fundamental incantations that create your drudges, adapted to more military purposes.",spell_summon_skeleton_warrior_description:"Creates a Skeletal Warrior, a simple infantry soldier. The cost increases the more warriors you already have.",spell_summon_skeleton_archer:"Raise Skeletal Bowman",spell_summon_skeleton_archer_lore:"Enabling a skeleton to fire a bow effectively is going to require augmenting the enchantments holding their shoulder and arm joints together, at the expense of general stability.",spell_summon_skeleton_archer_description:"Creates a Skeletal Bowman, a ranged infantry soldier. The cost increases the more bowmen you already have.",spell_summon_revenant:"Raise Revenant",spell_summon_revenant_lore:"Fuses the spirit of a deceased warrior with a carefully prepared skeleton, creating an intelligent (if somewhat insane) warrior that is neither fully physical nor spectral in nature.",spell_summon_revenant_description:"Creates a Revenant, an evasive infantry soldier. The cost increases the more bowmen you already have.",building_lumbermill:"Lumber Mill",building_lumbermill_lore:"A processing facility for converting felled trees into planks and beams for use in construction.",building_quarry:"Quarry",building_quarry_lore:"An open-pit mine where rock is carved out of the sheer walls and carved into blocks to be used as building material.",building_librarystacks:"Library Stacks",building_librarystacks_lore:"These large, ornate bookcases serve as both storage and indexing system for the library's many tomes and scrolls.",building_obelisk:"Obelisk",building_obelisk_lore:"A towering carved stone pillar, etched with magical runes and placed at an intersection between leylines. It draws mana from the earth, recharging your reserves.",building_storageyard:"Storage Yard",building_storageyard_lore:"All lumber and stone harvested elsewhere in your empire ends up here sooner or later, where it can be stored safely for later dispatch to wherever it's needed.",building_metalmine:"Mine",building_metalmine_lore:"Shafts cut straight into the walls of the canyon for the purpose of the extraction of a variety of mineral ores.",building_ossuary:"Ossuary",building_ossuary_lore:"Dedicated chambers for the storage of skeletal parts, neatly organized in cubby holes and on shelves.",building_smelter:"Smelter",building_smelter_lore:"Large and incredibly hot furnaces that process raw mineral ores into workable metal.",building_shrine:"Shrine",building_shrine_lore:"This elaborate shrine facilitates communion with the angry spirits of the Witchwood, allowing them to materialize physically in exchange for some of your mana.",building_palisade:"Palisade Wall",building_palisade_lore:"A simple defensive structure consisting of sharpened wooden stakes rammed into the ground. Determined attackers can force their way through, but it's better than nothing.",building_workshop:"Workshop",building_workshop_lore:"Day and night, your minions toil here to make weapons, armor and fortifications for your empire.",building_scriptorium:"Scriptorium",building_scriptorium_lore:"Scholarly spirits and long-dead sorcerers congregate in these chambers to analyze the lore within the library, distilling and developing it into actionable research.",building_oregrinder:"Ore Grinder",building_oregrinder_lore:"First, a simple assaying agent is administered to separate the dragonsblood-bearing ore from the chaff, then it is ground in large tumblers, producing a certain amount of usable arcane dust.",military_necro_soldier:"Skeletal Warrior",military_necro_soldier_lore:"Little more than a drudge given a spear and some basic enchantments to improve its combat prowess. Nevertheless, they make decent fighters on fear factor alone, and will fight tirelessly without need for rest or food.",military_necro_archer:"Skeletal Bowman",military_necro_archer_lore:"Equipped with bows, these bony archers will fire volleys of arrows from a safe distance behind your front line infantry. Should the front line fall, they are much less effective.",military_necro_revenant:"Revenant",military_necro_revenant_lore:"A skeleton possessed by one of the wrathful spirits from the Witchwood. Their halfway existence between the physical and spiritual realms allows them to deftly avoid even the swiftest blows.",military_cpu_peasant:"Peasant Militia",military_cpu_peasant_lore:"This poor lot know little more than toil, and fight only by necessity, using improvised weapons hastily cobbled together from farming implements. Even the weakest member of your army should have no problem crushing them underfoot.",military_cpu_infantry_human:"Legionnaire",military_cpu_infantry_human_lore:"The rank and file of the armies of men. They have some training, and functional equipment, but are only truly effective in large numbers.",military_cpu_infantry_elven:"Elven Skirmisher",military_cpu_infantry_elven_lore:"Elven frontline infantry, equipped with curved polearms and lightweight armor. Their culture's preference for ranged combat leaves them somewhat under-equipped compared to their human and dwarven allies.",military_cpu_infantry_dwarven:"Dwarven Axeman",military_cpu_infantry_dwarven_lore:"Stout, resilient dwarven infantry, wielding heavy iron axes and thick mail.",militaryability_ethereal:"Ethereal",militaryability_ethereal_description:"Ignores 75% of the attacker's <span class='MilitarySkill'>Prowess</span> when defending and 25% of the defender's <span class='MilitaryDefense'>Toughness</span> when attacking.",tt_militaryclass_melee:"Infantry",tt_militaryclass_ranged:"Ranged Infantry",tt_militaryclass_cavalry:"Cavalry",tt_militaryclass_wizard:"Warmage",tt_militaryclass_siege:"Siege Engine",tt_military_skill:"Prowess:",tt_military_attack:"Strength:",tt_military_defense:"Toughness:",tt_military_stats_hint:"Prowess affects chance to hit or evade attacks. Strength and Toughness determine casualties when an attack does hit.",wartarget_human_village_a:["Fair","Yellow","Green","Summer","Swift","Bridge","Wall","Oak","Lily"],wartarget_human_village_b:["ton","ham","brook","field","shire","meadow","port","hill","vale"],wartarget_elven_village_a:["Thil\xFAn","F\xE9","Del\xE1n","F\xFAil","Ila","V\xE9al"],wartarget_elven_village_b:["dal","silan","duil","adris","odil","d\xF3r","dunan","sil","t\xFAan"],wartarget_dwarven_village_a:["R\xFB","Kom","Duna","Mor","Kh\xE2","Gama","Dr\xE2"],wartarget_dwarven_village_b:["zhur","hak","zhadum","drak","z\xE2n","nag","kor"],wartarget_human:"Human",wartarget_elven:"Elven",wartarget_dwarven:"Dwarven",wartarget_village:"Hamlet",ui_assault_header:"Launch Assault",ui_invaders_header:"Army of Light",ui_invaders_countdown:"Expected Arrival: ",ui_invaderanger_header:"Reckoning",ui_deploy_none:"None",ui_deploy_25:"25%",ui_deploy_50:"50%",ui_deploy_75:"75%",ui_deploy_all:"All",tt_deploy_header:"Deployment",tt_deploy_description:"This interface allows you to send your standing army on assaults against the lands of the living, earning you various resources. Each unit has a deployment cost that must be paid to start an assault. Select the number of each unit you wish to deploy, then select a war target from the list below.",tt_deploy_allocation_help:"Use the arrow buttons to change how many units of this type should be deployed. Selecting more than you have will result in all of them being deployed. Hold ctrl when clicking to add/remove 5 units at a time, or shift to add/remove all of your units of that type.",ui_battleresult_victory:"{0}: Victory!",ui_battleresult_victory_lore:"Your foes lie trampled underneath your army's heels, the spoils of victory yours for the taking. You are one step closer to the revenge you deserve.",ui_battleresult_defeat:"{0}: Defeat...",ui_battleresult_defeat_lore:"The sting of defeat is bitter indeed. The remains of your army lies crushed into the blood-soaked mud, and your foes' holdings yet stand. Alas, the day was not yours this time...",ui_battleresult_casualties:"Casualties:",ui_battleresult_spoils:"Spoils:",ui_wartargetbattle_title:"Invasion of {0}",ui_defensebattle_title:"Siege of the Library",ui_battle_side_you:"Your Forces",ui_battle_side_enemy:"Enemy Forces",ui_wartarget_population:"Population: {0}",ui_wartarget_defenders:"Defenders:",tt_battle_retreat:"Retreat",tt_battle_retreat_lore:"Caution is the better part of valor, bitter though it may be.",tt_battle_retreat_description:"If you feel a battle is not going your way, click this button to retreat and spare yourself any further casualties. Be aware, however, that war targets are always fought at their full strength no matter what.",tt_standingarmy_header:"Standing Army",tt_standingarmy_lore:"What cannot be taken with magic will be won through force of arms. With this army, you will lay waste to the insolent worms who scorned you.",tt_standingarmy_description:"This is your standing army. You can send them to assault any of the war targets listed below. While engaged in a battle elsewhere, any new units you create will remain at home. When defending against invasions, created units will instead immediately join the ongoing battle.",tt_fortstrength_header:"Fortifications",tt_fortstrength_lore:"Whether heavy stone ramparts or simple wooden palisades, nothing beats a solid wall in keeping unwanted attention away.",tt_fortstrength_description:"Fortifications protect your armies during sieges, taking damage in their place. Fortifications are automatically repaired over time.",tt_wartarget_assault:"War Target",tt_wartarget_lore:"A sleepy hamlet, unaware of the fate that is to befall them. To you, they are nothing but a trove of soul essence ripe to be added to your own.",tt_wartarget_assault_description:"Click to send your army to attack this war target. If you are victorious in battle, your troops will return with the spoils of war and this target will be replaced with a new, more difficult and more rewarding challenge.",tt_wartarget_cannotassault_noarmy:"Select how many units to deploy above before selecting a war target.",tt_wartarget_cannotassault_cantafford:"You cannot afford to deploy these units. Select fewer units above to reduce the deployment cost.",tt_wartarget_cannotassault_inbattle:"You're already fighting a battle.",tt_wartarget_cannotassault_invaded:"You cannot send troops to assault a war target while the Army of Light is marching on your lands.",tt_invaders_header:"Army of Light",tt_invaders_lore:"The living have been pushed to the point where they have concluded that something must be done to stop your rampage across their lands. Warriors, mercenaries and adventurers of all sorts now flock under the banners of a great alliance, preparing to march on your empire.",tt_invaders_description:"When the countdown expires, enemy forces will besiege the Buried Library. If you are able to repel them, the game will continue and the reckoning gauge will be reset, and you will also receive higher than usual Soul Fragment rewards from this battle. Fail, and you will be slain and your empire laid to ruin.",tt_invaders_prestige:"<span class='Ascension'>Your phylactery will allow you to reincarnate and keep your Soul Essence, but you will have to rebuild your empire once more.</span>",tt_invaderanger_header:"Reckoning",tt_invaderanger_lore:"As your dark influence extends over the kingdoms of the living they lash out in turn, seeking your undoing.",tt_invaderanger_description:"Every aggressive action you take against the living will advance the reckoning gauge. The higher the gauge, the more likely your next action will cause them to launch an invasion of your empire in retaliation, forcing you to defend the Buried Library or face fatal consequences; however, should you win, you will also reap greater rewards than from a normal battle.",tt_invaderanger_chance:"Current chance:",tt_currency_storage:"Storage",tt_currency_limit:"Storage",tt_currency_income:"Income",tt_currency_upkeep:"Upkeep",tt_tech_notresearched:"Not Researched",tt_tech_researched:"Researched:",tt_tech_researched_level:"Researched Level {0}:",tt_tech_researched_level_max:"Researched Level {0} / {1}:",tt_tech_whenresearched:" When Researched:",tt_tech_nextlevel:"Next Level:",tt_tech_researchcost:"Research Progress: ",tt_tech_requires:"Requires {0}",tt_tech_requires_level:"Requires {0} Level {1}",tt_tech_requires_victories:"Requires {0} military victories",tt_tech_researchcost_progress:"{0}/{1} ({2})",tt_tech_choked:"Your research rate is limited by a lack of available research materials. Completion will take longer than anticipated unless you can produce more of the required materials.",tt_prestige_notpurchased:"Not Purchased",tt_prestige_purchased:"Purchased:",tt_prestige_whenpurchased:"When Purchased:",tt_spell_notactive:"Not Active",tt_spell_activeduration:"Active Effects ({0} left):",tt_spell_castnew:"Casting this spell will grant for {0}:",tt_spell_castextend:"Casting this again will extend the active effect duration by {0}.",tt_spell_queue:"Spell Queue",tt_spell_queue_description:"Whenever you click a spell above that you can't afford to cast right now, it will instead be queued and automatically cast later once you do have the required resources. If you change your mind, you can click spells in the queue to cancel them.",tt_spell_queue_help:"Click to remove this spell from the queue. If you have more than one instance of this spell queued up, you can hold shift and click to remove all of them.",tt_building_level:"Constructed Level {0}:",tt_building_levelpartial:"Constructed Level {0} ({1} Enabled):",tt_building_levelalldisabled:"Constructed Level {0} (Disabled)",tt_building_nextlevel:"Next Level:",tt_emptybuilding:"Empty Improvement Slot",tt_emptybuilding_description:"There is space here for an improvement. With enough research, you will eventually be able to construct something to fill it.",tt_upkeep:"Upkeep:",tt_upkeep_perworker:" per <span class='{1}'>{0}</span> Worker",tt_upkeep_allworkers:"Upkeep (All Workers):",tt_upkeep_hint:"If you find yourself unable to consistently pay upkeep, consider disabling some of these improvements with the arrow buttons on either side of the level indicator. They can be enabled again later at no cost. If the improvement provides storage, it will still do so even when disabled.",tt_joballocator:"Worker Assignment",tt_joballocator_description:"Controls how many of your workers are assigned to this location. The number on the right shows how many workers you have assigned to work here, and the number on the left how many are actively working here. Once you've set the desired number of workers, idle workers will be automatically moved to this location when available.",worker_description:"These workers are idle, not performing any useful labor, and should be assigned to a location.",tt_tab_tech:"Research",tt_tab_tech_description:"Allows you to select research topics for study.",tt_tab_prestige:"Phylactery",tt_tab_prestige_description:"Allows you to spend <span class='Currency CurrencyPrestige'>Soul Essence</span> to improve the potency of your phylactery. Phylactery upgrades are permanent, persisting across resets.",tt_tab_records:"Records",tt_tab_records_description:"Allows you to review statistics and achievements you've completed.",tt_tab_domain:"Domain",tt_tab_domain_description:"Allows you to manage worker assignment and improvements.",tt_tab_military:"Military",tt_tab_military_description:"Allows you to manage your military and launch assaults on enemy settlements.",necromancy_worker:"Skeletal Drudge",necromancy_worker_plural:"Skeletal Drudges",necromancy_worker_lore:"Mindless, loyal, and tireless; skeletons are the perfect workers. Or they would be, if they didn't have a tendency to fall apart and need their bones replaced all the time. Either way, they are the backbone of your labor force and essential to the expansion of your domain.",necromancy_worker_upkeephint:"If you are unable to pay upkeep for all your workers, they will eventually fall apart and will need to be resummoned with your Raise Skeletal Drudge spell.",joblocation_wastelands:"Wastelands",joblocation_wastelands_lore:"The Buried Library sits at the center of a vast, rugged plain ravaged by countless ancient wars. It is a place of great solitude, but also great potential.",joblocation_forest:"Witchwood",joblocation_forest_lore:"The trees here are all twisted and pale, their roots stained with the blood of countless criminals who were executed here in centuries past, and the undergrowth teems with unknown, shadowy beasts.",joblocation_mines:"Spine Canyon",joblocation_mines_lore:"A deep gash cut into the land in a far corner of the wastelands. The high canyon walls keep most of the sunlight out, casting the area in a constant somber gloom.",joblocation_sanctum:"Inner Sanctum",joblocation_sanctum_lore:"The central column of the Buried Library, in which its vast treasure of tablets, tomes and scrolls are kept. There are also many side rooms that could be put to good use.",joblocation_courtyard:"Bailey",joblocation_courtyard_lore:"Immediately surrounding the library is this area, dedicated to the daily productive activities of your workers.",suffix_thousand:"K",suffix_million:"M",suffix_billion:"B",suffix_trillion:"T",suffix_quadrillion:"Q",suffix_persecond:"/s",suffix_hours:"h",suffix_minutes:"m",suffix_seconds:"s",generic_yes:"yes",generic_no:"no",generic_confirm:"confirm",generic_cancel:"cancel",generic_never:"never",generic_verysoon:"any second now",generic_saving:"Saving...",ui_settings:"Settings",ui_settings_description:"Change game settings, export/import saves, game reset, etc.",ui_settings_close:"Close",ui_settings_reset:"Reset Game",ui_settings_reset_description:'A <strong>Soft Reset</strong> will restart your game from the outset, keeping any permanent prestige rewards you have collected. A <strong>Hard Reset</strong> will erase ALL your progress as if you had never played this game before. To prevent his from being done accidentally, the Hard Reset button is disabled by default. To enable it, type the words "HARD RESET" in the text box below.',ui_settings_softreset:"Soft Reset",ui_settings_hardreset:"Hard Reset",ui_settings_export:"Export Save",ui_settings_export_description:"To export your savegame, simply press the export button and copy the text from the box. To import, paste then press the import button.",ui_settings_import_btn:"Import",ui_settings_export_btn:"Export",ui_prestige_youhavedied:"You Have Died",ui_prestigereset_phylactery:"The pain as the dagger pierces your heart is unbearable. Life ebbs quickly from your dying body. A brief moment of panic\u2014did the spell not work?\u2014but then, blessedly, the warm glow of the newly formed phylactery fills your vision just before your eyes close for the final time...",ui_prestigereset_invasion:"A victory cry rises from the forces of the insolent wretches invading your citadel as the last of your minions falls before their might. Desperate, you retreat towards the safety of your sanctum, but it is too late. From the throng emerges a heroic figure bearing a blessed blade; as it sinks into your chest and your undead body begins to crumble to dust, you spit out a dreadful curse, swearing that you will return and have your vengeance...",event_intro_header:"Nightmares",event_intro_text:"<p>You awake with a start, the air cold and the barren earth below you hard and dusty. Another nightmare. That's the only kind of dream you have now, cast out from your ancestral home by the jealous curs you used to call family into this pitiful exile. But the nightmares are showing you more than terrors: there is a promise of power hidden in those dreadful shadows, beckoning you deeper into the wasteland. After many days of wandering, the sight of a low stone spire jutting from the ground tells you that you have arrived.</p><p>Below the dead earth lies a treasure trove of arcane knowledge, ancient and long forgotten. Here, at the Buried Library, is where you will find the power to have your revenge on those who cast you out. Ironic, that their punishment would lead you to the tools of their undoing.</p>",event_intro_button:"The tomes beckon...",event_dying_header:"Decay",event_dying_text:"<p>Hastily, you push the grimoire aside and cover your mouth as another coughing fit overtakes you, palm stained by fine droplets of blood. It's not the first time. You can feel your body withering in this cold, lifeless place, so far from your rightful home. There is no doubt in your mind; you are dying, and you are nowhere close to the vengeance you deserve. All you have built will be for nothing if you simply waste away here. Something must be done.</p><p>The tomes speak of a means to preserve a living soul inside a magical device and prolong its lifespan indefinitely, but the details are vague, incomplete. For now, you must put aside thoughts of vengeance and focus on attaining the means to create such a device. Quickly, before your frail flesh is undone by consumption and rot.</p>",event_dying_button:"There's no time to waste",event_firstprestige_header:"Immortality",event_firstprestige_text:"<p>The last thing you remember is pain blooming from where the dagger impaled your heart, and immense cold as your life drained from your body. Now, you feel nothing \u2014 no pain, no fatigue, no hunger. You try to draw a deep breath to shake your senses awake, but can't, and to your combined horror and euphoria find that what was once pliant flesh is now little more than bones animated by the otherworldly energy emanating from your phylactery. Immortality is yours, but it has come at a steep cost: you are no longer human, but undead, and forever bound to the amulet that now holds your soul.</p><p>Exiting your inner sanctum, you realize a long time must have passed since your death. In your absence, what few beginnings of an empire you managed to build no longer stand and your drudges have long since crumbled to dust. What's more, your mind slips as it tries to remember the spells you once knew, and nothing comes to you. It seems you must learn anew, and rebuild what once stood, if you are to have your revenge \u2014 and if that revenge will have to be on the descendants of those who wronged you, then so be it.</p>",event_firstprestige_button:"I have all the time in the world",event_firstmilitaryvictory_header:"Darkness Descends",event_firstmilitaryvictory_text:"<p>What was once a small, yet flourishing hamlet is now nothing but a smoking ruin. Nothing lives here anymore, its erstwhile inhabitants either dead in the streets or else fled in panic. The only sound is the shrieking of the wind and clatter of bone on stone as your skeletal minions trawl through the remains in search of any useful spoils to bring back to the library. You have seen victory today, yet it feels... hollow. The soul essence you've ripped from the victims of your conquest should now be available for your own use, but your phylactery lies quiet and hungry. Something must be missing.</p><p>Gazing towards the horizon, you idly consider what the living are likely to do in reaction to your deeds. Nothing at first, you suppose, torn as they are by petty internal strife and politicking, but it is only a matter of time until they can no longer ignore you and will send armies in retaliation.</p>",event_firstmilitaryvictory_button:"I will be ready",event_firstkilledinbattle_header:"Bitter Glory",event_firstkilledinbattle_text:"<p>Your consciousness blooms out of the darkness once more, startling and raw. Trembling, you run your bony fingers across your ribcage, your skull; no trace remains of the terrible wound you were served by that searing hot blade. The central book storage of the library is as you remember it, curiously untouched by the hands of those killed you, but the same cannot be said for what lies outside. You have no way to know for sure how long has passed, nor whether these silent ruins are a result of the decay of long decades or the triumphant fury of the barbarians responsible for your bitter defeat.</p><p>As you prepare to start anew once more, a subtle sensation of renewed vigor comes to you. Peering into your phylactery, you sense renewed power within; it appears the ragged scraps of living souls you claimed in your previous life have fully integrated themselves into its swirling energies. While you cannot say you relish the thought of dying so painfully again, at least defeat has a certain ironic benefit to it...</p>",event_firstkilledinbattle_button:"Curious...",feat_prestige:"Immortal Unlife",feat_prestige_description:"Shed your mortal coil and ascend as an undying lich.",feat_militaryvictory:"Darkness Descends",feat_militaryvictory_description:"Successfully invade a settlement.",feat_killedinbattle:"Bitter Glory",feat_killedinbattle_description:"Die failing to defend the Buried Library from attack.",feat_tech100:"Technological Superiority",feat_tech100_description:"Reach level 100 in a single research topic.",feat_tech500:"Technological Domination",feat_tech500_description:"Reach level 500 in a single research topic.",feat_victories50:"Victor",feat_victories50_description:"Win 50 battles in a single incarnation.",feat_victories250:"Conqueror",feat_victories250_description:"Win 250 battles in a single incarnation.",ui_about_game:"Game by <a href='https://github.com/movexig'>movexig</a>. Most artwork from <a href='https://game-icons.net/'>game-icons.net</a> by Lorc, Delapouite and other contributors, used under <a href='https://creativecommons.org/licenses/by/3.0/'>CC BY 3.0</a>.",ui_loading:"Loading, Please Wait",ui_alphatest:"This is an alpha-grade testing version of the game. Expect rampant problems, save incompatibility, and so forth."},yt=Rn;var ne={x:40,y:65},H={x:48,y:48},gt=21,s;function i(e,t){let r=yt[e];return r===void 0||typeof r=="string"?r:r[t??0]}function Ke(e,t){let r=yt[e];return r===void 0||typeof r=="string"?r:r[Math.floor(t(r.length))]}function me(e,t,r,n){let a=r?i("suffix_persecond"):"";for(let o of S){let l=t[o]??0;if(l!==0){let u=i(`currency_${o}`);e.InformationLeftRight(`<span class='Currency Currency${o.toUpperFirst()}'>${u}</span>`,`${I(l)}${a}`,n)}}}function j(e,t,r,n,a,o){let l=o!==0&&r.income!==void 0?r.income(o,s.gameState):{},u=o!==0&&r.storage!==void 0?r.storage(o,s.gameState):{},f=r.income!==void 0?r.income(n,s.gameState):{},c=r.storage!==void 0?r.storage(a,s.gameState):{};if(o===0){let m=i(`${t}_description`);m!==void 0&&e.Information(m,"TechEffectText")}let d=r.modifiers!==void 0?r.modifiers(n,s.gameState):{};for(let[m,h]of Object.entries(d))if(h!==0){let w=i(`modifier_${m}`);w!==void 0&&e.Information(w.format(I(h)),"TechEffectText")}let C=r.multipliers!==void 0?r.multipliers(n,s.gameState):{};for(let[m,h]of Object.entries(C))if(h!==0){let w=i(`multiplier_${m}`);if(w!==void 0){let E=(h-1)*100,W=Number.isInteger(E)?E.toFixed(0):((h-1)*100).toPrecision(3);e.Information(w.format(W),"TechEffectText")}}for(let m of S){let h=i("currency_"+m),w=c[m]??0;if(w!==0&&c[m]!==u[m]&&(r.hideStorage===void 0||!r.hideStorage.includes(m))){let W=i(`currency_${m}_limit`)??i("tt_currency_limit");e.Information(`<span class='Currency Currency${m.toUpperFirst()}'>${h} ${W}</span> +${I(w)}`,"TechEffect")}let E=f[m]??0;if(E!==0&&f[m]!==l[m]&&(r.hideIncome===void 0||!r.hideIncome.includes(m))){let W=i(`currency_${m}_income`)??i("tt_currency_income");e.Information(`<span class='Currency Currency${m.toUpperFirst()}'>${h} ${W}</span> ${te(E)}`,"TechEffect")}}let p=r.upkeep!==void 0?r.upkeep(n,s.gameState):{},_=!1;for(let m of S){let h=i("currency_"+m),w=p[m]??0,E=r.upkeepPerWorker!==void 0?r.upkeepPerWorker(n,s.gameState):{};if(w!==0&&p[m]!==l[m]&&(r.hideIncome===void 0||!r.hideIncome.includes(m))){_||(e.Information(i("tt_upkeep"),"TechEffectHeader"),_=!0);let W=`<span class='Currency Currency${m.toUpperFirst()}'>${h}</span> ${te(-w)}`,U=E[m];U!==void 0&&(W+=i("tt_upkeep_perworker").format(i(`joblocation_${U}`),U.toUpperFirst())),e.Information(W,"TechEffect")}}}function In(e,t){for(let[r,n]of Object.entries(T))if(n.slot.x==e&&n.slot.y==t)return r}function Fr(e,t){let r=Math.floor(gt/2),n={x:(e.x+r)*ne.x,y:e.y*ne.y},a={x:(t.x+r)*ne.x,y:t.y*ne.y},o=Math.min(n.x,a.x),l=Math.min(n.y,a.y),u=Math.max(n.x,a.x)-o+H.x,f=Math.max(n.y,a.y)-l+H.y,c=document.createElementNS("http://www.w3.org/2000/svg","svg");c.classList.add("TechTreeLine"),c.setAttributeNS(null,"viewBox",`${o} ${l} ${u} ${f}`),c.setAttributeNS(null,"width",`${u}`),c.setAttributeNS(null,"height",`${f}`),c.style.left=`${o}px`,c.style.top=`${l}px`;let d="";if(t.y>e.y){let p={x:n.x+H.x/2,y:n.y+H.y},_={x:a.x+H.x/2,y:a.y},m=t.x>e.x?1:-1;if(d+=`M ${_.x},${_.y} `,e.x!=t.x){let h=!0;for(let w=e.y+1;w<t.y;++w)if(In(t.x,w)!==void 0){h=!1;break}h?d+=`L ${_.x},${p.y+12} `:d+="l 0,-2 ",d+=`q 0,-6 ${-6*m},-6 `,d+=`l ${p.x-_.x+12*m},0 `,d+=`q ${-6*m},0 ${-6*m},-6 `}d+=`L ${p.x},${p.y} `}else t.x>e.x?(d+=`M ${n.x+H.x},${n.y+H.y/2} `,d+=`L ${a.x},${a.y+H.y/2} `):(d+=`M ${n.x},${n.y+H.y/2} `,d+=`L ${a.x+H.x},${a.y+H.y/2} `);return c.appendChild(document.createElementNS("http://www.w3.org/2000/svg","path")).setAttributeNS(null,"d",d),c}function Bn(){let e=b("#TechTreeLines");if(e!==null)for(let[t,r]of Object.entries(s.techs)){let n=T[t];if(n.requires!==void 0)for(let a of Object.keys(n.requires)){let o=Math.abs(T[a].slot.x-n.slot.x),l=Math.abs(T[a].slot.y-n.slot.y);if((o<=3||l==1)&&l<=4){let u=Fr(T[a].slot,n.slot);e.appendChild(u),r.treeLines[a]=u}}}}function An(){let e=b("#PrestigeTreeLines");if(e!==null)for(let[t,r]of Object.entries(s.prestigeUpgrades)){let n=A[t];if(n.requires!==void 0)for(let a of n.requires){let o=Fr(A[a].slot,n.slot);o!==null&&(e.appendChild(o),r.treeLines[a]=o)}}}function Pn(e){let t=T[e],r=b("#TechTreeNodes");if(r===null)return null;for(;s.techRows.length<=t.slot.y;)s.techRows.push(r.appendChild(document.createElement("div")));let n=s.techRows[t.slot.y],a=Math.floor(gt/2),o=B(n,"TechnologyTemplate",`Technology${e}`);if(o===null)throw new Error("Failed to create tech panel from template");o.style.backgroundImage="url('images/tech/"+t.icon+".svg')",o.style.left=`${(t.slot.x+a)*ne.x}px`;let l=y(o,".Left"),u=y(o,".Right"),f=y(o,".Level");return s.techs[e]={slot:o,progressLeft:l,progressRight:u,level:f,treeLines:{}},o.addEventListener("click",()=>{ut(s.gameState,e)}),x(o,"right",c=>{c.Header(i(`tech_${e}`)),c.Lore(i(`tech_${e}_lore`)),c.Separator();let d=s.gameState.persistent.techLevels[e]??0,C=t.maxLevel!==void 0&&d>=t.maxLevel,p=d+1;if(d>0&&(t.maxLevel===1?c.Information(i("tt_tech_researched"),"TechEffectHeader"):t.maxLevel!==void 0?c.Information(i("tt_tech_researched_level_max").format(d,t.maxLevel??0),"TechEffectHeader"):c.Information(i("tt_tech_researched_level").format(d),"TechEffectHeader"),j(c,`tech_${e}`,t,d,d,0)),!C){d>0&&c.Separator();let _=s.gameState.techTargetChoked&&s.gameState.persistent.techTarget===e,m=s.gameState.income.research??0,h=s.gameState.persistent.techProgress[e]??0,w=le(e,d),E=m==0?i("generic_never"):re((w-h)/m),W=i("tt_tech_researchcost_progress").format(I(h),I(w),_?"?":E),U=nt(s.gameState,e,d);if(U!==void 0)for(let z of S){let Q=U[z];Q!==void 0&&(U[z]=Q*(1-h/w))}let fe=!0;if(t.requires!==void 0){for(let[z,Q]of Object.entries(t.requires))if(s.gameState.persistent.techLevels[z]<Q){fe=!1;let kt=i("tech_"+z);Q==1?c.Information(i("tt_tech_requires").format(kt,Q),"Prerequisite"):c.Information(i("tt_tech_requires_level").format(kt,Q),"Prerequisite")}}if(t.requiresVictories!==void 0){let z=t.requiresVictories(d+1,s.gameState);s.gameState.persistent.warTargetVictories<z&&(c.Information(i("tt_tech_requires_victories").format(z),"Prerequisite"),fe=!1)}t.specialRequires!==void 0&&(t.specialRequires(d+1,s.gameState)||(c.Information(i(`tech_${e}_specialreq`),"Prerequisite"),fe=!1)),fe&&(d==0?(c.Information(i("tt_tech_notresearched"),"TechNotResearched"),c.Separator(),c.Information(i("tt_tech_whenresearched"),"TechEffectHeader")):c.Information(i("tt_tech_nextlevel"),"TechEffectHeader"),j(c,`tech_${e}`,t,p,p,d),c.Separator(),U!==void 0&&me(c,U,!1),c.InformationLeftRight(i("tt_tech_researchcost"),W,"TechResearch"),_&&c.Information(i("tt_tech_choked"),"Warning"))}}),o}function qr(){let e=0;for(let[t,r]of Object.entries(T))s.gameState.hiddenTech[t]!==!0&&(e=Math.max(e,r.slot.y));for(let t=0;t<s.techRows.length;++t)g(s.techRows[t],"Hidden",t>e)}function Hr(e){let t=s.gameState,r=s.prestigeUpgrades[e];if(r!==void 0){let n=t.persistent.prestige[e]===!0,a=!Mr(s.gameState,e);g(r.slot,"Locked",a),g(r.slot,"Purchased",n);for(let o of Object.values(r.treeLines))g(o,"Locked",a&&!n)}}function Fn(e){let t=A[e],r=b("#PrestigeTreeNodes");if(r===null)return null;for(;s.prestigeRows.length<=t.slot.y;)s.prestigeRows.push(r.appendChild(document.createElement("div")));let n=s.prestigeRows[t.slot.y],a=Math.floor(gt/2),o=B(n,"PrestigeUpgradeTemplate",`Prestige${e}`);return o===null?null:(o.style.backgroundImage=`url('images/tech/${t.icon}.svg')`,o.style.left=`${(t.slot.x+a)*ne.x}px`,s.prestigeUpgrades[e]={slot:o,treeLines:{}},o.addEventListener("click",()=>{Lr(s.gameState,e),Hr(e)}),x(o,"right",l=>{if(l.Header(i(`prestige_${e}`)),l.Lore(i(`prestige_${e}_lore`)),l.Separator(),s.gameState.persistent.prestige[e]===!0?(l.Information(i("tt_prestige_purchased"),"TechEffectHeader"),j(l,`prestige_${e}`,t,1,1,0)):(l.Information(i("tt_prestige_notpurchased"),"TechNotResearched"),l.Separator(),l.Information(i("tt_prestige_whenpurchased"),"TechEffectHeader"),j(l,`prestige_${e}`,t,1,1,0),t.cost.prestige!==void 0&&(l.Separator(),me(l,t.cost,!1))),t.requires!==void 0)for(let u of t.requires)s.gameState.persistent.prestige[u]!==!0&&l.Information(i("tt_tech_requires").format(i(`prestige_${u}`)),"Prerequisite")}),Hr(e),o)}function qn(e){let t=P[e],r=b("#SpellList");if(r===null)return;let n=B(r,"SpellButtonTemplate",`Spell${e.toUpperFirst()}`);if(n===null)return;let a=b(n,"img");a.src=`images/tech/${t.icon}.svg`;let o=y(n,"h1");o.textContent=i(`spell_${e}`);let l={slot:n,metamagicLevel:y(n,".Level"),metamagicUp:y(n,".Up"),metamagicDown:y(n,".Down"),durationLeft:y(n,".DurationFill.Left"),durationRight:y(n,".DurationFill.Right")};s.spells[e]=l,t.metamagic===!0&&(l.metamagicUp.addEventListener("click",u=>{let f=s.gameState.modifiers.metamagic_level??0;s.gameState.persistent.metamagicLevel[e]=Math.min((s.gameState.persistent.metamagicLevel[e]??0)+1,f),u.stopPropagation(),Be(e)}),l.metamagicDown.addEventListener("click",u=>{s.gameState.persistent.metamagicLevel[e]=Math.max((s.gameState.persistent.metamagicLevel[e]??0)-1,0),u.stopPropagation(),Be(e)})),x(n,"right",u=>{let f=1+(s.gameState.persistent.metamagicLevel[e]??0);if(f>1?u.Header(i(`spell_${e}`)+" "+Ie(f)):u.Header(i(`spell_${e}`)),u.Lore(i(`spell_${e}_lore`)),u.Separator(),t.duration!==void 0){let c=t.duration(f,s.gameState),d,C=s.gameState.persistent.activeSpellEffects;if(C[e]!==void 0?(d=C[e].level,u.Information(i("tt_spell_activeduration").format(re(C[e].durationLeft)),"SpellEffectHeader"),j(u,`spell_${e}`,t,d,d,0)):u.Information(i("tt_spell_notactive"),"SpellNotActive"),u.Separator(),d===f)u.Information(i("tt_spell_castextend").format(re(c)),"SpellEffectHeader");else{let p=1+(s.gameState.persistent.metamagicLevel[e]??0);u.Information(i("tt_spell_castnew").format(re(c)),"SpellEffectHeader"),j(u,`spell_${e}`,t,p,p,0)}}else u.Information(i(`spell_${e}_description`));u.Separator(),me(u,Re(s.gameState,e,1+(s.gameState.persistent.metamagicLevel[e]??0)),!1)}),n.addEventListener("click",()=>{ue(s.gameState,e)?pt(s.gameState,e):Gr(s.gameState,e)})}function Dr(e){let t=s.spells[e];if(t===void 0)return;let r=s.gameState,n=P[e],a=r.persistent.activeSpellEffects;g(t.slot,"Visible",dt(r,e)),g(t.slot,"Castable",ue(r,e)),g(t.slot,"HasDuration",a[e]!==void 0),a[e]!==void 0&&a[e].duration>0&&Wr(t.durationLeft,t.durationRight,a[e].durationLeft/a[e].duration),g(t.slot,"Metamagic",(r.modifiers.metamagic_level??0)>0&&n.metamagic===!0),t.metamagicLevel.textContent=Ie(1+(r.persistent.metamagicLevel[e]??0))}function Be(e){Dr(e),Ae()}function $r(){let e=0;g(s.spellQueue.container,"Hidden",s.gameState.enabledFeatures.spell_queue!==!0);for(let t of s.gameState.persistent.spellQueue){let r=e,n=t.spell,a=P[n];if(s.spellQueue.spells.length<=e){let l=B(s.spellQueue.container,"QueuedSpellTemplate");if(l===null)throw new Error("Failed to create spell queue entry from template");s.spellQueue.spells.push({icon:l,count:y(l,".Count")}),l.addEventListener("click",u=>{mt(s.gameState,r,u.shiftKey)})}let o=s.spellQueue.spells[e];o.icon.classList.remove("Hidden"),o.icon.style.backgroundImage=`url("images/tech/${a.icon}.svg")`,o.count.innerText=t.count.toString(),g(o.icon,"NoCount",t.count<2),x(o.icon,"top",l=>{let u=s.gameState.persistent.spellQueue[r].level;u>1?l.Header(i(`spell_${n}`)+" "+Ie(u)):l.Header(i(`spell_${n}`)),l.Lore(i(`spell_${n}_lore`)),l.Separator(),l.Information(i("tt_spell_queue_help"))}),++e}for(;e<s.spellQueue.spells.length;++e)s.spellQueue.spells[e].icon.classList.add("Hidden")}function Ur(){for(let e of Object.keys(s.spells))Dr(e);$r(),Ae()}function Or(){let e=s.gameState,t=s.techTarget!==void 0?s.techs[s.techTarget]?.slot:void 0,r=e.persistent.techTarget!==void 0?s.techs[e.persistent.techTarget]?.slot:void 0;t!==r&&(t?.classList.remove("Researching"),r?.classList.add("Researching")),Ae(),s.techTarget=e.persistent.techTarget}function pe(){for(let e of Object.keys(s.techs))_t(e);Ae(),qr()}function Wr(e,t,r){r==0?(e.style.visibility="hidden",t.style.visibility="hidden"):r<.5?(e.style.visibility="hidden",t.style.visibility="visible",t.style.transform=`rotate(${(r/.5-1)*180}deg)`):(e.style.visibility="visible",t.style.visibility="visible",e.style.transform=`rotate(${((r-.5)/.5-1)*180}deg)`,t.style.transform="rotate(0deg)")}function _t(e){let t=s.gameState,r=s.techs[e];if(r!==void 0){let n=T[e],a=(t.persistent.techProgress[e]??0)/le(e,t.persistent.techLevels[e]??0),o=t.persistent.techLevels[e],l=t.hiddenTech[e]===!0;Wr(r.progressLeft,r.progressRight,a);let u=!ct(t,e);g(r.slot,"Locked",u),g(r.slot,"MaxLevel1",n.maxLevel==1),g(r.slot,"MaxLevel",n.maxLevel!==void 0&&o>=n.maxLevel),g(r.slot,"Researched",o>0),g(r.slot,"Researching",e===t.persistent.techTarget),g(r.slot,"Hidden",l);for(let f of Object.values(r.treeLines))g(f,"Locked",u&&o==0),g(f,"Hidden",l);n.maxLevel==1?r.level.textContent="":r.level.textContent=o.toString()}}function jr(...e){for(let[t,r]of e)t.addEventListener("click",()=>{for(let[n,a]of e)g(n,"InactiveTab",n!==t),g(a,"InactiveTabContent",a!==r)});if(e.length>1)for(let[t,r]of e)g(t,"InactiveTab",t!==e[0][0]),g(r,"InactiveTabContent",r!==e[0][1])}function Hn(){let e=b("#TechTabButton"),t=b("#PrestigeTabButton"),r=b("#RecordsTabButton");if(e&&t&&r){let n=b("#Technologies"),a=b("#PrestigeUpgrades"),o=b("#Records");n&&a&&o&&jr([e,n],[t,a],[r,o]),x(e,"bottom",l=>{l.Header(i("tt_tab_tech")),l.Information(i("tt_tab_tech_description"))}),x(t,"bottom",l=>{l.Header(i("tt_tab_prestige")),l.Information(i("tt_tab_prestige_description"))}),x(r,"bottom",l=>{l.Header(i("tt_tab_records")),l.Information(i("tt_tab_records_description"))})}}function ar(e){let t=y("#ActiveBattle"),r=y("#BattleResult"),n=y("#Invaders"),a=y("#InvaderAnger"),o=y("#PlayerFortStrength");V(y("#MainContent")),V(y("#AlphaTest")),s={gameState:e,tooltipHandlers:new WeakMap,currencies:{},techRows:[],techs:{},spells:{},spellQueue:{container:y("#SpellQueue"),spells:[]},domain:{},idleWorkers:y("#IdleWorkers"),prestigeRows:[],prestigeUpgrades:{},prestigePopup:y("#PrestigeDeathPopup"),prestigeMessage:y("#PrestigeMessage"),militaryUnits:{},deployMilitary:{units:{},container:y("#ArmyDeployment"),cost:y("#ArmyDeploymentCost"),warTargetsContainer:y("#WarTargets"),warTargets:[]},activeBattle:{container:t,title:y(t,".BattleName"),fortPlayer:y(t,".PlayerFort"),fortEnemy:y(t,".EnemyFort"),frontlines:[],retreat:y(t,".RetreatButton")},playerFortStrength:{container:o,fill:y(o,".BarFill"),text:y(o,".BarText")},invaders:{container:n,army:y(n,".ArmyList"),countdown:y(n,".Countdown")},invaderAnger:{container:a,barFill:y(a,".BarFill")},battleResults:{container:r,name:y(r,".BattleName"),casualties:y(r,".BattleResultCasualties"),spoils:y(r,".BattleResultSpoils")},records:{feats:{}}};let l=b("#LoadingScreen");l&&(l.textContent=i("ui_loading")),$(e)&&document.body.classList.add("PrestigeEnabled"),Hn(),jn(),x(s.idleWorkers,"bottom",d=>{let C=tt[e.persistent.culture];d.Header(i(`${C.workerName}_plural`)),d.Lore(i(`${C.workerName}_lore`)),d.Separator(),d.Information(i("worker_description")),d.Separator(),d.Information(i("tt_upkeep_allworkers"),"UpkeepHeader"),me(d,C.workerUpkeep(s.gameState),!0),d.Information(i(`${C.workerName}_upkeephint`),"Hint")});let u=b("#CurrenciesBar");if(u!==null)for(let d of S){let C=`Currency${d.toUpperFirst()}`,p=B(u,"CurrencyBarTemplate",C);if(p){p.classList.add(C);let _=y(p,".Current"),m=y(p,".Income");s.currencies[d]={parent:p,current:_,income:m},x(p,"bottom",h=>{h.Header(i(`currency_${d}`)),h.Lore(i(`currency_${d}_lore`)),h.Separator();let w=i(`currency_${d}_description`);if(w!==void 0&&(h.Information(w),h.Separator()),Se(d)){if(ie(d)){let E=i(`currency_${d}_storage`)??i("tt_currency_storage");h.Information(`${E}: ${I(e.persistent.wallet[d])} / ${I(e.walletStorage[d])}`)}}else{let E=i(`currency_${d}_storage`)??i("tt_currency_storage");h.Information(`${E}: ${I(e.persistent.wallet[d])}`)}if(rt(d)){let E=i(`currency_${d}_income`)??i("tt_currency_income");h.Information(`${E}: ${te(e.income[d]??0)}`)}})}}for(let d of Object.keys(T))Pn(d);Bn();for(let d of Object.keys(A))Fn(d);An();for(let d of Object.keys(T))_t(d);for(let d of Object.keys(P))qn(d),Be(d);x(s.spellQueue.container,"top",d=>{d.Header(i("tt_spell_queue")),d.Separator(),d.Information(i("tt_spell_queue_description"))});let f=b("#SaveIndicator");f!==null&&(f.textContent=i("generic_saving")),On(),zn(),Dn(),Un(),b("#PrestigeReviveButton")?.addEventListener("click",()=>{cr(s.gameState)}),V(s.prestigePopup);let c=s.gameState.events;c.ticked.listen(Qr),c.techLevelsChanged.listen(()=>{pe(),Ur()}),c.techTargetChanged.listen(()=>{Or()}),c.spellCast.listen(d=>{Be(d)}),c.battleEnded.listen((d,C,p,_)=>{$n(d,C,p,_),zr(),bt(),pe()}),c.buildingCountChanged.listen(()=>{Vr(),pe()}),c.standingArmyChanged.listen(()=>{Nr(),pe()}),c.workersChanged.listen(()=>{Wn(),pe()}),c.spellQueueChanged.listen($r),c.storyEventTriggered.listen(Nn),c.prestigeResetTriggered.listen(Vn),c.invasionBegan.listen(bt),c.featAchieved.listen(vt),c.prestigeUpgradesChanged.listen(vt),Qr(),Or(),zr(),qr()}function Yr(e){let t=s.gameState,r=t.persistent.activeWorkers[e],n=t.persistent.assignedWorkers[e],a=s.domain[e];a!==void 0&&(a.workerAssignmentText.textContent=`${r} / ${n}`,s.idleWorkers.textContent=t.persistent.activeWorkers.idle.toString())}function Wn(){for(let e of q)Yr(e)}function wt(e,t,r){e.textContent="";for(let[n,a]of Object.entries(t)){let o=G[n],l=B(e,"SmallMilitaryUnitTemplate");if(l===null)throw new Error("Failed to create defender template instance");let u=y(l,".Icon");u.style.backgroundImage=`url("images/military/${o.icon}.svg")`;let f=y(l,".Text");if(r){let c=a;a<100?c=Math.max(1,Math.round(a/10))*10:c=Math.max(1,Math.round(a/25))*25,f.innerHTML=`&#8764;${I(c)}`}else f.innerHTML=`${I(a)}`;x(l,"left",c=>Pe(n,c))}}function zr(){for(let e=0;e<J;++e){let t=s.gameState.warTargets[e];s.deployMilitary.warTargets[e].name.textContent=t.name;let r=i(`wartarget_${t.culture}`),n=i("wartarget_village"),a=i("ui_wartarget_population").format(I(t.population));s.deployMilitary.warTargets[e].population.textContent=`${r} ${n}, ${a}`,wt(s.deployMilitary.warTargets[e].defenders,s.gameState.warTargets[e].defenders,!0)}}function Fe(e,t){t?(e.classList.add("HasUnit"),g(e,"Casualties",t.casualties>0),e.style.backgroundImage=`url("images/military/${G[t.unit].icon}.svg")`,y(e,".Count").textContent=t.count.toString(),x(e,"left",r=>Pe(t.unit,r))):(e.classList.remove("HasUnit"),e.classList.remove("Casualties"),e.style.backgroundImage="none",Jr(e))}function bt(){s.invaders.army.innerHTML="",s.gameState.persistent.invaders!==void 0&&wt(s.invaders.army,s.gameState.persistent.invaders.army,!0)}function Kr(e,t){t.fortificationsMax<=0?e.classList.add("Hidden"):(e.classList.remove("Hidden"),e.textContent=(100*t.fortifications/t.fortificationsMax).toFixed(0)+"%")}function ae(){let e=Le(s.gameState),t=!ir(e);g(s.deployMilitary.cost,"NoCost",!t),t?(s.deployMilitary.cost.innerHTML="",Xr(s.deployMilitary.cost,e)):s.deployMilitary.cost.innerHTML="-";for(let[r,n]of Object.entries(s.deployMilitary.units))if(n!==void 0){let a=(s.gameState.persistent.militaryDeployment[r]??0)>(s.gameState.persistent.military[r]??0);g(n.slot,"Overassigned",a)}}function Nr(){let e=s.gameState;for(let[t,r]of Object.entries(s.militaryUnits))r&&(r.count.textContent=(s.gameState.persistent.military[t]??0).toFixed(0),g(r.slot,"Hidden",e.enabledFeatures[`military_${t}`]!==!0));for(let[t,r]of Object.entries(s.deployMilitary.units))r&&(r.count.textContent=(s.gameState.persistent.militaryDeployment[t]??0).toFixed(0),g(r.slot,"Hidden",e.enabledFeatures[`military_${t}`]!==!0));if((e.modifiers.fortifications??0)>0){let t=Math.floor((1-e.persistent.fortDamage/e.modifiers.fortifications)*100);s.playerFortStrength.container.classList.remove("Hidden"),s.playerFortStrength.fill.style.width=`${t}%`,s.playerFortStrength.text.innerText=`${I(Math.ceil(e.modifiers.fortifications-e.persistent.fortDamage))} / ${I(e.modifiers.fortifications)}`}else s.playerFortStrength.container.classList.add("Hidden");if(e.persistent.battle!==void 0){let t=e.persistent.battle,r=t.player.frontRank.length;s.deployMilitary.warTargetsContainer.classList.add("Hidden"),s.deployMilitary.container.classList.add("Hidden"),s.activeBattle.container.classList.remove("Hidden"),s.battleResults.container.classList.remove("Visible"),g(s.activeBattle.container,"Defensive",e.persistent.battle.warTargetIndex===void 0),t.warTargetIndex!==void 0?s.activeBattle.title.textContent=i("ui_wartargetbattle_title").format(e.warTargets[t.warTargetIndex].name):s.activeBattle.title.textContent=i("ui_defensebattle_title"),Kr(s.activeBattle.fortPlayer,t.player),Kr(s.activeBattle.fortEnemy,t.enemy);for(let n=0;n<r;++n){let a=s.activeBattle.frontlines[n];Fe(a.playerBack,t.player.backRank[n]),Fe(a.playerFront,t.player.frontRank[n]),Fe(a.enemyFront,t.enemy.frontRank[n]),Fe(a.enemyBack,t.enemy.backRank[n]),g(a.container,"Empty",t.player.backRank[n]==null&&t.player.frontRank[n]==null&&t.enemy.backRank[n]==null&&t.enemy.frontRank[n]==null);let o=t.player.frontRank[n]?.attackDirection??t.player.backRank[n]?.attackDirection,l=t.enemy.frontRank[n]?.attackDirection??t.enemy.backRank[n]?.attackDirection,u=o===0||l===0,f=o===void 0&&l===void 0;g(a.interaction,"None",f),g(a.interaction,"Clash",u&&!f),g(a.interaction,"Flank",!u&&!f),!u&&!f&&(g(a.interaction,"AttackerRight",o!==void 0&&o>0),g(a.interaction,"AttackerLeft",o!==void 0&&o<0),g(a.interaction,"DefenderRight",l!==void 0&&l>0),g(a.interaction,"DefenderLeft",l!==void 0&&l<0))}}else s.deployMilitary.warTargetsContainer.classList.remove("Hidden"),s.deployMilitary.container.classList.remove("Hidden"),s.activeBattle.container.classList.add("Hidden");s.gameState.persistent.invaders!==void 0?(s.invaders.countdown.textContent=i("ui_invaders_countdown")+re(Math.ceil(s.gameState.persistent.invaders.countdown)),g(s.invaders.container,"Hidden",Ge(s.gameState))):s.invaders.container.classList.add("Hidden"),g(s.invaderAnger.container,"Hidden",s.gameState.persistent.invaderAnger<=0),s.invaderAnger.barFill.style.width=`${(s.gameState.persistent.invaderAnger*100).toFixed(0)}%`,ae()}function Vr(){for(let[e,t]of Object.entries(s.domain))if(t!==void 0){g(t.location,"Visible",s.gameState.enabledFeatures[e]===!0),g(t.workerAssignments,"Visible",s.gameState.enabledFeatures[`job_${e}`]===!0);for(let[r,n]of Object.entries(t.buildingSlots)){let a=de(s.gameState,r);g(n.slot,"Hidden",!a),g(n.slot,"Affordable",Er(s.gameState,r));let o=s.gameState.persistent.disabledBuildings[r]??0;n.level.textContent=((s.gameState.persistent.buildingLevels[r]??0)-o).toString(),g(n.slot,"SomeDisabled",o>0)}}}function Dn(){let e=b("#DomainLocations");if(e===null)return;for(let n of q){if(n=="idle")continue;let a=B(e,"DomainLocationTemplate",`Domain${n.toUpperFirst()}`);if(a===null)throw new Error("Failed to create domain template instance");let o=y(a,".LocationName"),l=y(a,".WorkerAssignments"),u=y(a,".Buildings"),f=y(l,".Allocation");o.textContent=i(`joblocation_${n}`),x(o,"left",c=>{c.Header(i(`joblocation_${n}`)),c.Lore(i(`joblocation_${n}_lore`))}),x(l,"left",c=>{c.Header(i("tt_joballocator")),c.Information(i("tt_joballocator_description"))}),b(l,".Up")?.addEventListener("click",()=>ft(s.gameState,n,1)),b(l,".Down")?.addEventListener("click",()=>ft(s.gameState,n,-1)),s.domain[n]={location:a,workerAssignments:l,workerAssignmentText:f,buildingSlots:{}};for(let[c,d]of Object.entries(F))if(d.location==n){let C=B(u,"DomainBuildingTemplate",`Building${c.toUpperFirst()}`);if(C===null)continue;d.upkeep!==void 0&&C.classList.add("HasUpkeep");let p=b(C,"img");p.src=`images/building/${d.icon}.svg`;let _=y(C,".Level");x(C,"left",m=>{if(de(s.gameState,c)){let h=s.gameState.persistent.buildingLevels[c],w=s.gameState.persistent.disabledBuildings[c];m.Header(i(`building_${c}`)),m.Lore(i(`building_${c}_lore`)),h-w>0?(m.Separator(),w>0?m.Information(i("tt_building_levelpartial").format(h,h-w),"TechEffectHeader"):m.Information(i("tt_building_level").format(h),"TechEffectHeader"),j(m,`building_${c}`,d,h-w,h,0)):h>0&&w==h&&(m.Separator(),m.Information(i("tt_building_levelalldisabled").format(h),"TechEffectHeader"),j(m,`building_${c}`,d,0,h,0)),m.Separator(),m.Information(i("tt_building_nextlevel"),"TechEffectHeader"),j(m,`building_${c}`,d,h+1,h+1,h),m.Separator(),me(m,d.cost(h,s.gameState),!1),d.upkeep!==void 0&&m.Information(i("tt_upkeep_hint"),"Hint")}else m.Header(i("tt_emptybuilding")),m.Information(i("tt_emptybuilding_description"))}),p.addEventListener("click",()=>{Rr(s.gameState,c)}),b(C,".Up")?.addEventListener("click",()=>{ht(s.gameState,c,1)}),b(C,".Down")?.addEventListener("click",()=>{ht(s.gameState,c,-1)}),s.domain[n].buildingSlots[c]={slot:C,level:_}}Yr(n)}let t=b("#DomainTabButton"),r=b("#MilitaryTabButton");if(t!==null&&r!==null){let n=b("#Domain"),a=b("#Military");n!==null&&a!==null&&jr([t,n],[r,a]),x(t,"bottom",o=>{o.Header(i("tt_tab_domain")),o.Information(i("tt_tab_domain_description"))}),x(r,"bottom",o=>{o.Header(i("tt_tab_military")),o.Information(i("tt_tab_military_description"))})}}function Xr(e,t){for(let r of S){let n=t[r];if(n!==void 0&&n>0){let a=e.appendChild(document.createElement("span"));a.classList.add("Currency"),a.classList.add(`Currency${r.toUpperFirst()}`),a.textContent=I(n)+" ",x(a,"left",o=>{o.Header(i(`currency_${r}`)),o.Lore(i(`currency_${r}_lore`))})}}}function Pe(e,t){let r=G[e],n=s.gameState;if(t.Header(i(`military_${e}`)),t.Lore(i(`military_${e}_lore`)),t.Separator(),t.Information(i(`tt_militaryclass_${r.unitClass}`)),t.Information(`<span class="MilitarySkill StatBlock">${i("tt_military_skill")}</span> ${r.skill(n).toString()}`),t.Information(`<span class="MilitaryAttack StatBlock">${i("tt_military_attack")}</span> ${r.attack(n).toString()}`),t.Information(`<span class="MilitaryDefense StatBlock">${i("tt_military_defense")}</span> ${r.defense(n).toString()}`),t.Information(i("tt_military_stats_hint"),"Hint"),r.abilities!==void 0){let a=!1;for(let[o,l]of Object.entries(r.abilities(n)))if(l!==void 0&&l>0){a===!1&&(a=!0,t.Separator());let u=i(`militaryability_${o}`),f=i(`militaryability_${o}_description`);t.Information(`<span class="MilitaryAbility">${u}</span> &mdash; ${f}`)}}}function $n(e,t,r,n){g(s.battleResults.container,"Victory",e),g(s.battleResults.container,"Visible",!0),g(s.battleResults.container,"NoCasualties",Object.keys(r).length==0),g(s.battleResults.container,"NoSpoils",Object.keys(n).length==0);let a=t?.name??i("ui_defensebattle_title"),o=i(e?"ui_battleresult_victory":"ui_battleresult_defeat").format(a);s.battleResults.name.textContent=o,s.battleResults.casualties.innerHTML="",s.battleResults.spoils.innerHTML="",wt(s.battleResults.casualties,r,!1),Xr(s.battleResults.spoils,n),e?x(s.battleResults.name,"left",l=>{l.Header(o),l.Lore(i("ui_battleresult_victory_lore"))}):x(s.battleResults.name,"left",l=>{l.Header(o),l.Lore(i("ui_battleresult_defeat_lore"))})}function Un(){let e=b("#PlayerStandingArmy");if(e===null)return;let t=b("#ArmyDeploymentUnits");if(t===null)return;x(e,"left",n=>{n.Header(i("tt_standingarmy_header")),n.Lore(i("tt_standingarmy_lore")),n.Separator(),n.Information(i("tt_standingarmy_description"))});for(let n=0;n<J;++n){let a=B(s.deployMilitary.warTargetsContainer,"WarTarget");if(a===null)throw new Error("Failed to create war target template instance");V(a);let o={container:a,name:y(a,".CityName"),defenders:y(a,".ArmyList"),population:y(a,".CityPopulation")};s.deployMilitary.warTargets.push(o),x(o.container,"left",l=>{l.Header(i("tt_wartarget_assault")),l.Lore(i("tt_wartarget_lore")),l.Separator();let u=it(s.gameState,s.gameState.warTargets[n]);u===!0?l.Information(i("tt_wartarget_assault_description")):l.Information(i(`tt_wartarget_cannotassault_${u}`),"Prerequisite")}),o.container.addEventListener("click",()=>{yr(s.gameState,n)})}x(s.invaders.container,"left",n=>{n.Header(i("tt_invaders_header")),n.Lore(i("tt_invaders_lore")),n.Separator(),n.Information(i("tt_invaders_description")),n.Information(i("tt_invaders_prestige"))}),x(s.invaderAnger.container,"left",n=>{n.Header(i("tt_invaderanger_header")),n.Lore(i("tt_invaderanger_lore")),n.Separator(),n.Information(i("tt_invaderanger_description")),n.Separator(),n.InformationLeftRight(i("tt_invaderanger_chance"),`${(st(s.gameState)*100).toFixed(1)}%`)}),V(s.activeBattle.container),V(s.battleResults.container);for(let[n,a]of Object.entries(G)){{let o=B(e,"StandingArmyUnitTemplate",`MilitaryUnit${n.toUpperFirst()}`);if(o===null)throw new Error("Failed to create military unit template instance");s.militaryUnits[n]={slot:o,count:y(o,".Count")},y(o,".Portrait").style.backgroundImage=`url("images/military/${a.icon}.svg")`,x(o,"left",l=>Pe(n,l))}{let o=B(t,"ArmyDeploymentWidgetTemplate",`DeployUnit${n.toUpperFirst()}`);if(o===null)throw new Error("Failed to create military deployment template instance");let l={slot:o,count:y(o,".Count"),assignUp:y(o,".Up"),assignDown:y(o,".Down")};s.deployMilitary.units[n]=l,y(o,".Portrait").style.backgroundImage=`url("images/military/${a.icon}.svg")`,x(o,"left",u=>{Pe(n,u),u.Separator(),u.Information(i("tt_deploy_allocation_help"))}),l.assignUp.addEventListener("click",u=>{u.shiftKey?s.gameState.persistent.militaryDeployment[n]=s.gameState.persistent.military[n]??0:u.ctrlKey?s.gameState.persistent.militaryDeployment[n]=(s.gameState.persistent.militaryDeployment[n]??0)+5:s.gameState.persistent.militaryDeployment[n]=(s.gameState.persistent.militaryDeployment[n]??0)+1,ae()}),l.assignDown.addEventListener("click",u=>{u.shiftKey?delete s.gameState.persistent.militaryDeployment[n]:u.ctrlKey?s.gameState.persistent.militaryDeployment[n]=Math.max(0,(s.gameState.persistent.militaryDeployment[n]??0)-5):s.gameState.persistent.militaryDeployment[n]=Math.max(0,(s.gameState.persistent.militaryDeployment[n]??0)-1),ae()})}}let r=y(s.activeBattle.container,".Frontline");for(let n=0;n<Y;++n){let a=B(r,"BattleFileTemplate");if(a===null)throw new Error("Failed to create battle file template instance");s.activeBattle.frontlines.push({container:a,playerBack:y(a,".AttackerBack"),playerFront:y(a,".AttackerFront"),interaction:y(a,".Interaction"),enemyFront:y(a,".DefenderFront"),enemyBack:y(a,".DefenderBack")})}x(s.activeBattle.retreat,"left",n=>{n.Header(i("tt_battle_retreat")),n.Lore(i("tt_battle_retreat_lore")),n.Separator(),n.Information(i("tt_battle_retreat_description"))}),s.activeBattle.retreat.addEventListener("click",()=>br(s.gameState)),bt(),x(s.playerFortStrength.container,"left",n=>{n.Header(i("tt_fortstrength_header")),n.Lore(i("tt_fortstrength_lore")),n.Separator(),n.Information(i("tt_fortstrength_description")),n.Separator(),n.Information(i("modifier_fortifications_repair").format(at(s.gameState)))}),x(s.deployMilitary.container,"left",n=>{n.Header(i("tt_deploy_header")),n.Separator(),n.Information(i("tt_deploy_description"))}),y("#ArmyDeployAll").addEventListener("click",n=>{for(let a of Object.keys(G))s.gameState.persistent.militaryDeployment[a]=s.gameState.persistent.military[a]??0;ae()}),y("#ArmyDeployNone").addEventListener("click",n=>{for(let a of Object.keys(G))delete s.gameState.persistent.militaryDeployment[a];ae()}),ae()}function On(){let e=b("#SettingsButton"),t=b("#SettingsPopup"),r=b("#SettingsPopup_Close");if(e===null||t===null||r===null){console.log("Failed to find HTML elements");return}x(e,"left",c=>{c.Header(i("ui_settings")),c.Information(i("ui_settings_description"))}),e.addEventListener("click",()=>t.classList.add("Visible")),t.addEventListener("click",c=>{c.target===t&&t.classList.remove("Visible")}),r&&r.addEventListener("click",()=>t.classList.remove("Visible"));let n=b("#SettingsPopup_SaveGame");b("#SettingsPopup_Import").addEventListener("click",()=>{let c=n.value;c!==null&&c.length>0&&lr(c)}),b("#SettingsPopup_Export").addEventListener("click",()=>{let c=Je(s.gameState.persistent);n.textContent=c,n.setSelectionRange(0,c.length),n.focus()}),b("#SettingsPopup_SoftReset").addEventListener("click",()=>{ot(s.gameState)});let u=b("#SettingsPopup_HardReset");u.disabled=!0,u.addEventListener("click",()=>{ur()});let f=b("#SettingsPopup_HardResetEnable");f.addEventListener("change",()=>{u.disabled=f.value!=="HARD RESET"}),V(t)}function V(e){e.textContent?.charAt(0)=="$"&&(e.innerHTML=i(e.textContent.substr(1)));for(let t of e.children)t instanceof HTMLElement&&V(t)}function Qn(){let e=s.gameState;for(let t of S){let r=s.currencies[t];if(r!==void 0){let n=sr(e,t),a=rt(t);g(r.parent,"Visible",n),n&&(ie(t)?(r.current.textContent=I(e.persistent.wallet[t]),a&&(r.income.textContent="("+te(e.income[t]??0)+")")):a&&(r.income.textContent=te(e.income[t]??0)))}}}function Qr(){let e=s.gameState;g(document.body,"MilitaryEnabled",e.enabledFeatures.military===!0),e.persistent.techTarget!==void 0&&_t(e.persistent.techTarget),s.idleWorkers.textContent=e.persistent.activeWorkers.idle.toString(),g(s.idleWorkers,"Visible",e.enabledFeatures.workers===!0),Qn(),Ur(),Vr(),Nr()}var Zr=class{constructor(t,r){this.builder=r,this.element=t,this.innerElement=t.getElementsByTagName("div")[0],this.Refresh()}Refresh(){this.innerElement.textContent="",this.builder(this)}Header(t){this.innerElement.appendChild(document.createElement("h1")).textContent=t}Lore(t){let r=this.innerElement.appendChild(document.createElement("p"));r.classList.add("Lore"),r.innerHTML=t}Separator(){this.innerElement.appendChild(document.createElement("hr"))}Information(t,r){let n=this.innerElement.appendChild(document.createElement("p"));n.classList.add("Information"),r!==void 0&&n.classList.add(r),n.innerHTML=t}InformationLeftRight(t,r,n){let a=this.innerElement.appendChild(document.createElement("div"));a.classList.add("InformationLeftRight"),n!==void 0&&a.classList.add(n);let o=a.appendChild(document.createElement("p"));o.className="Information Left",o.innerHTML=t;let l=a.appendChild(document.createElement("p"));l.className="Information Right",l.innerHTML=r}ShowOn(t,r){let n=r=="left"?0:r=="right"?1:.5,a=r=="top"?0:r=="bottom"?1:.5;this.element.classList.add("Visible");let o=t.getBoundingClientRect(),l=this.element.getBoundingClientRect(),u=o.x-l.width+(l.width+o.width)*n,f=o.y-l.height+(l.height+o.height)*a;this.element.style.left=Math.min(window.innerWidth-l.width,Math.max(0,u))+"px",this.element.style.top=Math.min(window.innerHeight-l.height,Math.max(0,f))+"px"}};function x(e,t,r){Jr(e);let n=a=>{Yn(e,t,r),a.stopPropagation()};s.tooltipHandlers.set(e,n),e.addEventListener("mouseover",n),e.addEventListener("mouseout",en)}function Jr(e){let t=s.tooltipHandlers.get(e);t&&(e.removeEventListener("mouseover",t),e.removeEventListener("mouseout",en))}function Yn(e,t,r){let n=b("#Tooltip");n!==null&&(s.activeTooltip=new Zr(n,r),s.activeTooltip.ShowOn(e,t))}function Ae(){s.activeTooltip?.Refresh()}function en(){b("#Tooltip")?.classList.remove("Visible"),s.activeTooltip=void 0}function jn(){let e=y("#FeatsContainer");for(let t of Ce){let r=B(e,"FeatTemplate");if(r===null)throw new Error("Failed to create feat panel from template");s.records.feats[t]=r;let n=y(r,".FeatName"),a=y(r,".FeatDescription");n.innerText=i(`feat_${t}`),a.innerText=i(`feat_${t}_description`)}vt()}function vt(){g(document.body,"RecordsEnabled",s.gameState.enabledFeatures.records===!0);for(let[e,t]of Object.entries(s.records.feats))g(t,"Achieved",s.gameState.persistent.feats[e]!==void 0)}function zn(){b("#MessagePopup_Close")?.addEventListener("click",()=>{if(b("#MessagePopup")?.classList.remove("Visible"),s.messageCallback){let e=s.messageCallback;s.messageCallback=void 0,e()}})}function Jn(e,t,r,n){b("#MessagePopup")?.classList.add("Visible");let a=b("#MessageHeader");a!==null&&(a.textContent=e);let o=b("#MessageText");o!==null&&(o.innerHTML=t);let l=b("#MessagePopup_Close");l!==null&&(l.textContent=r),s.messageCallback=n}function Nn(e,t){Jn(i(`event_${e}_header`),i(`event_${e}_text`),i(`event_${e}_button`),t)}function or(){return s.messageCallback!==void 0}function Ve(e){g(b("#SaveIndicator"),"Visible",e)}function Vn(e){s.prestigePopup.classList.add("Visible"),s.prestigeMessage.textContent=i(e)}String.prototype.format||(String.prototype.format=function(...e){return this.replace(/{(\d+)}/g,(t,r)=>{let n=parseInt(r);return e[n]!==void 0?e[n].toString():t})},String.prototype.toUpperFirst=function(){return this.length==0?this:this.charAt(0).toUpperCase()+this.substr(1)});function b(e,t){return typeof e=="string"?document.querySelector(e):t!==void 0?e.querySelector(t):null}function y(e,t){if(typeof e=="string"){let r=b(e);if(r===null)throw new Error(`Failed to find required element with selector ${e}`);return r}else if(t!==void 0){let r=b(e,t);if(r===null)throw new Error(`Failed to find required element with selector ${t} on ${e}`);return r}throw new Error("Bad $Required")}function B(e,t,r){let a=document.getElementById(t)?.content?.firstElementChild;if(a){let o=e.appendChild(a.cloneNode(!0));return r!==void 0&&(o.id=r),o}return null}function g(e,t,r){r?e?.classList.add(t):e?.classList.remove(t)}function Xe(e,t){window.setInterval(t,e)}function Ze(e){return e<15?Math.ceil(e/2)*2:e<50?Math.ceil(e/5)*5:e<100?Math.ceil(e/10)*10:Math.ceil(e/100)*100}function I(e){return e>=1e9?(e/1e9).toPrecision(3)+i("suffix_billion"):e>=1e6?(e/1e6).toPrecision(3)+i("suffix_million"):e>=1e3?(e/1e3).toPrecision(3)+i("suffix_thousand"):Number.isInteger(e)?e.toFixed(0):e<.1?e.toFixed(2):e.toFixed(1)}function re(e){e=Math.floor(e);let t=e%60,r=Math.floor(e%3600/60),n=Math.floor(e/3600),a=[];return n>0&&a.push(n.toString()+i("suffix_hours")),r>0&&a.push(r.toString()+i("suffix_minutes")),t>0&&a.push(t.toString()+i("suffix_seconds")),a.length==0?i("generic_verysoon"):a.join(" ")}function te(e){let t="";return e>=1e6?t=(e/1e6).toPrecision(3)+i("suffix_million"):e>=1e3?t=(e/1e3).toPrecision(3)+i("suffix_thousand"):t=e.toFixed(1),t+=i("suffix_persecond"),e>0?"+"+t:t}function D(e,t){let r={};for(let n of e)r[n]=t;return r}function M(e,t){return Object.prototype.hasOwnProperty.call(e,t)}var Kn={M:1e3,DM:900,D:500,CD:400,C:100,XC:90,X:10,IX:9,V:5,IV:4,I:1};function Ie(e){let t="";for(let[r,n]of Object.entries(Kn)){let a=Math.floor(e/n);t+=r.repeat(a),e-=a*n}return t}function O(e){return e=Math.abs(Math.floor(e)%2147483647),function(t,r){return e=Math.floor(e*48271)%2147483647,t!==void 0&&r!==void 0?t+(r-t)*e/2147483648:(t??1)*e/2147483648}}var R=class{constructor(){this._listeners=[]}listen(t){this._listeners.push(t)}invoke(...t){for(let r of this._listeners)r(...t)}};window.addEventListener("DOMContentLoaded",()=>{Pr()});window.addEventListener("load",()=>{b("#LoadingScreen")?.classList.add("Hidden")});})();
